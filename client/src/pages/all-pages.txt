===== admin-attendance.tsx =====
import { useState, useMemo } from "react";
import { useQuery } from "@tanstack/react-query";
import { format } from "date-fns";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { 
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { 
  Loader2, 
  Calendar, 
  Search, 
  ChevronLeft, 
  ChevronRight, 
  Clock,
  Briefcase,
  CalendarCheck,
  History,
  Filter,
  Moon,
  Flame
} from "lucide-react";
import { BentoCard } from "@/components/custom/bento-card";
import { useAuth } from "@/hooks/use-auth";

// Types matching the API response
interface AttendanceRecord {
  id: string;
  userId: string;
  date: number; 
  timeIn: number; 
  timeOut: number | null; 
  status: string; 
  totalBreakMinutes: number;
  totalWorkMinutes: number | null;
  notes: string | null;
}

export default function AdminAttendance() {
  // Auth Context
  const { user } = useAuth();
  
  // State Variables
  const [currentDate, setCurrentDate] = useState(new Date());
  const [searchTerm, setSearchTerm] = useState("");
  const [selectedPeriod, setSelectedPeriod] = useState<"1" | "2">("1"); // "1" = 1st Half, "2" = 2nd Half
  const [selectedEmployeeId, setSelectedEmployeeId] = useState<string>("all");
  // Date Range Calculation
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  // Compute start and end dates based on selected period
  const { startDate, endDate } = useMemo(() => {
    let start, end;
    if (selectedPeriod === "1") {
        start = new Date(year, month, 1);
        end = new Date(year, month, 15, 23, 59, 59);
    } else {
        start = new Date(year, month, 16);
        end = new Date(year, month + 1, 0, 23, 59, 59); // Last day of month
    }
    return { startDate: start.toISOString(), endDate: end.toISOString() };
  }, [year, month, selectedPeriod]);

  // Get Team Members
  const { data: teamMembers } = useQuery({ queryKey: ["/api/team"] });

  // Get Attendance Records based on date range
  const { data: records, isLoading } = useQuery<AttendanceRecord[]>({
    queryKey: ["/api/attendance/all", startDate, endDate],
    queryFn: async () => {
      const params = new URLSearchParams({ startDate, endDate });
      const res = await fetch(`/api/attendance/all?${params}`);
      if (!res.ok) throw new Error("Failed to fetch records");
      return res.json();
    },
  });

  // Calculate unique employees present in the current records to shorten the dropdown list
  const employeeOptions = useMemo(() => {
    if (!teamMembers || !records) return [];
    
    // Get distinct user IDs from the loaded records
    const activeUserIds = new Set(records.map(r => r.userId));
    
    // Filter team members to only those present in the records
    return teamMembers
        .filter((member: any) => activeUserIds.has(member.id))
        .sort((a: any, b: any) => a.firstName.localeCompare(b.firstName));
  }, [teamMembers, records]);

  // Helper to get employee name by ID
  const getEmployeeName = (id: string) => {
    const emp = teamMembers?.find((m: any) => m.id === id);
    return emp ? `${emp.firstName} ${emp.lastName}` : "Unknown User";
  };

  // Navigation Handlers
  const prevMonth = () => setCurrentDate(new Date(year, month - 1, 1));
  const nextMonth = () => setCurrentDate(new Date(year, month + 1, 1));
  const resetToToday = () => {
      setCurrentDate(new Date());
      setSelectedPeriod(new Date().getDate() <= 15 ? "1" : "2");
  };

  // Formatting Helpers
  const formatTime = (ts: number) => format(new Date(ts), "h:mm a");
  const formatDate = (ts: number) => format(new Date(ts), "MMM d, yyyy");
  
  // Helper for Duration Formatting
  const formatDuration = (minutes: number | null) => {
    if (minutes === null || minutes === undefined) return "-";
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;
    return h > 0 ? `${h}h ${m}m` : `${m}m`;
  };

  // Helper for Night Diff
  const getNightDiffHours = (timeIn: number, timeOut: number | null) => {
    if (!timeOut) return 0;
    let start = new Date(timeIn);
    let end = new Date(timeOut);
    let ndHours = 0;
    let current = new Date(start);
    current.setMinutes(0, 0, 0); 
    if (current.getTime() < start.getTime()) current.setHours(current.getHours() + 1);

    while (current.getTime() < end.getTime()) {
        const h = current.getHours();
        // Night Diff: 10PM (22) to 6AM (6)
        if (h >= 22 || h < 6) ndHours += 1;
        current.setHours(current.getHours() + 1);
    }
    return ndHours;
  };

  // Filter Logic
  const filteredRecords = records?.filter(r => {
    if (selectedEmployeeId !== "all" && r.userId !== selectedEmployeeId) return false;
    if (!searchTerm) return true;
    const searchLower = searchTerm.toLowerCase();
    const name = getEmployeeName(r.userId).toLowerCase();
    const dateStr = formatDate(r.date).toLowerCase();
    return name.includes(searchLower) || dateStr.includes(searchLower);
  }).sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()) || []; 

  // Stats Calculation
  const stats = filteredRecords.reduce((acc, curr) => {
    const workMinutes = curr.totalWorkMinutes || 0;
    acc.totalMinutes += workMinutes;

    // Overtime: Hours exceeding 8 hours (480 mins)
    if (workMinutes > 480) {
        acc.otMinutes += (workMinutes - 480);
    }

    // Night Differential
    if (curr.timeOut) {
        acc.ndHours += getNightDiffHours(curr.timeIn, curr.timeOut);
    }

    return acc;
  }, { totalMinutes: 0, otMinutes: 0, ndHours: 0 });

  // Derived Stats
  const totalWorkHours = stats.totalMinutes / 60;
  const totalOTHours = stats.otMinutes / 60;
  const avgHours = filteredRecords.length > 0 ? (totalWorkHours / filteredRecords.length) : 0;
  const presentCount = new Set(filteredRecords.map(r => r.userId + r.date)).size;

  // Access Control: Only admins and managers allowed
  if (user?.role === 'employee') {
    return <div className="p-6 text-center">Access Denied</div>;
  }

  return (
    <div className="p-6 md:p-8 space-y-8">
      {/* Header Section */}
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-6">
        <div>
           <h1 className="text-3xl font-bold tracking-tight text-slate-900">Employee Attendance</h1>
           <p className="text-slate-500 mt-1 text-sm">
             Monitor workforce attendance logs.
           </p>
        </div>
        
        {/* Date & Period Controls */}
        <div className="flex flex-col sm:flex-row gap-3">
             {/* Period Selector */}
            <div className="flex items-center bg-white border border-slate-200 rounded-lg shadow-sm px-1 h-10">
                 <button 
                    onClick={() => setSelectedPeriod("1")}
                    className={`text-xs font-medium px-3 py-1.5 rounded-md transition-all ${selectedPeriod === "1" ? "bg-slate-100 text-slate-900" : "text-slate-500 hover:text-slate-700"}`}
                 >
                    1st Half (1-15)
                 </button>
                 <div className="w-px h-4 bg-slate-200 mx-1"></div>
                 <button 
                    onClick={() => setSelectedPeriod("2")}
                    className={`text-xs font-medium px-3 py-1.5 rounded-md transition-all ${selectedPeriod === "2" ? "bg-slate-100 text-slate-900" : "text-slate-500 hover:text-slate-700"}`}
                 >
                    2nd Half (16-End)
                 </button>
            </div>

            {/* Month Navigator */}
            <div className="flex items-center bg-white/80 backdrop-blur-sm border border-slate-200/60 p-1 rounded-full shadow-sm h-10">
              <Button variant="ghost" size="icon" onClick={prevMonth} className="rounded-full h-8 w-8 hover:bg-slate-100 text-slate-500">
                <ChevronLeft className="h-4 w-4" />
              </Button>
              <div className="flex items-center gap-2 px-4 min-w-[140px] justify-center font-semibold text-slate-700 text-sm">
                <Calendar className="h-4 w-4 text-slate-400" />
                {format(currentDate, "MMMM yyyy")}
              </div>
              <Button variant="ghost" size="icon" onClick={nextMonth} className="rounded-full h-8 w-8 hover:bg-slate-100 text-slate-500">
                <ChevronRight className="h-4 w-4" />
              </Button>
            </div>
        </div>
      </div>

      {/* Bento Stats Grid */}
      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
         <BentoCard 
            title="Total Hours" 
            value={`${totalWorkHours.toFixed(1)}h`} 
            icon={Briefcase} 
            variant="default"
            testIdPrefix="stat-hours"
         />
         <BentoCard 
            title="Overtime" 
            value={`${totalOTHours.toFixed(1)}h`} 
            icon={Flame} 
            variant="rose"
            testIdPrefix="stat-ot"
         />
         <BentoCard 
            title="Night Diff" 
            value={`${stats.ndHours.toFixed(1)}h`} 
            icon={Moon} 
            variant="indigo"
            testIdPrefix="stat-nd"
         />
         <BentoCard 
            title="Avg / Shift" 
            value={`${avgHours.toFixed(1)}h`} 
            icon={Clock} 
            variant="emerald"
            testIdPrefix="stat-avg"
         />
         <BentoCard 
            title="Days Present" 
            value={presentCount} 
            icon={CalendarCheck} 
            variant="amber"
            testIdPrefix="stat-days"
         />
      </div>

      {/* Search & Filter Bar */}
      <div className="flex flex-col lg:flex-row items-center gap-4">
        {/* Employee Dropdown */}
        <div className="w-full lg:w-64">
             <Select value={selectedEmployeeId} onValueChange={setSelectedEmployeeId}>
                <SelectTrigger className="h-11 rounded-xl bg-white/60 backdrop-blur-sm border-slate-200/60">
                    <div className="flex items-center gap-2 text-slate-600">
                        <Filter className="w-4 h-4" />
                        <SelectValue placeholder="Filter Employee" />
                    </div>
                </SelectTrigger>
                <SelectContent>
                    <SelectItem value="all">All Employees</SelectItem>
                    {employeeOptions.map((member: any) => (
                        <SelectItem key={member.id} value={member.id}>
                            {member.firstName} {member.lastName}
                        </SelectItem>
                    ))}
                </SelectContent>
             </Select>
        </div>

        <div className="relative flex-1 w-full">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400" />
          <Input
            placeholder="Search records..."
            className="pl-10 h-11 rounded-xl bg-white/60 backdrop-blur-sm border-slate-200/60 focus:bg-white focus:ring-primary/20 transition-all"
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
          />
        </div>
        <Button 
            variant="outline" 
            onClick={resetToToday} 
            className="rounded-xl border-slate-200/60 bg-white/60 backdrop-blur-sm hover:bg-white w-full sm:w-auto h-11"
        >
            Jump to Today
        </Button>
      </div>

      {/* Main Table Card */}
      <Card className="glass-card">
        <CardContent className="p-0">
          <div className="overflow-x-auto">
            <table className="w-full text-sm text-left">
              <thead className="bg-white/50 border-b border-slate-200/60">
                <tr>
                  <th className="px-6 py-4 font-semibold text-slate-500 uppercase tracking-wider text-xs">Employee</th>
                  <th className="px-6 py-4 font-semibold text-slate-500 uppercase tracking-wider text-xs">Date</th>
                  <th className="px-6 py-4 font-semibold text-slate-500 uppercase tracking-wider text-xs">Time In</th>
                  <th className="px-6 py-4 font-semibold text-slate-500 uppercase tracking-wider text-xs">Time Out</th>
                  <th className="px-6 py-4 font-semibold text-slate-500 uppercase tracking-wider text-xs">Break</th>
                  <th className="px-6 py-4 font-semibold text-slate-500 uppercase tracking-wider text-xs text-right">OT</th>
                  <th className="px-6 py-4 font-semibold text-slate-500 uppercase tracking-wider text-xs text-right">ND</th>
                  <th className="px-6 py-4 font-semibold text-slate-500 uppercase tracking-wider text-xs text-right">Duration</th>
                  <th className="px-6 py-4 font-semibold text-slate-500 uppercase tracking-wider text-xs text-center">Status</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-100">
                {isLoading ? (
                  <tr>
                    <td colSpan={9} className="px-6 py-12 text-center text-slate-500">
                      <div className="flex flex-col items-center justify-center gap-2">
                          <Loader2 className="h-6 w-6 animate-spin text-primary" />
                          <p>Loading logs...</p>
                      </div>
                    </td>
                  </tr>
                ) : filteredRecords.length === 0 ? (
                  <tr>
                    <td colSpan={9} className="px-6 py-16 text-center text-slate-500">
                      <div className="flex flex-col items-center justify-center gap-3">
                          <div className="h-12 w-12 bg-slate-100 rounded-full flex items-center justify-center">
                             <Calendar className="h-6 w-6 text-slate-400" />
                          </div>
                          <p>No attendance records found for this period.</p>
                      </div>
                    </td>
                  </tr>
                ) : (
                  filteredRecords.map((record) => {
                    // Calculate per-row stats
                    const otHours = Math.max(0, ((record.totalWorkMinutes || 0) - 480) / 60);
                    const ndHours = getNightDiffHours(record.timeIn, record.timeOut);

                    return (
                      <tr key={record.id} className="hover:bg-white/60 transition-colors group">
                        <td className="px-6 py-4 whitespace-nowrap font-medium text-slate-900">
                          {getEmployeeName(record.userId)}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-slate-600">
                          {formatDate(record.date)}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-slate-600 font-mono text-xs">
                          {formatTime(record.timeIn)}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-slate-600 font-mono text-xs">
                          {record.timeOut ? formatTime(record.timeOut) : <span className="text-slate-400 italic">--</span>}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-slate-600">
                          {formatDuration(record.totalBreakMinutes)}
                        </td>
                        {/* OT Column */}
                        <td className="px-6 py-4 whitespace-nowrap text-right font-mono text-xs">
                           {otHours > 0 ? (
                             <span className="text-rose-600 font-bold bg-rose-50 px-1.5 py-0.5 rounded border border-rose-100">
                               {otHours.toFixed(1)}h
                             </span>
                           ) : <span className="text-slate-300">-</span>}
                        </td>
                        {/* ND Column */}
                        <td className="px-6 py-4 whitespace-nowrap text-right font-mono text-xs">
                           {ndHours > 0 ? (
                             <span className="text-indigo-600 font-bold bg-indigo-50 px-1.5 py-0.5 rounded border border-indigo-100">
                               {ndHours.toFixed(1)}h
                             </span>
                           ) : <span className="text-slate-300">-</span>}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-right font-medium text-slate-900">
                          {record.totalWorkMinutes !== null ? formatDuration(record.totalWorkMinutes) : <span className="text-slate-400 italic">--</span>}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-center">
                            <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold capitalize border
                              ${record.status === 'clocked_in' ? 'bg-emerald-50 text-emerald-700 border-emerald-100' : 
                                record.status === 'on_break' ? 'bg-amber-50 text-amber-700 border-amber-100' : 
                                record.status === 'clocked_out' ? 'bg-slate-100 text-slate-700 border-slate-200' : 
                                'bg-rose-50 text-rose-700 border-rose-100'}`}>
                             {record.status.replace('_', ' ')}
                            </span>
                        </td>
                      </tr>
                    );
                  })
                )}
              </tbody>
            </table>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}


===== announcements.tsx =====
import { useState } from "react";
import { useAuth } from "@/hooks/use-auth";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { apiRequest } from "@/lib/queryClient";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Switch } from "@/components/ui/switch";
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { insertAnnouncementSchema } from "@shared/schema";
import { z } from "zod";
import { Megaphone, Plus, Filter, Bell, AlertCircle, Clock, Eye } from "lucide-react";
import type { Announcement } from "@shared/schema";
import { canManageAnnouncements } from "@/utils/permissions";
import { toast } from "sonner";

// Refactored Components
import { BentoCard } from "@/components/custom/bento-card";
import { AnnouncementFeedItem } from "@/components/custom/announcement-feed-card";

const announcementFormSchema = insertAnnouncementSchema.extend({
  targetDepartments: z.array(z.string()).optional(),
}).omit({ authorId: true });

type AnnouncementForm = z.infer<typeof announcementFormSchema>;

export default function Announcements() {
  const { user } = useAuth();
  const queryClient = useQueryClient();
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const [editingAnnouncement, setEditingAnnouncement] = useState<Announcement | null>(null);
  const [filterType, setFilterType] = useState<string>("all");
  const [filterStatus, setFilterStatus] = useState<string>("active");

  const canManage = canManageAnnouncements(user);

  const { data: announcements, isLoading } = useQuery({
    queryKey: ["/api/announcements"],
  });

  const form = useForm<AnnouncementForm>({
    resolver: zodResolver(announcementFormSchema),
    defaultValues: {
      title: "",
      content: "",
      type: "general",
      targetDepartments: [],
      isActive: true,
    },
  });

  const createAnnouncementMutation = useMutation({
    mutationFn: async (data: AnnouncementForm) => {
      const res = await apiRequest("POST", "/api/announcements", data);
      return await res.json();
    },
    onSuccess: () => {
      toast.success("Announcement created", {
        description: "Your announcement has been published successfully."
      });
      queryClient.invalidateQueries({ queryKey: ["/api/announcements"] });
      setIsDialogOpen(false);
      form.reset();
      setEditingAnnouncement(null);
    },
    onError: (error: Error) => {
      toast.error("Creation failed",{ description: error.message });
    },
  });

  const updateAnnouncementMutation = useMutation({
    mutationFn: async ({ id, data }: { id: string; data: Partial<Announcement> }) => {
      const res = await fetch(`/api/announcements/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });
      return await res.json();
    },
    onSuccess: () => {
      toast.success( "Announcement updated",{ description: "The announcement has been updated successfully." });
      queryClient.invalidateQueries({ queryKey: ["/api/announcements"] });
    },
    onError: (error: Error) => {
      toast.error("Update failed",{ description: error.message });
    },
  });

  const onSubmit = (data: AnnouncementForm) => {
    if (editingAnnouncement) {
      updateAnnouncementMutation.mutate({ id: editingAnnouncement.id, data });
    } else {
      createAnnouncementMutation.mutate(data);
    }
  };

  const handleEdit = (announcement: Announcement) => {
    setEditingAnnouncement(announcement);
    form.reset({
      title: announcement.title,
      content: announcement.content,
      type: announcement.type || "general",
      targetDepartments: announcement.targetDepartments as string[] || [],
      isActive: announcement.isActive,
    });
    setIsDialogOpen(true);
  };

  const handleToggleActive = (announcement: Announcement) => {
    updateAnnouncementMutation.mutate({ id: announcement.id, data: { isActive: !announcement.isActive } });
  };

  const filteredAnnouncements = announcements?.filter((announcement: Announcement) => {
    const typeMatch = filterType === "all" || announcement.type === filterType;
    const statusMatch = (filterStatus === "active" && announcement.isActive) ||
      (filterStatus === "inactive" && !announcement.isActive) || 
      filterStatus === "all";
    return typeMatch && statusMatch;
  }) || [];

  const getAnnouncementStats = () => {
    if (!announcements) return { total: 0, active: 0, urgent: 0, thisWeek: 0 };
    const total = announcements.length;
    const active = announcements.filter((a: Announcement) => a.isActive).length;
    const urgent = announcements.filter((a: Announcement) => a.type === "urgent" && a.isActive).length;
    const oneWeekAgo = new Date();
    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
    const thisWeek = announcements.filter((a: Announcement) => new Date(a.createdAt!) > oneWeekAgo).length;
    return { total, active, urgent, thisWeek };
  };

  const stats = getAnnouncementStats();

  const resetForm = () => {
    setEditingAnnouncement(null);
    form.reset({ title: "", content: "", type: "general", targetDepartments: [], isActive: true });
  };

  return (
    <div className="p-6 space-y-8">
      {/* Header Section */}
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h1 className="text-3xl font-bold tracking-tight text-slate-900" data-testid="page-title">Announcements</h1>
          <p className="text-slate-500 mt-1 text-sm">Manage company-wide communications and updates</p>
        </div>
        {canManage && (
        <Dialog open={isDialogOpen} onOpenChange={(open) => { setIsDialogOpen(open); if (!open) resetForm(); }}>
          <DialogTrigger asChild>
            <Button className="bg-slate-900 hover:bg-slate-800 text-white shadow-lg shadow-slate-900/20 rounded-full px-6" data-testid="button-create-announcement">
              <Plus className="w-4 h-4 mr-2" /> New Announcement
            </Button>
          </DialogTrigger>
          <DialogContent className="max-w-2xl rounded-2xl">
            <DialogHeader>
              <DialogTitle className="text-xl">{editingAnnouncement ? "Edit Announcement" : "Create New Announcement"}</DialogTitle>
              <DialogDescription>{editingAnnouncement ? "Update your announcement details below" : "Share important information with your team"}</DialogDescription>
            </DialogHeader>
            <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-5 mt-4">
              <div className="space-y-2">
                <Label htmlFor="title" className="text-slate-600">Title</Label>
                <Input id="title" {...form.register("title")} placeholder="e.g., Annual Company Retreat" className="rounded-xl border-slate-200" />
                {form.formState.errors.title && <p className="text-sm text-red-500">{form.formState.errors.title.message}</p>}
              </div>
              <div className="space-y-2">
                <Label htmlFor="content" className="text-slate-600">Content</Label>
                <Textarea id="content" {...form.register("content")} placeholder="Write your announcement here..." rows={5} className="rounded-xl border-slate-200 resize-none" />
                {form.formState.errors.content && <p className="text-sm text-red-500">{form.formState.errors.content.message}</p>}
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div className="space-y-2">
                  <Label htmlFor="type" className="text-slate-600">Type</Label>
                  <Select onValueChange={(value) => form.setValue("type", value)} defaultValue={form.getValues("type")}>
                    <SelectTrigger className="rounded-xl border-slate-200"><SelectValue placeholder="Select type" /></SelectTrigger>
                    <SelectContent className="rounded-xl">
                      <SelectItem value="general">General</SelectItem>
                      <SelectItem value="urgent">Urgent</SelectItem>
                      <SelectItem value="holiday">Holiday</SelectItem>
                      <SelectItem value="policy">Policy Update</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                <div className="flex items-center space-x-3 p-4 bg-slate-50 rounded-xl border border-slate-100 mt-auto">
                  <Switch id="isActive" checked={form.watch("isActive")} onCheckedChange={(checked) => form.setValue("isActive", checked)} />
                  <div className="space-y-0.5">
                    <Label htmlFor="isActive" className="text-base">Active Status</Label>
                    <p className="text-xs text-slate-500">Visible to employees immediately</p>
                  </div>
                </div>
              </div>
              <div className="flex justify-end space-x-3 pt-4">
                <Button type="button" variant="outline" onClick={() => setIsDialogOpen(false)} className="rounded-full border-slate-200 hover:bg-slate-50">Cancel</Button>
                <Button type="submit" disabled={createAnnouncementMutation.isPending || updateAnnouncementMutation.isPending} className="rounded-full bg-slate-900 hover:bg-slate-800">
                  {(createAnnouncementMutation.isPending || updateAnnouncementMutation.isPending) ? "Saving..." : editingAnnouncement ? "Update Announcement" : "Create Announcement"}
                </Button>
              </div>
            </form>
          </DialogContent>
        </Dialog>
        )}
      </div>

      {/* Bento Grid Stats - Refactored to use Components */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <BentoCard title="Total Announcements" value={stats.total} icon={Bell} variant="default" testIdPrefix="total-announcements" />
        <BentoCard title="Active" value={stats.active} icon={Eye} variant="emerald" testIdPrefix="active-announcements" />
        <BentoCard title="Urgent" value={stats.urgent} icon={AlertCircle} variant="rose" testIdPrefix="urgent-announcements" />
        <BentoCard title="This Week" value={stats.thisWeek} icon={Clock} variant="amber" testIdPrefix="weekly-announcements" />
      </div>

      {/* Main Content Area */}
      <Card className="glass-card">
        <CardHeader className="px-0 pt-0 pb-6">
          <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 bg-white/80 backdrop-blur-md p-4 rounded-2xl border border-slate-200/60 shadow-sm">
            <div className="flex items-center gap-3">
              <div className="h-10 w-10 bg-blue-50 rounded-xl flex items-center justify-center border border-blue-100">
                 <Megaphone className="w-5 h-5 text-blue-600" />
              </div>
              <div>
                <CardTitle className="text-base font-semibold text-slate-800">Feed</CardTitle>
                <CardDescription className="text-xs">All company updates</CardDescription>
              </div>
            </div>
            <div className="flex items-center space-x-2">
              <div className="flex items-center px-3 py-2 bg-slate-50 rounded-lg border border-slate-200/60">
                <Filter className="w-4 h-4 text-slate-400 mr-2" />
                <Select value={filterType} onValueChange={setFilterType}>
                  <SelectTrigger className="w-[110px] h-8 border-none bg-transparent shadow-none focus:ring-0 text-xs font-medium">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">All Types</SelectItem>
                    <SelectItem value="general">General</SelectItem>
                    <SelectItem value="urgent">Urgent</SelectItem>
                    <SelectItem value="holiday">Holiday</SelectItem>
                    <SelectItem value="policy">Policy</SelectItem>
                  </SelectContent>
                </Select>
                <div className="w-px h-4 bg-slate-200 mx-2" />
                <Select value={filterStatus} onValueChange={setFilterStatus}>
                  <SelectTrigger className="w-[100px] h-8 border-none bg-transparent shadow-none focus:ring-0 text-xs font-medium">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">All Status</SelectItem>
                    <SelectItem value="active">Active</SelectItem>
                    <SelectItem value="inactive">Inactive</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>
          </div>
        </CardHeader>
        
        <CardContent className="px-0">
          {isLoading ? (
            <div className="text-center py-12">
              <p className="text-muted-foreground">Loading announcements...</p>
            </div>
          ) : filteredAnnouncements.length > 0 ? (
            <div className="grid grid-cols-1 gap-4">
              {filteredAnnouncements.map((announcement: Announcement) => (
                <AnnouncementFeedItem 
                  key={announcement.id} 
                  announcement={announcement} 
                  canManage={canManage} 
                  onEdit={handleEdit} 
                  onToggleActive={handleToggleActive} 
                />
              ))}
            </div>
          ) : (
            <div className="text-center py-20 bg-white/50 backdrop-blur-sm rounded-3xl border border-dashed border-slate-200">
              <div className="h-20 w-20 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm">
                 <Megaphone className="w-10 h-10 text-slate-300" />
              </div>
              <h3 className="text-lg font-semibold text-slate-900 mb-1">No announcements found</h3>
              <p className="text-slate-500 max-w-xs mx-auto mb-6">
                {announcements?.length === 0 
                  ? "Get started by creating your first company announcement." 
                  : "Try adjusting your filters to see more results."
                }
              </p>
              {canManage && announcements?.length === 0 && (
                 <Button onClick={() => setIsDialogOpen(true)} className="rounded-full">
                    <Plus className="w-4 h-4 mr-2" /> Create First Announcement
                 </Button>
              )}
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}


===== attendances.tsx =====
import { useState } from "react";
import { useQuery } from "@tanstack/react-query";
import { format } from "date-fns";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { 
  Loader2, 
  Calendar, 
  Search, 
  ChevronLeft, 
  ChevronRight, 
  Clock,
  Briefcase,
  CalendarCheck,
  History
} from "lucide-react";
import { BentoCard } from "@/components/custom/bento-card";

// Types matching the API response
interface AttendanceRecord {
  id: string;
  userId: string;
  date: number; 
  timeIn: number; 
  timeOut: number | null; 
  status: string; 
  totalBreakMinutes: number;
  totalWorkMinutes: number | null;
  notes: string | null;
}

export default function AttendanceHistory() {
  const [currentDate, setCurrentDate] = useState(new Date());
  const [searchTerm, setSearchTerm] = useState("");

  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  
  const startDate = new Date(year, month, 1).toISOString();
  const endDate = new Date(year, month + 1, 0, 23, 59, 59).toISOString();

  const { data: records, isLoading } = useQuery<AttendanceRecord[]>({
    queryKey: ["/api/attendance", startDate, endDate],
    queryFn: async () => {
      const params = new URLSearchParams({ startDate, endDate });
      const res = await fetch(`/api/attendance?${params}`);
      if (!res.ok) throw new Error("Failed to fetch records");
      return res.json();
    },
  });

  const prevMonth = () => setCurrentDate(new Date(year, month - 1, 1));
  const nextMonth = () => setCurrentDate(new Date(year, month + 1, 1));
  const resetToToday = () => setCurrentDate(new Date());

  const formatTime = (ts: number) => format(new Date(ts), "h:mm a");
  const formatDate = (ts: number) => format(new Date(ts), "MMM d, yyyy");
  const formatDay = (ts: number) => format(new Date(ts), "EEEE");
  
  const formatDuration = (minutes: number | null) => {
    if (minutes === null || minutes === undefined) return "-";
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;
    return h > 0 ? `${h}h ${m}m` : `${m}m`;
  };

  const filteredRecords = records?.filter(r => {
    if (!searchTerm) return true;
    const searchLower = searchTerm.toLowerCase();
    const dateStr = formatDate(r.date).toLowerCase();
    const notesStr = (r.notes || "").toLowerCase();
    return dateStr.includes(searchLower) || notesStr.includes(searchLower);
  }).sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()) || []; 

  const totalWorkHours = filteredRecords.reduce((acc, curr) => acc + (curr.totalWorkMinutes || 0), 0) / 60;
  const daysPresent = filteredRecords.length;

  return (
    <div className="p-6 md:p-8 space-y-8">
      {/* Header Section with Month Navigator */}
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-6">
        <div>
           <h1 className="text-3xl font-bold tracking-tight text-slate-900">Attendance Logs</h1>
           <p className="text-slate-500 mt-1 text-sm">
             Track your daily time-in, time-out, and break durations.
           </p>
        </div>
        
        {/* Glass Month Navigator */}
        <div className="flex items-center bg-white/80 backdrop-blur-sm border border-slate-200/60 p-1 rounded-full shadow-sm">
          <Button variant="ghost" size="icon" onClick={prevMonth} className="rounded-full hover:bg-slate-100 text-slate-500">
            <ChevronLeft className="h-4 w-4" />
          </Button>
          <div className="flex items-center gap-2 px-4 min-w-[160px] justify-center font-semibold text-slate-700 text-sm">
            <Calendar className="h-4 w-4 text-slate-400" />
            {format(currentDate, "MMMM yyyy")}
          </div>
          <Button variant="ghost" size="icon" onClick={nextMonth} className="rounded-full hover:bg-slate-100 text-slate-500">
            <ChevronRight className="h-4 w-4" />
          </Button>
        </div>
      </div>

      {/* Bento Stats Grid */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
         <BentoCard 
            title="Days Present" 
            value={daysPresent} 
            icon={CalendarCheck} 
            variant="default" // Blue-ish default
            testIdPrefix="stat-days"
         />
         <BentoCard 
            title="Total Hours" 
            value={`${totalWorkHours.toFixed(1)} hrs`} 
            icon={Briefcase} 
            variant="emerald"
            testIdPrefix="stat-hours"
         />
         <BentoCard 
            title="Status" 
            value={currentDate.getMonth() === new Date().getMonth() ? 'Active' : 'Historical'} 
            icon={History} 
            variant="amber"
            testIdPrefix="stat-status"
         />
      </div>

      {/* Search & Filter Bar */}
      <div className="flex flex-col sm:flex-row items-center gap-4">
        <div className="relative flex-1 w-full">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400" />
          <Input
            placeholder="Search dates or notes..."
            className="pl-10 h-11 rounded-full bg-white/60 backdrop-blur-sm border-slate-200/60 focus:bg-white focus:ring-primary/20 transition-all"
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
          />
        </div>
        <Button 
            variant="outline" 
            onClick={resetToToday} 
            className="rounded-full border-slate-200/60 bg-white/60 backdrop-blur-sm hover:bg-white w-full sm:w-auto"
        >
            <Clock className="w-4 h-4 mr-2 text-slate-500" />
            Jump to Today
        </Button>
      </div>

      {/* Main Table Card */}
      <Card className="glass-card">
        <CardContent className="p-0">
          <div className="overflow-x-auto">
            <table className="w-full text-sm text-left">
              <thead className="bg-white/50 border-b border-slate-200/60">
                <tr>
                  <th className="px-6 py-4 font-semibold text-slate-500 uppercase tracking-wider text-xs">Date</th>
                  <th className="px-6 py-4 font-semibold text-slate-500 uppercase tracking-wider text-xs">Status</th>
                  <th className="px-6 py-4 font-semibold text-slate-500 uppercase tracking-wider text-xs">Time In</th>
                  <th className="px-6 py-4 font-semibold text-slate-500 uppercase tracking-wider text-xs">Time Out</th>
                  <th className="px-6 py-4 font-semibold text-slate-500 uppercase tracking-wider text-xs">Break</th>
                  <th className="px-6 py-4 font-semibold text-slate-500 uppercase tracking-wider text-xs text-right">Work Duration</th>
                  <th className="px-6 py-4 font-semibold text-slate-500 uppercase tracking-wider text-xs">Notes</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-100">
                {isLoading ? (
                  <tr>
                    <td colSpan={7} className="px-6 py-12 text-center text-slate-500">
                      <div className="flex flex-col items-center justify-center gap-2">
                         <Loader2 className="h-6 w-6 animate-spin text-primary" />
                         <p>Loading records...</p>
                      </div>
                    </td>
                  </tr>
                ) : filteredRecords.length === 0 ? (
                  <tr>
                    <td colSpan={7} className="px-6 py-16 text-center text-slate-500">
                      <div className="flex flex-col items-center justify-center gap-3">
                         <div className="h-12 w-12 bg-slate-100 rounded-full flex items-center justify-center">
                             <Calendar className="h-6 w-6 text-slate-400" />
                         </div>
                         <p>No attendance records found for this period.</p>
                      </div>
                    </td>
                  </tr>
                ) : (
                  filteredRecords.map((record) => (
                    <tr key={record.id} className="hover:bg-white/60 transition-colors group">
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="font-medium text-slate-900">{formatDate(record.date)}</div>
                        <div className="text-xs text-slate-500">{formatDay(record.date)}</div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                         <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold capitalize border
                           ${record.status === 'clocked_in' ? 'bg-emerald-50 text-emerald-700 border-emerald-100' : 
                             record.status === 'on_break' ? 'bg-amber-50 text-amber-700 border-amber-100' : 
                             record.status === 'clocked_out' ? 'bg-slate-100 text-slate-700 border-slate-200' : 
                             'bg-rose-50 text-rose-700 border-rose-100'}`}>
                           {record.status.replace('_', ' ')}
                         </span>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-slate-600 font-mono text-base">
                        {formatTime(record.timeIn)}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-slate-600 font-mono text-base">
                        {record.timeOut ? formatTime(record.timeOut) : <span className="text-slate-400 italic">--</span>}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-slate-600">
                        {formatDuration(record.totalBreakMinutes)}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-right font-medium text-slate-900">
                        {record.totalWorkMinutes !== null ? formatDuration(record.totalWorkMinutes) : <span className="text-slate-400 italic">In Progress</span>}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-slate-500 max-w-[200px] truncate text-xs" title={record.notes || ""}>
                        {record.notes || <span className="text-slate-300">-</span>}
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}


===== auth-page.tsx =====
import { useEffect } from "react";
import { useAuth } from "@/hooks/use-auth";
import { Redirect, useLocation } from "wouter";
import { useQuery } from "@tanstack/react-query";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { Building, Users, Shield, Clock, CheckCircle2 } from "lucide-react";

const loginSchema = z.object({
  username: z.string().min(1, "Username is required"),
  password: z.string().min(1, "Password is required"),
});

type LoginForm = z.infer<typeof loginSchema>;

export default function AuthPage() {
  const { user, loginMutation } = useAuth();
  const [, navigate] = useLocation();

  const { data: setupStatus } = useQuery({
    queryKey: ["/api/setup/check"],
  });

  const loginForm = useForm<LoginForm>({
    resolver: zodResolver(loginSchema),
    defaultValues: {
      username: "",
      password: "",
    },
  });

  useEffect(() => {
    if (setupStatus?.needsSetup) {
      navigate("/setup");
    }
  }, [setupStatus, navigate]);

  if (user) {
    return <Redirect to="/" />;
  }

  const onLogin = (data: LoginForm) => {
    loginMutation.mutate(data);
  };

  return (
    <div className="min-h-screen flex bg-slate-50 font-sans text-slate-900">
      
      {/* Left Section: Login Form */}
      <div className="w-full lg:w-1/2 flex items-center justify-center p-8 relative overflow-hidden">
         {/* Decorative Background Elements */}
         <div className="absolute top-0 left-0 w-full h-full bg-white/50 backdrop-blur-3xl z-0"></div>
         <div className="absolute top-[-10%] left-[-10%] w-96 h-96 bg-blue-200/30 rounded-full blur-3xl mix-blend-multiply animate-blob"></div>
         <div className="absolute bottom-[-10%] right-[-10%] w-96 h-96 bg-emerald-200/30 rounded-full blur-3xl mix-blend-multiply animate-blob animation-delay-2000"></div>

        <div className="w-full max-w-md space-y-8 relative z-10">
          <div className="text-center space-y-4">
            <div className="flex justify-center">
              <div className="relative">
                 <div className="absolute -inset-1 bg-gradient-to-r from-blue-600 to-emerald-600 rounded-full blur opacity-20"></div>
                 <img
                  src="/images/logo.jpeg"
                  alt="ESSence Self Service"
                  className="relative w-24 h-24 object-cover rounded-full border-4 border-white shadow-xl"
                />
              </div>
            </div>
            <div>
              <h1 className="text-3xl font-bold tracking-tight text-slate-900">Welcome Back</h1>
              <p className="text-slate-500 text-sm mt-1">Sign in to access your employee portal</p>
            </div>
          </div>

          <Card className="border-none shadow-2xl shadow-slate-200/50 bg-white/80 backdrop-blur-xl rounded-3xl">
            <CardContent className="pt-8 pb-8 px-8">
              <form onSubmit={loginForm.handleSubmit(onLogin)} className="space-y-5">
                <div className="space-y-2">
                  <Label htmlFor="username" className="text-slate-600 font-medium text-sm ml-1">Username</Label>
                  <Input
                    id="username"
                    data-testid="input-username"
                    {...loginForm.register("username")}
                    placeholder="Enter your username"
                    className="h-12 rounded-xl bg-slate-50 border-slate-200 focus:border-blue-500/50 focus:ring-blue-500/20 transition-all"
                  />
                  {loginForm.formState.errors.username && (
                    <p className="text-xs text-red-500 font-medium ml-1">
                      {loginForm.formState.errors.username.message}
                    </p>
                  )}
                </div>
                <div className="space-y-2">
                  <Label htmlFor="password" className="text-slate-600 font-medium text-sm ml-1">Password</Label>
                  <Input
                    id="password"
                    type="password"
                    data-testid="input-password"
                    {...loginForm.register("password")}
                    placeholder="Enter your password"
                    className="h-12 rounded-xl bg-slate-50 border-slate-200 focus:border-blue-500/50 focus:ring-blue-500/20 transition-all"
                  />
                  {loginForm.formState.errors.password && (
                    <p className="text-xs text-red-500 font-medium ml-1">
                      {loginForm.formState.errors.password.message}
                    </p>
                  )}
                </div>
                
                <Button
                  type="submit"
                  className="w-full h-12 rounded-xl bg-slate-900 hover:bg-slate-800 text-white font-semibold shadow-lg shadow-slate-900/20 transition-all hover:scale-[1.02] active:scale-[0.98]"
                  disabled={loginMutation.isPending}
                  data-testid="button-login"
                >
                  {loginMutation.isPending ? (
                     <div className="flex items-center gap-2">
                        <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin" />
                        <span>Signing in...</span>
                     </div>
                  ) : "Sign In"}
                </Button>
              </form>
            </CardContent>
          </Card>
          
          <p className="text-center text-xs text-slate-400">
            Â© 2025 ESSence Self Service. All rights reserved.
          </p>
        </div>
      </div>

      {/* Right Section: Bento Grid Features */}
      <div className="hidden lg:flex lg:w-1/2 bg-slate-900 relative overflow-hidden items-center justify-center p-12">
        {/* Background Gradients */}
        <div className="absolute top-0 right-0 w-[600px] h-[600px] bg-blue-500/20 rounded-full blur-[100px] -translate-y-1/2 translate-x-1/2"></div>
        <div className="absolute bottom-0 left-0 w-[600px] h-[600px] bg-emerald-500/10 rounded-full blur-[100px] translate-y-1/2 -translate-x-1/2"></div>
        
        <div className="relative z-10 max-w-xl w-full">
           <div className="mb-12 text-center">
             <h2 className="text-4xl font-bold text-white mb-4 tracking-tight">Streamline Your Workplace</h2>
             {/* <p className="text-slate-400 text-lg font-light">Manage your employee journey with our comprehensive self-service portal.</p> */}
           </div>

           <div className="grid grid-cols-2 gap-4">
              {/* Feature Card 1 */}
              <div className="bg-white/5 backdrop-blur-lg border border-white/10 p-6 rounded-3xl hover:bg-white/10 transition-colors">
                 <div className="w-12 h-12 bg-blue-500/20 rounded-2xl flex items-center justify-center mb-4 text-blue-400">
                    <Users className="w-6 h-6" />
                 </div>
                 <h3 className="text-white font-semibold text-lg mb-1">Team Management</h3>
                 <p className="text-slate-400 text-sm leading-relaxed">Collaborate effectively with your team members.</p>
              </div>

              {/* Feature Card 2 */}
              <div className="bg-white/5 backdrop-blur-lg border border-white/10 p-6 rounded-3xl hover:bg-white/10 transition-colors">
                 <div className="w-12 h-12 bg-emerald-500/20 rounded-2xl flex items-center justify-center mb-4 text-emerald-400">
                    <Shield className="w-6 h-6" />
                 </div>
                 <h3 className="text-white font-semibold text-lg mb-1">Secure Access</h3>
                 <p className="text-slate-400 text-sm leading-relaxed">Enterprise-grade security for your personal data.</p>
              </div>

              {/* Feature Card 3 */}
              <div className="bg-white/5 backdrop-blur-lg border border-white/10 p-6 rounded-3xl hover:bg-white/10 transition-colors">
                 <div className="w-12 h-12 bg-amber-500/20 rounded-2xl flex items-center justify-center mb-4 text-amber-400">
                    <Clock className="w-6 h-6" />
                 </div>
                 <h3 className="text-white font-semibold text-lg mb-1">Time Tracking</h3>
                 <p className="text-slate-400 text-sm leading-relaxed">Monitor schedules and attendance in real-time.</p>
              </div>

              {/* Feature Card 4 */}
              <div className="bg-white/5 backdrop-blur-lg border border-white/10 p-6 rounded-3xl hover:bg-white/10 transition-colors">
                 <div className="w-12 h-12 bg-rose-500/20 rounded-2xl flex items-center justify-center mb-4 text-rose-400">
                    <Building className="w-6 h-6" />
                 </div>
                 <h3 className="text-white font-semibold text-lg mb-1">Digital Workspace</h3>
                 <p className="text-slate-400 text-sm leading-relaxed">Everything you need in one unified place.</p>
              </div>
           </div>
        </div>
      </div>
    </div>
  );
}


===== dashboard.tsx =====
import { useQuery } from "@tanstack/react-query";
import StatCard from "@/components/dashboard/stat-card";
import AnnouncementsCard from "@/components/dashboard/announcements-card";
import ActivitiesCard from "@/components/dashboard/activities-card";
import ScheduleCard from "@/components/dashboard/schedule-card";
import QuickActionsCard from "@/components/dashboard/quick-actions-card";
import PendingTasksCard from "@/components/dashboard/pending-tasks-card";
import { Calendar, Clock, AlertTriangle, GraduationCap } from "lucide-react";
import { canViewDashoardHoursThisWeek, canViewDashoardLeaveBalance, canViewDashoardWeekSchedule } from "@/utils/permissions";
import { useAuth } from "@/hooks/use-auth";

export default function Dashboard() {
  const { data: stats, isLoading: statsLoading } = useQuery({
    queryKey: ["/api/dashboard-stats"],
  });

  const { data: announcements, isLoading: announcementsLoading } = useQuery({
    queryKey: ["/api/announcements"],
  });

  const { data: activities, isLoading: activitiesLoading } = useQuery({
    queryKey: ["/api/activities/all"],
  });

  const { data: schedules, isLoading: schedulesLoading } = useQuery({
    queryKey: ["/api/schedules"],
  });

  const { user } = useAuth();

  return (
    <div className="p-6 md:p-8 space-y-8">
      
      {/* 1. Bento Stats Row */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        {canViewDashoardLeaveBalance(user) && (
          <StatCard
            title="Leave Balance"
            value={stats?.leaveBalance || "0 days"}
            icon={Calendar}
            variant="blue"
            isLoading={statsLoading}
            testId="stat-leave-balance"
          />
        )}
        {canViewDashoardHoursThisWeek(user) && (
          <StatCard
            title="Hours This Week"
            value={stats?.weeklyHours || "0 hrs"}
            icon={Clock}
            variant="emerald"
            isLoading={statsLoading}
            testId="stat-weekly-hours"
          />
        )}
        <StatCard
          title="Pending Approvals"
          value={stats?.pendingApprovals?.toString() || "0"}
          icon={AlertTriangle}
          variant="amber"
          isLoading={statsLoading}
          testId="stat-pending-approvals"
        />
        {/* Example of a 4th card or placeholder */}
        {/* <StatCard
          title="Training Progress"
          value={stats?.trainingProgress || "0%"}
          icon={GraduationCap}
          variant="rose"
          isLoading={statsLoading}
          testId="stat-training-progress"
        /> */}
      </div>

      {/* 2. Main Content Grid (Asymmetric Bento) */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* Left Column: Feeds (2/3 width) */}
        <div className="lg:col-span-2 space-y-8">
          <AnnouncementsCard
            announcements={announcements || []}
            isLoading={announcementsLoading}
          />
          <ActivitiesCard
            activities={activities || []}
            isLoading={activitiesLoading}
          />
        </div>

        {/* Right Column: Tools & Tasks (1/3 width) */}
        <div className="space-y-8">
          <QuickActionsCard />
          
          {canViewDashoardWeekSchedule(user) && (
            <ScheduleCard
              schedules={schedules || []}
              isLoading={schedulesLoading}
            />
          )}
          
          <PendingTasksCard />
        </div>
      </div>
    </div>
  );
}


===== holiday-calendar.tsx =====
import React, { useState } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { format, startOfMonth, endOfMonth, eachDayOfInterval, isSameMonth, isSameDay, addMonths, subMonths } from "date-fns";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { ChevronLeft, ChevronRight, Calendar as CalendarIcon, Trash2, Plus } from "lucide-react";
import type { Holiday } from "@shared/schema";
import { toast } from "sonner";
import { apiRequest } from "@/lib/queryClient";

export default function HolidayCalendar() {
  const queryClient = useQueryClient();
  const [currentDate, setCurrentDate] = useState(new Date());
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const [selectedDate, setSelectedDate] = useState<Date | null>(null);
  const [formData, setFormData] = useState({ name: "", type: "regular" });

  const { data: holidays, isLoading } = useQuery<Holiday[]>({
    queryKey: ["/api/holidays"],
  });

  const createMutation = useMutation({
    mutationFn: async (data: any) => {
      const res = await apiRequest("POST", "/api/holidays", data);
      return await res.json();
    },
    onSuccess: () => {
      toast("Holiday Added", { description: "The holiday has been successfully added." });
      queryClient.invalidateQueries({ queryKey: ["/api/holidays"] });
      setIsDialogOpen(false);
      setFormData({ name: "", type: "regular" });
    }
  });

  const deleteMutation = useMutation({
    mutationFn: async (id: string) => {
      await fetch(`/api/holidays/${id}`, { method: "DELETE" });
    },
    onSuccess: () => {
      toast("Holiday Removed", { description: "The holiday has been deleted." });
      queryClient.invalidateQueries({ queryKey: ["/api/holidays"] });
    }
  });

  // Calendar Grid Logic
  const monthStart = startOfMonth(currentDate);
  const monthEnd = endOfMonth(currentDate);
  const daysInMonth = eachDayOfInterval({ start: monthStart, end: monthEnd });

  // Pad start of month
  const startPadding = Array.from({ length: monthStart.getDay() }, (_, i) => i);

  const handleDayClick = (date: Date) => {
    setSelectedDate(date);
    setIsDialogOpen(true);
  };

  const handleSubmit = () => {
    if (selectedDate && formData.name) {
      createMutation.mutate({
        date: selectedDate.getTime(), // Send as timestamp
        name: formData.name,
        type: formData.type
      });
    }
  };

  const handleDelete = (e: React.MouseEvent, id: string) => {
    e.stopPropagation();
    deleteMutation.mutate(id);
  };

  return (
    <div className="p-6 md:p-8 max-w-6xl mx-auto space-y-8">
       <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
         <div>
            <h1 className="text-3xl font-bold tracking-tight text-slate-900">Holiday Calendar</h1>
            <p className="text-slate-500 mt-1 text-sm">Manage holidays and non-working days for payroll calculation.</p>
         </div>
         <div className="flex items-center gap-2 bg-white/80 backdrop-blur-sm p-1 rounded-full border shadow-sm">
            <Button variant="ghost" size="icon" onClick={() => setCurrentDate(subMonths(currentDate, 1))} className="rounded-full"><ChevronLeft className="w-4 h-4" /></Button>
            <div className="font-semibold text-slate-700 w-32 text-center">{format(currentDate, 'MMMM yyyy')}</div>
            <Button variant="ghost" size="icon" onClick={() => setCurrentDate(addMonths(currentDate, 1))} className="rounded-full"><ChevronRight className="w-4 h-4" /></Button>
         </div>
       </div>

       <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* Calendar View */}
          <Card className="lg:col-span-2 bg-white/60 backdrop-blur-xl border-slate-200/60 shadow-sm rounded-3xl overflow-hidden">
             <div className="grid grid-cols-7 text-center py-4 bg-slate-50/50 border-b border-slate-100 text-xs font-semibold text-slate-500 uppercase tracking-wider">
                {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => <div key={day}>{day}</div>)}
             </div>
             <div className="grid grid-cols-7 auto-rows-[100px] bg-white/40">
                {startPadding.map(i => <div key={`pad-${i}`} className="border-b border-r border-slate-100/50 bg-slate-50/20" />)}
                {daysInMonth.map(day => {
                   const holiday = holidays?.find(h => isSameDay(new Date(h.date), day));
                   const isToday = isSameDay(day, new Date());
                   
                   return (
                      <div 
                        key={day.toISOString()} 
                        onClick={() => handleDayClick(day)}
                        className={`relative border-b border-r border-slate-100/50 p-2 transition-colors hover:bg-blue-50/30 cursor-pointer group ${isToday ? 'bg-blue-50/20' : ''}`}
                      >
                         <span className={`text-sm font-medium ${isToday ? 'text-blue-600 bg-blue-100 w-6 h-6 rounded-full flex items-center justify-center' : 'text-slate-700'}`}>
                            {format(day, 'd')}
                         </span>
                         
                         {holiday && (
                            <div className={`mt-2 p-1.5 rounded-lg text-xs font-medium border shadow-sm group-hover:shadow-md transition-all
                                ${holiday.type === 'regular' 
                                   ? 'bg-purple-100 text-purple-700 border-purple-200' 
                                   : 'bg-amber-100 text-amber-700 border-amber-200'
                                }`}
                            >
                               <div className="truncate" title={holiday.name}>{holiday.name}</div>
                               <div className="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                   <Button variant="ghost" size="icon" className="h-5 w-5 text-slate-500 hover:text-red-500 hover:bg-white/50" onClick={(e) => handleDelete(e, holiday.id)}>
                                      <Trash2 className="w-3 h-3" />
                                   </Button>
                               </div>
                            </div>
                         )}

                         {!holiday && (
                             <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 pointer-events-none">
                                 <Plus className="w-6 h-6 text-slate-300" />
                             </div>
                         )}
                      </div>
                   );
                })}
             </div>
          </Card>

          {/* Side List */}
          <Card className="bg-white/60 backdrop-blur-xl border-slate-200/60 shadow-sm rounded-3xl h-fit">
             <CardHeader>
                <CardTitle className="text-lg">Upcoming Holidays</CardTitle>
             </CardHeader>
             <CardContent>
                {isLoading ? (
                    <div className="text-center py-8 text-slate-400 text-sm">Loading...</div>
                ) : (holidays && holidays.length > 0) ? (
                    <div className="space-y-3">
                        {holidays
                          .filter(h => new Date(h.date) >= startOfMonth(currentDate))
                          .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())
                          .slice(0, 5)
                          .map(holiday => (
                            <div key={holiday.id} className="flex items-center gap-3 p-3 rounded-xl bg-white border border-slate-100 shadow-sm">
                                <div className={`flex flex-col items-center justify-center w-12 h-12 rounded-lg border ${holiday.type === 'regular' ? 'bg-purple-50 border-purple-100 text-purple-600' : 'bg-amber-50 border-amber-100 text-amber-600'}`}>
                                    <span className="text-xs font-bold uppercase">{format(new Date(holiday.date), 'MMM')}</span>
                                    <span className="text-lg font-bold leading-none">{format(new Date(holiday.date), 'd')}</span>
                                </div>
                                <div>
                                    <p className="font-medium text-slate-800 text-sm">{holiday.name}</p>
                                    <p className="text-xs text-slate-500 capitalize">{holiday.type} Holiday</p>
                                </div>
                            </div>
                        ))}
                        {holidays.filter(h => new Date(h.date) >= startOfMonth(currentDate)).length === 0 && (
                            <div className="text-center py-6 text-slate-400 text-sm">No upcoming holidays this month.</div>
                        )}
                    </div>
                ) : (
                    <div className="text-center py-8 text-slate-400 text-sm">No holidays found.</div>
                )}
             </CardContent>
          </Card>
       </div>

       {/* Add Dialog */}
       <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
          <DialogContent className="rounded-2xl">
             <DialogHeader>
                <DialogTitle>Add Holiday</DialogTitle>
             </DialogHeader>
             <div className="space-y-4 py-4">
                <div className="space-y-2">
                   <Label>Date</Label>
                   <div className="p-2 bg-slate-100 rounded-lg text-sm font-medium text-slate-700">
                      {selectedDate ? format(selectedDate, 'MMMM d, yyyy') : '-'}
                   </div>
                </div>
                <div className="space-y-2">
                   <Label>Holiday Name</Label>
                   <Input 
                      placeholder="e.g. Independence Day" 
                      value={formData.name}
                      onChange={e => setFormData({...formData, name: e.target.value})}
                   />
                </div>
                <div className="space-y-2">
                   <Label>Type</Label>
                   <Select value={formData.type} onValueChange={(val) => setFormData({...formData, type: val})}>
                      <SelectTrigger><SelectValue /></SelectTrigger>
                      <SelectContent>
                         <SelectItem value="regular">Regular Holiday</SelectItem>
                         <SelectItem value="special">Special Non-Working</SelectItem>
                      </SelectContent>
                   </Select>
                </div>
             </div>
             <DialogFooter>
                <Button variant="outline" onClick={() => setIsDialogOpen(false)}>Cancel</Button>
                <Button onClick={handleSubmit}>Add Holiday</Button>
             </DialogFooter>
          </DialogContent>
       </Dialog>
    </div>
  );
}


===== labor-cost-analytics.tsx =====
import { useState } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { useAuth } from "@/hooks/use-auth";
import { apiRequest } from "@/lib/queryClient";
import { toast } from "sonner";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { Textarea } from "@/components/ui/textarea";
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger, DialogFooter } from "@/components/ui/dialog";
import { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from "@/components/ui/alert-dialog";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { DollarSign, Plus, AlertCircle, CheckCircle, Lightbulb, TrendingUp, TrendingDown, Activity, Pencil, Trash2 } from "lucide-react";
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, AreaChart, Area } from "recharts";
import type { LaborCostData } from "@shared/schema";
import { Loader2 } from "lucide-react";
import { canViewLaborCostAnalysis } from "@/utils/permissions";

const formSchema = z.object({
  month: z.number().min(1).max(12),
  year: z.number().min(2000),
  totalSales: z.number().min(0, "Sales must be positive"),
  totalLaborCost: z.number().min(0, "Labor cost must be positive"),
  notes: z.string().optional(),
});

type LaborCostForm = z.infer<typeof formSchema>;

export default function LaborCostAnalytics() {
  const { user } = useAuth();
  const queryClient = useQueryClient();
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
  
  // Edit/Delete State
  const [editingRecord, setEditingRecord] = useState<LaborCostData | null>(null);
  const [deleteId, setDeleteId] = useState<string | null>(null);

  const { data: laborCostData, isLoading } = useQuery({
    queryKey: ["/api/labor-cost", selectedYear],
    queryFn: async () => {
      const res = await apiRequest("GET", `/api/labor-cost`);
      return await res.json();
    },
  });

  const form = useForm<LaborCostForm>({
    resolver: zodResolver(formSchema),
    defaultValues: {
      month: new Date().getMonth() + 1,
      year: new Date().getFullYear(),
      totalSales: 0,
      totalLaborCost: 0,
      notes: "",
    },
  });

  // Helper for calculations
  const calculateMetrics = (totalSales: number, totalLaborCost: number) => {
    const salesInCentavos = Math.round(totalSales * 100);
    const laborInCentavos = Math.round(totalLaborCost * 100);

    let percentage = 0;
    if (salesInCentavos > 0) {
        percentage = (laborInCentavos / salesInCentavos) * 10000;
    } else if (laborInCentavos > 0) {
        percentage = 1000000; 
    }
    
    let status = "Poor";
    let performanceRating = "critical";
    
    if (percentage < 3000) {
      status = "Excellent";
      performanceRating = "good";
    } else if (percentage < 3500) {
      status = "High";
      performanceRating = "good";
    } else if (percentage < 4500) {
      status = "High";
      performanceRating = "warning";
    } else if (percentage < 5000) {
      status = "Poor";
      performanceRating = "warning";
    }

    return { 
      salesInCentavos, 
      laborInCentavos, 
      percentage: Math.round(percentage), 
      status, 
      performanceRating 
    };
  };

  const createLaborCostMutation = useMutation({
    mutationFn: async (data: LaborCostForm) => {
      const metrics = calculateMetrics(data.totalSales, data.totalLaborCost);
      
      const res = await apiRequest("POST", "/api/labor-cost", {
        month: data.month,
        year: data.year,
        notes: data.notes,
        totalSales: metrics.salesInCentavos,
        totalLaborCost: metrics.laborInCentavos,
        laborCostPercentage: metrics.percentage,
        status: metrics.status,
        performanceRating: metrics.performanceRating,
      });
      return await res.json();
    },
    onSuccess: () => {
      toast.success("Data added", { description: "Labor cost data has been added successfully." });
      queryClient.invalidateQueries({ queryKey: ["/api/labor-cost"] });
      handleCloseDialog();
    },
    onError: (error: Error) => {
      toast.error("Failed to add data", { description: error.message });
    },
  });

  const updateLaborCostMutation = useMutation({
    mutationFn: async (data: LaborCostForm) => {
      if (!editingRecord) throw new Error("No record selected");
      
      const metrics = calculateMetrics(data.totalSales, data.totalLaborCost);

      const res = await fetch(`/api/labor-cost/${editingRecord.id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            ...metrics,
            totalSales: metrics.salesInCentavos,
            totalLaborCost: metrics.laborInCentavos,
            laborCostPercentage: metrics.percentage,
            month: data.month,
            year: data.year,
            notes: data.notes
        }),
      });
      
      if (!res.ok) throw new Error("Failed to update");
      return await res.json();
    },
    onSuccess: () => {
      toast.success("Data updated", { description: "Record updated successfully." });
      queryClient.invalidateQueries({ queryKey: ["/api/labor-cost"] });
      handleCloseDialog();
    },
    onError: (error: Error) => {
      toast.error("Update failed", { description: error.message });
    },
  });

  const deleteLaborCostMutation = useMutation({
    mutationFn: async (id: string) => {
       // Assuming standard REST delete endpoint exists or added
       const res = await fetch(`/api/labor-cost/${id}`, { method: "DELETE" }); 
       // If endpoint doesn't exist yet, this will fail. Ensure backend supports it.
       if(!res.ok) throw new Error("Failed to delete");
       return res.json();
    },
    onSuccess: () => {
      toast.success("Deleted", { description: "Record removed successfully." });
      queryClient.invalidateQueries({ queryKey: ["/api/labor-cost"] });
      setDeleteId(null);
    },
    onError: (error: Error) => {
      toast.error("Delete failed", { description: "Could not delete record." });
    }
  });

  const onSubmit = (data: LaborCostForm) => {
    if (editingRecord) {
        updateLaborCostMutation.mutate(data);
    } else {
        createLaborCostMutation.mutate(data);
    }
  };

  const handleEdit = (record: LaborCostData) => {
    setEditingRecord(record);
    form.reset({
        month: record.month,
        year: record.year,
        totalSales: record.totalSales / 100,
        totalLaborCost: record.totalLaborCost / 100,
        notes: record.notes || "",
    });
    setIsDialogOpen(true);
  };

  const handleCloseDialog = () => {
    setIsDialogOpen(false);
    setEditingRecord(null);
    form.reset();
  };

  const formatCurrency = (amount: number) => {
    return new Intl.NumberFormat('en-PH', {
      style: 'currency',
      currency: 'PHP',
      maximumFractionDigits: 0,
    }).format(amount / 100);
  };

  // New formatting for compact numbers (e.g. 2.5m)
  const formatCompactNumber = (value: number) => {
    if (value >= 1000000) {
      return (value / 1000000).toFixed(2).replace(/\.00$/, '') + 'm';
    }
    if (value >= 1000) {
      return (value / 1000).toFixed(1).replace(/\.0$/, '') + 'k';
    }
    return value.toString();
  };

  const getMonthName = (month: number) => {
    const months = [
      'January', 'February', 'March', 'April', 'May', 'June',
      'July', 'August', 'September', 'October', 'November', 'December'
    ];
    return months[month - 1];
  };

  const getStatusBadge = (status: string) => {
    const variants: Record<string, { color: string; icon: any }> = {
      "Excellent": { color: "bg-emerald-100 text-emerald-700 border-emerald-200", icon: CheckCircle },
      "High": { color: "bg-amber-100 text-amber-700 border-amber-200", icon: AlertCircle },
      "Poor": { color: "bg-rose-100 text-rose-700 border-rose-200", icon: AlertCircle },
    };
    const config = variants[status] || variants["High"];
    const Icon = config.icon;
    return (
      <Badge variant="outline" className={`flex items-center gap-1 px-2.5 py-0.5 rounded-full ${config.color}`}>
        <Icon className="w-3 h-3" />
        {status}
      </Badge>
    );
  };

  const currentMonthData = laborCostData?.[0];
  const previousMonthData = laborCostData?.[1];
  
  const improvement = currentMonthData && previousMonthData
    ? ((previousMonthData.laborCostPercentage - currentMonthData.laborCostPercentage) / 100).toFixed(1)
    : null;

  const chartData = laborCostData?.slice(0, 7).reverse().map((data: LaborCostData) => ({
    month: getMonthName(data.month).substring(0, 3),
    fullMonth: getMonthName(data.month),
    year: data.year,
    sales: data.totalSales / 100,
    laborCost: data.totalLaborCost / 100,
    laborPercent: data.laborCostPercentage / 100,
  })) || [];

  if (!canViewLaborCostAnalysis(user)) {
    return (
      <div className="p-8 flex justify-center items-center h-screen bg-slate-50">
        <Card className="w-full max-w-md bg-white/60 backdrop-blur-xl border-slate-200 shadow-xl">
          <CardContent className="py-12 text-center space-y-4">
            <div className="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto">
               <AlertCircle className="w-8 h-8" />
            </div>
            <h2 className="text-xl font-bold text-slate-900">Access Restricted</h2>
            <p className="text-slate-500">This page is only available to managers and HR personnel.</p>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (isLoading) return <div className="min-h-screen flex items-center justify-center"><Loader2 className="animate-spin text-slate-400" /></div>;

  return (
    <div className="p-6 md:p-8 max-w-7xl mx-auto space-y-8">
      {/* Header */}
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h1 className="text-3xl font-bold tracking-tight text-slate-900">Labor Cost Analytics</h1>
          <p className="text-slate-500 mt-1 text-sm">Strategic insights into workforce efficiency and sales performance</p>
        </div>
        <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
          <DialogTrigger asChild>
            <Button 
                className="bg-slate-900 hover:bg-slate-800 text-white shadow-lg shadow-slate-900/20 rounded-full px-6"
                onClick={() => { setEditingRecord(null); form.reset(); }}
            >
              <Plus className="w-4 h-4 mr-2" /> Add Monthly Data
            </Button>
          </DialogTrigger>
          <DialogContent className="max-w-lg rounded-2xl">
            <DialogHeader>
              <DialogTitle>{editingRecord ? 'Edit Data' : 'Add Labor Cost Data'}</DialogTitle>
              <DialogDescription>Enter confirmed financial data for the month</DialogDescription>
            </DialogHeader>
            <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-5 mt-4">
               <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label htmlFor="month">Month</Label>
                    <Input id="month" type="number" min="1" max="12" {...form.register("month", { valueAsNumber: true })} className="rounded-xl" />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="year">Year</Label>
                    <Input id="year" type="number" {...form.register("year", { valueAsNumber: true })} className="rounded-xl" />
                  </div>
               </div>
               <div className="space-y-2">
                  <Label htmlFor="totalSales">Total Sales (â±)</Label>
                  <Input id="totalSales" type="number" step="0.01" {...form.register("totalSales", { valueAsNumber: true })} placeholder="0.00" className="rounded-xl text-lg font-medium" />
               </div>
               <div className="space-y-2">
                  <Label htmlFor="totalLaborCost">Total Labor Cost (â±)</Label>
                  <Input id="totalLaborCost" type="number" step="0.01" {...form.register("totalLaborCost", { valueAsNumber: true })} placeholder="0.00" className="rounded-xl text-lg font-medium" />
               </div>
               <div className="space-y-2">
                  <Label htmlFor="notes">Notes</Label>
                  <Textarea id="notes" {...form.register("notes")} className="rounded-xl resize-none" />
               </div>
               <DialogFooter>
                  <Button type="button" variant="outline" onClick={handleCloseDialog} className="rounded-full">Cancel</Button>
                  <Button type="submit" disabled={createLaborCostMutation.isPending || updateLaborCostMutation.isPending} className="rounded-full bg-slate-900">
                    {createLaborCostMutation.isPending || updateLaborCostMutation.isPending ? "Saving..." : "Save Data"}
                  </Button>
               </DialogFooter>
            </form>
          </DialogContent>
        </Dialog>
      </div>

      {/* Bento Grid - The Big Picture */}
      {currentMonthData ? (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
           {/* 1. Key Metric: Labor % Gauge */}
           <Card className="lg:row-span-2 bg-slate-900 text-white border-slate-800 shadow-xl rounded-3xl relative overflow-hidden group">
              <div className="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/3 pointer-events-none group-hover:bg-white/10 transition-colors duration-500    "  />
              <CardHeader>
                 <CardTitle className="text-slate-200 flex items-center gap-2 text-sm uppercase tracking-wider">
                    <Activity className="w-4 h-4" /> Efficiency Score
                 </CardTitle>
              </CardHeader>
              <CardContent className="flex flex-col items-center justify-center py-8 relative z-10">
                  <div className="relative w-56 h-56">
                     <svg className="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="40" fill="none" stroke="#1e293b" strokeWidth="10" />
                        <circle 
                           cx="50" cy="50" r="40" fill="none" 
                           // Cap visual progress at 100%
                           strokeDasharray={`${Math.min(100, currentMonthData.laborCostPercentage / 100) * 2.51} 251`}
                           stroke={currentMonthData.laborCostPercentage < 3500 ? "#10b981" : currentMonthData.laborCostPercentage < 4500 ? "#f59e0b" : "#ef4444"}
                           strokeWidth="10"
                           strokeLinecap="round"
                           className="drop-shadow-[0_0_10px_rgba(255,255,255,0.2)]"
                        />
                     </svg>
                     <div className="absolute inset-0 flex flex-col items-center justify-center">
                        <span className={`font-bold ${currentMonthData.laborCostPercentage > 99900 ? 'text-3xl' : 'text-5xl'}`}>
                           {formatCompactNumber(currentMonthData.laborCostPercentage / 100)}<span className="text-2xl text-slate-400">%</span>
                        </span>
                        <span className="text-xs font-medium text-slate-400 uppercase mt-1">Labor / Sales</span>
                     </div>
                  </div>
                  <div className="mt-6 text-center space-y-1">
                     <p className="text-lg font-semibold">{currentMonthData.status} Rating</p>
                     <p className="text-sm text-slate-400">Target: &lt; 30%</p>
                  </div>
              </CardContent>
           </Card>

           {/* 2. Financials */}
           <Card className="bg-white/60 backdrop-blur-xl border-slate-200/60 shadow-sm rounded-3xl hover:shadow-md transition-all">
              <CardHeader className="pb-2">
                 <CardTitle className="text-sm font-bold text-slate-500 uppercase tracking-wider">Financial Overview</CardTitle>
              </CardHeader>
              <CardContent className="space-y-6">
                 <div>
                    <p className="text-xs text-slate-400 mb-1">Total Revenue</p>
                    <div className="flex items-center gap-2">
                       <p className="text-3xl font-bold text-slate-800">â±{formatCompactNumber(currentMonthData.totalSales / 100)}</p>
                       <span className="text-xs font-medium bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full flex items-center">
                          <TrendingUp className="w-3 h-3 mr-1" /> Sales
                       </span>
                    </div>
                 </div>
                 <div className="h-px bg-slate-100 w-full" />
                 <div>
                    <p className="text-xs text-slate-400 mb-1">Total Labor Cost</p>
                    <div className="flex items-center gap-2">
                       <p className="text-3xl font-bold text-rose-600">â±{formatCompactNumber(currentMonthData.totalLaborCost / 100)}</p>
                       <span className="text-xs font-medium bg-rose-100 text-rose-700 px-2 py-0.5 rounded-full flex items-center">
                          <TrendingDown className="w-3 h-3 mr-1" /> Cost
                       </span>
                    </div>
                 </div>
              </CardContent>
           </Card>

           {/* 3. Insight Card */}
           <Card className="bg-gradient-to-br from-blue-50/80 to-white/80 backdrop-blur-xl border-blue-100/60 shadow-sm rounded-3xl">
              <CardHeader className="pb-2">
                 <CardTitle className="text-sm font-bold text-blue-600 uppercase tracking-wider flex items-center gap-2">
                    <Lightbulb className="w-4 h-4" /> Suggestions
                 </CardTitle>
              </CardHeader>
              <CardContent>
                 <p className="text-slate-700 font-medium leading-relaxed">
                    {currentMonthData.laborCostPercentage < 3500
                      ? "Excellent work! Your labor costs are optimized. This efficiency maximizes profitability."
                      : currentMonthData.laborCostPercentage < 4500
                      ? "Performance is stable, but watch out for overtime spikes during low-sales periods."
                      : "Labor costs are eating into margins. Consider reviewing scheduling efficiency or increasing sales targets."}
                 </p>
                 {improvement && parseFloat(improvement) > 0 && (
                    <div className="mt-4 p-3 bg-emerald-100/50 rounded-xl border border-emerald-100 flex items-center gap-3">
                       <div className="bg-emerald-500 text-white p-1.5 rounded-full"><TrendingDown className="w-4 h-4" /></div>
                       <div>
                          <p className="text-xs text-emerald-800 font-bold uppercase">Improvement</p>
                          <p className="text-sm text-emerald-900">Reduced costs by <span className="font-bold">{improvement}%</span> vs last month.</p>
                       </div>
                    </div>
                 )}
              </CardContent>
           </Card>

           {/* 4. Trend Chart (Spans 2 cols) */}
           <Card className="lg:col-span-2 bg-white/60 backdrop-blur-xl border-slate-200/60 shadow-sm rounded-3xl overflow-hidden">
              <CardHeader>
                 <CardTitle className="text-lg font-bold text-slate-800">6-Month Trend Analysis</CardTitle>
              </CardHeader>
              <CardContent className="h-[300px]">
                 <ResponsiveContainer width="100%" height="100%">
                    <AreaChart data={chartData} margin={{ top: 10, right: 30, left: 0, bottom: 0 }}>
                      <defs>
                        <linearGradient id="colorSales" x1="0" y1="0" x2="0" y2="1">
                          <stop offset="5%" stopColor="#0f172a" stopOpacity={0.1}/>
                          <stop offset="95%" stopColor="#0f172a" stopOpacity={0}/>
                        </linearGradient>
                        <linearGradient id="colorCost" x1="0" y1="0" x2="0" y2="1">
                          <stop offset="5%" stopColor="#ef4444" stopOpacity={0.1}/>
                          <stop offset="95%" stopColor="#ef4444" stopOpacity={0}/>
                        </linearGradient>
                      </defs>
                      <XAxis dataKey="month" axisLine={false} tickLine={false} tick={{fill: '#94a3b8', fontSize: 12}} />
                      <YAxis axisLine={false} tickLine={false} tick={{fill: '#94a3b8', fontSize: 12}} />
                      <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                      <Tooltip 
                        contentStyle={{ backgroundColor: 'rgba(255, 255, 255, 0.8)', backdropFilter: 'blur(4px)', borderRadius: '12px', border: 'none', boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)' }} 
                        content={({ active, payload }) => {
                          if (active && payload && payload.length) {
                            const data = payload[0].payload;
                            return (
                              <div className="bg-white/95 backdrop-blur-md border border-slate-200/60 p-3 rounded-xl shadow-xl text-sm">
                                <p className="font-bold text-slate-800 mb-2 border-b border-slate-200/60 pb-2">
                                  {data.fullMonth}, {data.year}
                                </p>
                                <div className="space-y-1.5">
                                  <div className="flex items-center justify-between gap-4">
                                    <div className="flex items-center gap-2">
                                      <div className="w-2 h-2 rounded-full bg-slate-900" />
                                      <span className="text-slate-500">Sales:</span>
                                    </div>
                                    <span className="font-mono font-medium text-slate-900">
                                      â±{data.sales.toLocaleString()}
                                    </span>
                                  </div>
                                  <div className="flex items-center justify-between gap-4">
                                    <div className="flex items-center gap-2">
                                      <div className="w-2 h-2 rounded-full bg-red-500" />
                                      <span className="text-slate-500">Labor:</span>
                                    </div>
                                    <span className="font-mono font-medium text-rose-600">
                                      â±{data.laborCost.toLocaleString()}
                                    </span>
                                  </div>
                                </div>
                              </div>
                            );
                          }
                          return null;
                        }}
                      />
                      <Area type="monotone" dataKey="sales" stroke="#0f172a" strokeWidth={3} fillOpacity={1} fill="url(#colorSales)" name="Sales" />
                      <Area type="monotone" dataKey="laborCost" stroke="#ef4444" strokeWidth={3} fillOpacity={1} fill="url(#colorCost)" name="Labor Cost" />
                    </AreaChart>
                 </ResponsiveContainer>
              </CardContent>
           </Card>
        </div>
      ) : (
        <div className="text-center py-20 bg-white/40 border border-dashed border-slate-200 rounded-3xl">
             <div className="h-20 w-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                 <DollarSign className="w-10 h-10 text-slate-300" />
             </div>
             <h3 className="text-lg font-semibold text-slate-900">No Data Available</h3>
             <p className="text-slate-500 max-w-md mx-auto mt-2 mb-6">Start tracking your labor efficiency by adding your first month's financial data.</p>
             <Button onClick={() => setIsDialogOpen(true)} className="rounded-full bg-slate-900">Add Data Now</Button>
        </div>
      )}

      {/* Detailed History Table */}
      {laborCostData && laborCostData.length > 0 && (
          <Card className="bg-white/60 backdrop-blur-xl border-slate-200/60 shadow-sm rounded-3xl overflow-hidden">
            <CardHeader className="bg-white/50 border-b border-slate-100 px-6 py-4">
                <CardTitle className="text-lg font-bold text-slate-800">Historical Data</CardTitle>
            </CardHeader>
            <div className="overflow-x-auto">
                <table className="w-full text-sm text-left">
                    <thead className="bg-slate-50/80 text-slate-500">
                        <tr>
                            <th className="px-6 py-3 font-medium uppercase text-xs tracking-wider">Month</th>
                            <th className="px-6 py-3 font-medium uppercase text-xs tracking-wider text-right">Sales</th>
                            <th className="px-6 py-3 font-medium uppercase text-xs tracking-wider text-right">Labor Cost</th>
                            <th className="px-6 py-3 font-medium uppercase text-xs tracking-wider text-right">Efficiency %</th>
                            <th className="px-6 py-3 font-medium uppercase text-xs tracking-wider text-center">Status</th>
                            <th className="px-6 py-3 font-medium uppercase text-xs tracking-wider text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                        {laborCostData.map((data: LaborCostData) => (
                            <tr key={data.id} className="hover:bg-white/50 transition-colors">
                                <td className="px-6 py-4 font-medium text-slate-900">
                                    {getMonthName(data.month)} {data.year}
                                </td>
                                <td className="px-6 py-4 text-right font-mono text-slate-600">
                                    â±{formatCompactNumber(data.totalSales / 100)}
                                </td>
                                <td className="px-6 py-4 text-right font-mono text-rose-600">
                                    â±{formatCompactNumber(data.totalLaborCost / 100)}
                                </td>
                                <td className="px-6 py-4 text-right font-bold text-slate-800">
                                    {(data.laborCostPercentage / 100).toFixed(1)}%
                                </td>
                                <td className="px-6 py-4 text-center">
                                    <div className="flex justify-center">
                                       {getStatusBadge(data.status || "")}
                                    </div>
                                </td>
                                <td className="px-6 py-4 text-center">
                                    <div className="flex justify-center gap-2">
                                        <Button variant="ghost" size="icon" className="h-8 w-8 hover:text-blue-600 hover:bg-blue-50 rounded-full" onClick={() => handleEdit(data)}>
                                            <Pencil className="w-3.5 h-3.5" />
                                        </Button>
                                        <Button variant="ghost" size="icon" className="h-8 w-8 hover:text-red-600 hover:bg-red-50 rounded-full" onClick={() => setDeleteId(data.id)}>
                                            <Trash2 className="w-3.5 h-3.5" />
                                        </Button>
                                    </div>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
          </Card>
      )}

      {/* Delete Alert */}
      <AlertDialog open={!!deleteId} onOpenChange={(open) => !open && setDeleteId(null)}>
        <AlertDialogContent className="rounded-2xl">
            <AlertDialogHeader>
                <AlertDialogTitle>Delete Record?</AlertDialogTitle>
                <AlertDialogDescription>
                    This action cannot be undone. This financial record will be permanently removed.
                </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter>
                <AlertDialogCancel className="rounded-full">Cancel</AlertDialogCancel>
                <AlertDialogAction className="bg-rose-600 hover:bg-rose-700 rounded-full" onClick={() => deleteId && deleteLaborCostMutation.mutate(deleteId)}>
                    Delete
                </AlertDialogAction>
            </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
}


===== leave-management.tsx =====
import { useState, useMemo } from "react";
import { useAuth } from "@/hooks/use-auth";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { apiRequest } from "@/lib/queryClient";
import { toast } from "sonner";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger, DialogFooter } from "@/components/ui/dialog";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { insertLeaveRequestSchema } from "@shared/schema";
import { z } from "zod";
import {   Loader2, Calendar, Clock, Plus, Check, X, Activity, AlertCircle, User } from "lucide-react";
import type { LeaveRequest, User as UserType } from "@shared/schema";

const leaveFormSchema = insertLeaveRequestSchema.extend({
  startDate: z.string().min(1, "Start date is required")
    .refine((date) => {
      const selectedDate = new Date(date);
      const today = new Date();
      today.setHours(0, 0, 0, 0); 
      
      const minDate = new Date(today);
      minDate.setDate(today.getDate() + 7); 
      
      return selectedDate >= minDate;
    }, "Start date must be at least 1 week from today"),
  endDate: z.string().min(1, "End date is required"),
}).omit({ userId: true }).refine((data) => {
  const start = new Date(data.startDate);
  const end = new Date(data.endDate);
  return end >= start;
}, {
  message: "End date must be on or after start date",
  path: ["endDate"],
});

type LeaveForm = z.infer<typeof leaveFormSchema>;

const rejectFormSchema = z.object({
  comments: z.string().min(10, "A detailed reason (at least 10 characters) is required for rejection"),
});
type RejectForm = z.infer<typeof rejectFormSchema>;

const getMinStartDate = () => {
  const date = new Date();
  date.setDate(date.getDate() + 7);
  return date.toISOString().split('T')[0];
};

export default function LeaveManagement() {
  const { user } = useAuth();
  const queryClient = useQueryClient();
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const [isRejectDialogOpen, setIsRejectDialogOpen] = useState(false);
  const [rejectionRequestId, setRejectionRequestId] = useState<string | null>(null);

  const { data: leaveRequests, isLoading } = useQuery<LeaveRequest[]>({
    queryKey: ["/api/leave-requests"],
  });

  const { data: pendingRequests, isLoading: pendingLoading } = useQuery<LeaveRequest[]>({
    queryKey: ["/api/leave-requests/pending"],
    enabled: user?.role === 'manager' || user?.role === 'admin',
  });

  const { data: users } = useQuery<UserType[]>({
    queryKey: ["/api/users/"],
    queryFn: async () => {
      const res = await apiRequest("GET", "/api/users/"); 
      return res.json();
    }
  });

  const userMap = useMemo(() => {
    if (!users) return new Map<string, string>();
    return users.reduce((map, user) => {
      map.set(user.id, `${user.firstName} ${user.lastName}`);
      return map;
    }, new Map<string, string>());
  }, [users]);

  const getUserName = (userId: string) => userMap.get(userId) || "Unknown User";

  const form = useForm<LeaveForm>({
    resolver: zodResolver(leaveFormSchema),
    defaultValues: {
      type: "annual",
      startDate: "",
      endDate: "",
      days: 1,
      reason: "",
    },
  });

  const rejectForm = useForm<RejectForm>({
    resolver: zodResolver(rejectFormSchema),
    defaultValues: { comments: "" },
  });
    
  const createLeaveRequestMutation = useMutation({
    mutationFn: async (data: LeaveForm) => {
      const startDate = new Date(data.startDate);
      const endDate = new Date(data.endDate);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const oneWeekFromNow = new Date(today);
      oneWeekFromNow.setDate(today.getDate() + 7);

      if (startDate < oneWeekFromNow) throw new Error("Start date must be at least 1 week from today");
      if (endDate < startDate) throw new Error("End date must be on or after start date");

      const days = Math.ceil((endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24)) + 1;

      const res = await apiRequest("POST", "/api/leave-requests", {
        ...data,
        startDate,
        endDate,
        days,
      });
      return await res.json();
    },
    onSuccess: () => {
      toast.success("Leave request submitted", { description: "Your leave request has been submitted for approval." });
      queryClient.invalidateQueries({ queryKey: ["/api/leave-requests"] });
      setIsDialogOpen(false);
      form.reset();
    },
    onError: (error: Error) => {
      toast.error("Submission failed", { description: error.message });
    },
  });

  const approveLeaveRequestMutation = useMutation({
    mutationFn: async ({ id, status, comments }: { id: string; status: string; comments?: string }) => {
      const res = await apiRequest("PATCH", `/api/leave-requests/${id}`, { status, comments });
      return await res.json();
    },
    onSuccess: (data, variables) => {
      toast.success(`Leave request ${variables.status}`, { description: `The leave request has been ${variables.status} successfully.` });
      queryClient.invalidateQueries({ queryKey: ["/api/leave-requests/pending"] });
      queryClient.invalidateQueries({ queryKey: ["/api/leave-requests"] });

      if (variables.status === 'rejected') {
        setIsRejectDialogOpen(false);
        setRejectionRequestId(null);
        rejectForm.reset();
      }
    },
    onError: (error: Error) => {
      toast.error("Update failed", { description: error.message });
    },
  });

  const onSubmit = (data: LeaveForm) => createLeaveRequestMutation.mutate(data);
  const handleApprove = (id: string) => approveLeaveRequestMutation.mutate({ id, status: "approved" });
  const handleReject = (id: string) => {
    setRejectionRequestId(id);
    setIsRejectDialogOpen(true);
  };
  const onRejectSubmit = (data: RejectForm) => {
    if (rejectionRequestId) {
        approveLeaveRequestMutation.mutate({ id: rejectionRequestId, status: "rejected", comments: data.comments });
    }
  };

  const getStatusBadge = (status: string) => {
    switch (status) {
      case "approved": return <Badge className="bg-emerald-100 text-emerald-700 border-emerald-200 hover:bg-emerald-200">Approved</Badge>;
      case "rejected": return <Badge className="bg-rose-100 text-rose-700 border-rose-200 hover:bg-rose-200">Rejected</Badge>;
      default: return <Badge className="bg-amber-100 text-amber-700 border-amber-200 hover:bg-amber-200">Pending</Badge>;
    }
  };

  const formatDate = (date: string | Date) => new Date(date).toLocaleDateString();
  const canManageLeaves = user?.role === 'manager' || user?.role === 'admin';
  const pendingCount = pendingRequests?.filter(req => req.status === 'pending').length || 0;

  return (
    <div className="p-6 md:p-8 space-y-8">
      {/* Header Section */}
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h1 className="text-3xl font-bold tracking-tight text-slate-900" data-testid="page-title">Leave Management</h1>
          <p className="text-slate-500 mt-1 text-sm">Manage your leave requests and view balances</p>
        </div>
        <Dialog open={isDialogOpen} onOpenChange={(open) => { setIsDialogOpen(open); if (!open) form.reset(); }}>
          <DialogTrigger asChild>
            <Button className="bg-slate-900 hover:bg-slate-800 text-white shadow-lg shadow-slate-900/20 rounded-full px-6" data-testid="button-apply-leave">
              <Plus className="w-4 h-4 mr-2" /> Apply for Leave
            </Button>
          </DialogTrigger>
          <DialogContent className="max-w-lg rounded-2xl">
            <DialogHeader>
              <DialogTitle className="text-xl">Apply for Leave</DialogTitle>
              <DialogDescription>Submit a new request for time off</DialogDescription>
            </DialogHeader>
            <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-5 mt-2">
              <div className="space-y-2">
                <Label htmlFor="type">Leave Type</Label>
                <Select onValueChange={(value) => form.setValue("type", value)} defaultValue="annual">
                  <SelectTrigger className="rounded-xl border-slate-200" data-testid="select-leave-type"><SelectValue /></SelectTrigger>
                  <SelectContent className="rounded-xl">
                    <SelectItem value="annual">Service Incentive Leave</SelectItem>
                    <SelectItem value="sick">Additional Leave Benefit</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="startDate">Start Date</Label>
                  <Input id="startDate" type="date" className="rounded-xl border-slate-200" min={getMinStartDate()} {...form.register("startDate")} data-testid="input-start-date" />
                  {form.formState.errors.startDate && <p className="text-xs text-red-500">{form.formState.errors.startDate.message}</p>}
                </div>
                <div className="space-y-2">
                  <Label htmlFor="endDate">End Date</Label>
                  <Input id="endDate" type="date" className="rounded-xl border-slate-200" min={form.watch("startDate")} {...form.register("endDate")} data-testid="input-end-date" />
                  {form.formState.errors.endDate && <p className="text-xs text-red-500">{form.formState.errors.endDate.message}</p>}
                </div>
              </div>
              <div className="space-y-2">
                <Label htmlFor="reason">Reason (Optional)</Label>
                <Textarea id="reason" className="rounded-xl border-slate-200 resize-none" rows={3} {...form.register("reason")} placeholder="Why are you taking leave?" data-testid="input-reason" />
              </div>
              <div className="flex justify-end gap-2 pt-2">
                <Button type="button" variant="outline" onClick={() => setIsDialogOpen(false)} className="rounded-full">Cancel</Button>
                <Button type="submit" disabled={createLeaveRequestMutation.isPending} className="rounded-full bg-slate-900" data-testid="button-submit-leave">
                  {createLeaveRequestMutation.isPending ? "Submitting..." : "Submit Request"}
                </Button>
              </div>
            </form>
          </DialogContent>
        </Dialog>
      </div>

      {/* Bento Stats - Leave Balances */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <Card className="bg-white/60 backdrop-blur-xl border-slate-200/60 shadow-sm rounded-2xl overflow-hidden">
          <CardContent className="p-6">
            <div className="flex items-center justify-between mb-4">
              <p className="text-xs font-bold text-slate-500 uppercase tracking-wider">Service Incentive</p>
              <div className="p-2 bg-blue-100 rounded-lg text-blue-600"><Calendar className="w-4 h-4" /></div>
            </div>
            <div className="flex items-baseline gap-1">
              <h3 className="text-3xl font-bold text-slate-800">{user?.annualLeaveBalance ?? 0}</h3>
              <span className="text-sm text-slate-400 font-medium">/ {user?.annualLeaveBalanceLimit ?? 0} days</span>
            </div>
            <div className="mt-4 h-2 w-full bg-slate-100 rounded-full overflow-hidden">
              <div className="h-full bg-blue-500 rounded-full transition-all duration-500" style={{ width: `${Math.min(100, ((user?.annualLeaveBalance || 0) / (user?.annualLeaveBalanceLimit || 1)) * 100)}%` }} />
            </div>
          </CardContent>
        </Card>

        <Card className="bg-white/60 backdrop-blur-xl border-slate-200/60 shadow-sm rounded-2xl overflow-hidden">
          <CardContent className="p-6">
            <div className="flex items-center justify-between mb-4">
              <p className="text-xs font-bold text-slate-500 uppercase tracking-wider">Additional Benefit</p>
              <div className="p-2 bg-rose-100 rounded-lg text-rose-600"><Activity className="w-4 h-4" /></div>
            </div>
            <div className="flex items-baseline gap-1">
              <h3 className="text-3xl font-bold text-slate-800">{user?.sickLeaveBalance ?? 0}</h3>
              <span className="text-sm text-slate-400 font-medium">/ {user?.sickLeaveBalanceLimit ?? 0} days</span>
            </div>
            <div className="mt-4 h-2 w-full bg-slate-100 rounded-full overflow-hidden">
              <div className="h-full bg-rose-500 rounded-full transition-all duration-500" style={{ width: `${Math.min(100, ((user?.sickLeaveBalance || 0) / (user?.sickLeaveBalanceLimit || 1)) * 100)}%` }} />
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Tabs Section */}
      <Tabs defaultValue="my-requests" className="w-full">
        <div className="flex items-center mb-6">
          <TabsList className="bg-white/40 backdrop-blur-md border border-slate-200/50 p-1 rounded-full h-auto" data-testid="leave-tabs">
            <TabsTrigger value="my-requests" className="rounded-full px-4 py-2 data-[state=active]:bg-white data-[state=active]:shadow-sm" data-testid="tab-my-requests">My Requests</TabsTrigger>
            {canManageLeaves && (
              <TabsTrigger value="pending" className="rounded-full px-4 py-2 data-[state=active]:bg-white data-[state=active]:shadow-sm" data-testid="tab-pending">
                Pending Approvals
                {pendingCount > 0 && <Badge className="ml-2 bg-rose-500 hover:bg-rose-600 border-none text-white h-5 px-1.5 rounded-full">{pendingCount}</Badge>}
              </TabsTrigger>
            )}
          </TabsList>
        </div>

        <TabsContent value="my-requests" className="mt-0 focus-visible:outline-none">
          <div className="space-y-4">
            {isLoading ? (
               <div className="text-center py-12"><Loader2 className="w-8 h-8 animate-spin mx-auto text-slate-300" /></div>
            ) : leaveRequests && leaveRequests.length > 0 ? (
               <div className="grid gap-4">
                 {leaveRequests.map((request) => (
                   <div key={request.id} className="group flex flex-col sm:flex-row sm:items-center justify-between p-5 rounded-2xl bg-white/60 hover:bg-white border border-slate-200/60 hover:border-blue-200/60 shadow-sm hover:shadow-md transition-all" data-testid={`request-${request.id}`}>
                      <div className="flex items-start gap-4">
                         <div className="h-12 w-12 rounded-2xl bg-blue-50 flex items-center justify-center text-blue-600 shadow-sm">
                            {request.type === 'annual' ? <Calendar className="w-6 h-6" /> : <Activity className="w-6 h-6" />}
                         </div>
                         <div className="space-y-1">
                            <h4 className="font-semibold text-slate-800">{request.type === 'annual' ? 'Service Incentive' : 'Additional Benefit'} Leave</h4>
                            <div className="flex flex-wrap gap-2 text-sm text-slate-500">
                               <span className="font-medium text-slate-700">{formatDate(request.startDate)} - {formatDate(request.endDate)}</span>
                               <span className="px-1.5 py-0.5 rounded-md bg-slate-100 text-xs font-mono">{request.days} days</span>
                            </div>
                            {request.reason && <p className="text-sm text-slate-500 mt-1 italic">"{request.reason}"</p>}
                            {request.status === 'rejected' && request.comments && (
                               <p className="text-sm text-rose-600 mt-1 font-medium bg-rose-50 p-2 rounded-lg inline-block">Reason: {request.comments}</p>
                            )}
                         </div>
                      </div>
                      <div className="mt-4 sm:mt-0 flex flex-row sm:flex-col items-center sm:items-end justify-between gap-2">
                         {getStatusBadge(request.status!)}
                         <span className="text-xs text-slate-400">Applied {formatDate(request.createdAt!)}</span>
                      </div>
                   </div>
                 ))}
               </div>
            ) : (
               <div className="text-center py-20 bg-white/40 border border-dashed border-slate-200 rounded-3xl">
                  <Calendar className="w-12 h-12 text-slate-300 mx-auto mb-3" />
                  <p className="text-slate-500">No leave requests history.</p>
               </div>
            )}
          </div>
        </TabsContent>

        {canManageLeaves && (
          <TabsContent value="pending" className="mt-0 focus-visible:outline-none">
             {pendingLoading ? (
                <div className="text-center py-12"><Loader2 className="w-8 h-8 animate-spin mx-auto text-slate-300" /></div>
             ) : (
                <div className="space-y-4">
                  {pendingRequests?.filter(r => r.status === 'pending').length === 0 ? (
                     <div className="text-center py-20 bg-white/40 border border-dashed border-slate-200 rounded-3xl">
                        <Clock className="w-12 h-12 text-slate-300 mx-auto mb-3" />
                        <p className="text-slate-500">All caught up! No pending approvals.</p>
                     </div>
                  ) : (
                    pendingRequests?.filter(r => r.status === 'pending').map((request) => (
                      <div key={request.id} className="group flex flex-col md:flex-row md:items-center justify-between p-5 rounded-2xl bg-white border border-amber-100 shadow-sm hover:shadow-md transition-all" data-testid={`pending-request-${request.id}`}>
                         <div className="flex items-start gap-4">
                            <div className="h-12 w-12 rounded-full bg-amber-50 flex items-center justify-center text-amber-600 shrink-0">
                               <User className="w-6 h-6" />
                            </div>
                            <div className="space-y-1">
                               <h4 className="font-bold text-slate-800 text-lg">{getUserName(request.userId)}</h4>
                               <p className="text-sm text-slate-600">
                                 Requested <span className="font-semibold text-amber-700">{request.type === 'annual' ? 'Service Incentive' : 'Additional'} Leave</span> for <span className="font-semibold">{request.days} days</span>
                               </p>
                               <p className="text-sm text-slate-500 flex items-center gap-2">
                                  <Calendar className="w-3.5 h-3.5" /> {formatDate(request.startDate)} - {formatDate(request.endDate)}
                               </p>
                               {request.reason && <p className="text-sm text-slate-500 bg-slate-50 p-2 rounded-lg mt-2">"{request.reason}"</p>}
                            </div>
                         </div>
                         <div className="mt-4 md:mt-0 flex items-center gap-3 pl-16 md:pl-0">
                            <Button size="sm" onClick={() => handleApprove(request.id)} disabled={approveLeaveRequestMutation.isPending} className="bg-emerald-600 hover:bg-emerald-700 rounded-full shadow-lg shadow-emerald-600/20" data-testid={`button-approve-${request.id}`}>
                               <Check className="w-4 h-4 mr-2" /> Approve
                            </Button>
                            <Button size="sm" variant="outline" onClick={() => handleReject(request.id)} disabled={approveLeaveRequestMutation.isPending} className="border-rose-200 text-rose-700 hover:bg-rose-50 rounded-full" data-testid={`button-reject-${request.id}`}>
                               <X className="w-4 h-4 mr-2" /> Reject
                            </Button>
                         </div>
                      </div>
                    ))
                  )}
                </div>
             )}
          </TabsContent>
        )}
      </Tabs>

      {/* Reject Dialog */}
      <Dialog open={isRejectDialogOpen} onOpenChange={(open) => { setIsRejectDialogOpen(open); if (!open) { setRejectionRequestId(null); rejectForm.reset(); }}}>
        <DialogContent className="rounded-2xl">
            <DialogHeader>
                <DialogTitle className="text-rose-600">Reject Request</DialogTitle>
                <DialogDescription>Provide a reason for rejecting this request.</DialogDescription>
            </DialogHeader>
            <form onSubmit={rejectForm.handleSubmit(onRejectSubmit)} className="space-y-4">
                <Textarea {...rejectForm.register("comments")} placeholder="Reason for rejection..." className="rounded-xl resize-none" rows={3} data-testid="input-reject-comments" />
                {rejectForm.formState.errors.comments && <p className="text-xs text-rose-600">{rejectForm.formState.errors.comments.message}</p>}
                <DialogFooter>
                    <Button type="button" variant="outline" onClick={() => setIsRejectDialogOpen(false)} className="rounded-full">Cancel</Button>
                    <Button type="submit" variant="destructive" className="rounded-full" data-testid="button-confirm-reject">Confirm Rejection</Button>
                </DialogFooter>
            </form>
        </DialogContent>
      </Dialog>
    </div>
  );
}


===== not-found.tsx =====
import { Card, CardContent } from "@/components/ui/card";
import { AlertCircle, Home } from "lucide-react";
import { Link } from "wouter";
import { Button } from "@/components/ui/button";

export default function NotFound() {
  return (
    <div className="min-h-screen w-full flex items-center justify-center bg-gradient-to-br from-slate-50 via-white to-slate-100 text-slate-900 relative overflow-hidden">
      
      {/* Decorative Background Elements */}
      <div className="absolute top-1/4 left-1/4 w-96 h-96 bg-blue-500/5 rounded-full blur-[100px] pointer-events-none" />
      <div className="absolute bottom-1/4 right-1/4 w-96 h-96 bg-rose-500/5 rounded-full blur-[100px] pointer-events-none" />

      <Card className="w-full max-w-md mx-4 bg-white/60 backdrop-blur-xl border-slate-200/60 shadow-2xl rounded-3xl relative z-10">
        <CardContent className="pt-12 pb-12 px-8 text-center">
          <div className="h-24 w-24 bg-rose-50 rounded-[2rem] flex items-center justify-center mx-auto mb-8 shadow-sm border border-rose-100 transform rotate-3 hover:rotate-0 transition-transform duration-500 ease-out">
            <AlertCircle className="h-10 w-10 text-rose-500" />
          </div>
          
          <h1 className="text-3xl font-bold text-slate-900 mb-3 tracking-tight">Page Not Found</h1>
          
          <p className="text-slate-500 text-sm leading-relaxed mb-8 max-w-xs mx-auto">
            The page you are looking for doesn't exist, has been moved, or you do not have permission to view it.
          </p>

          <Link href="/">
            <Button className="rounded-full bg-slate-900 hover:bg-slate-800 text-white shadow-lg shadow-slate-900/20 px-8 h-12 font-medium transition-all hover:scale-105 active:scale-95">
               <Home className="w-4 h-4 mr-2" />
               Return to Dashboard
            </Button>
          </Link>
        </CardContent>
      </Card>
    </div>
  );
}


===== payslip-history.tsx =====
import React, { useState, useEffect, useMemo } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { useAuth } from "@/hooks/use-auth";
import { toast } from "sonner";
import { 
  Table, TableBody, TableCell, TableHead, TableHeader, TableRow 
} from "@/components/ui/table";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { 
  Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogFooter 
} from "@/components/ui/dialog";
import { 
  AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle 
} from "@/components/ui/alert-dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Loader2, Pencil, Trash2, ChevronDown, ChevronRight, Eye, Filter, Search } from "lucide-react";
import type { Payslip } from "@shared/schema";
import { computeSSS, computePhilHealth, computePagIbig, HOURLY_RATE, OT_MULTIPLIER, ND_MULTIPLIER } from "@/utils/salary_computation";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";

// Helper for display rounding
const round2 = (num: number) => Math.round(num * 100) / 100;

export default function PayslipHistory() {
  const { user } = useAuth();
  const queryClient = useQueryClient();

  const currentYear = new Date().getFullYear();

  const [isEditOpen, setIsEditOpen] = useState(false);
  const [isViewOpen, setIsViewOpen] = useState(false);
  const [isDeleteOpen, setIsDeleteOpen] = useState(false);
  const [selectedPayslip, setSelectedPayslip] = useState<Payslip | null>(null);
  const [expandedGroups, setExpandedGroups] = useState<Record<string, boolean>>({});
  
  // Filters
  const [filterMonth, setFilterMonth] = useState<string>("all");
  const [filterYear, setFilterYear] = useState<string>(currentYear.toString());
  const [searchTerm, setSearchTerm] = useState("");

  // State for the edit form
  const [editForm, setEditForm] = useState({
    regularHours: 0,
    overtimeHours: 0,
    nightDiffHours: 0,
    bonuses: 0,
    otherAllowances: 0,
    otherDeductions: 0,
    basicSalary: 0,
    overtimePay: 0,
    nightDiffPay: 0,
    grossPay: 0,
    sss: 0,
    philHealth: 0,
    pagIbig: 0,
    tax: 0,
    netPay: 0
  });

  // Fetch ALL payslips
  const { data: payslips, isLoading } = useQuery({
    queryKey: ["/api/payslips", { all: true }],
    queryFn: async () => {
       const res = await fetch("/api/payslips?all=true");
       if (!res.ok) throw new Error("Failed to fetch payslips");
       return res.json();
    }
  });

  // FIX: Added queryFn to fetch team members
  const { data: teamMembers } = useQuery({ 
    queryKey: ["/api/team"],
    queryFn: async () => {
        const res = await fetch("/api/team");
        if (!res.ok) throw new Error("Failed to fetch team members");
        return res.json();
    }
  });

  // --- Mutations ---
  const updatePayslipMutation = useMutation({
    mutationFn: async ({ id, data }: { id: number; data: any }) => {
      const res = await fetch(`/api/payslips/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      if(!res.ok) throw new Error("Failed to update");
      return res.json();
    },
    onSuccess: () => {
      toast.success("Updated", { description: "Payslip updated successfully" });
      queryClient.invalidateQueries({ queryKey: ["/api/payslips"] });
      setIsEditOpen(false);
    },
    onError: (error: Error) => {
        toast.error("Update Failed", { description: error.message });
    }
  });

  const deletePayslipMutation = useMutation({
    mutationFn: async (id: number) => {
      const res = await fetch(`/api/payslips/${id}`, { method: "DELETE" });
      if(!res.ok) throw new Error("Failed to delete");
      return res.json();
    },
    onSuccess: () => {
      toast.success("Deleted", { description: "Payslip deleted successfully" });
      queryClient.invalidateQueries({ queryKey: ["/api/payslips"] });
      setIsDeleteOpen(false);
    },
    onError: (error: Error) => {
        toast.error("Delete Failed", { description: error.message });
    }
  });

  // --- Helpers ---
  const getEmployeeName = (id: string) => {
    // If it's the current user
    if (user && String(user.id) === String(id)) return `${user.firstName} ${user.lastName} (You)`;
    
    // Look up in team members
    const emp = teamMembers?.find((m: any) => String(m.id) === String(id));
    return emp ? `${emp.firstName} ${emp.lastName}` : `User ${id}`;
  };

  // --- Auto-Calculation Effect for Edit ---
  // This ensures that when you change hours/bonuses in the UI, the gross/net/deductions update automatically
  
  useEffect(() => {
    if (!isEditOpen) return;

    const basicSalary = round2(editForm.regularHours * HOURLY_RATE);
    const overtimePay = round2(editForm.overtimeHours * (HOURLY_RATE * OT_MULTIPLIER));
    const nightDiffPay = round2(editForm.nightDiffHours * (HOURLY_RATE * ND_MULTIPLIER));
    
    const grossPay = round2(basicSalary + overtimePay + nightDiffPay + editForm.bonuses + editForm.otherAllowances);

    // Re-calculate government deductions based on new basic salary
    const sss = round2(computeSSS(basicSalary)); 
    const philHealth = round2(computePhilHealth(basicSalary)); 
    const pagIbig = round2(computePagIbig(basicSalary)); 
    
    // Default tax to 0 or keep existing logic (simplified here)
    const tax = editForm.tax; 

    const totalDeductions = round2(sss + philHealth + pagIbig + tax + editForm.otherDeductions);
    const netPay = Math.max(0, round2(grossPay - totalDeductions));

    setEditForm(prev => ({
      ...prev,
      basicSalary,
      overtimePay,
      nightDiffPay,
      grossPay,
      sss,
      philHealth,
      pagIbig,
      netPay
    }));
  }, [
    editForm.regularHours, 
    editForm.overtimeHours, 
    editForm.nightDiffHours, 
    editForm.bonuses, 
    editForm.otherAllowances, 
    editForm.otherDeductions,
    editForm.tax,
    isEditOpen
  ]);

  // --- Handlers ---
  const handleEdit = (payslip: any) => {
    setSelectedPayslip(payslip);
    
    const allowances = payslip.allowances || {};
    const deductions = payslip.deductions || {};

    // Convert from cents (Integers) to Currency (Floats) for the form
    const basicVal = payslip.basicSalary / 100;
    const otVal = (allowances.overtime || 0) / 100;
    const ndVal = (allowances.nightDiff || 0) / 100;

    const regularHours = basicVal / HOURLY_RATE;
    const overtimeHours = otVal / (HOURLY_RATE * OT_MULTIPLIER);
    const nightDiffHours = ndVal / (HOURLY_RATE * ND_MULTIPLIER);

    setEditForm({
        regularHours: round2(regularHours),
        overtimeHours: round2(overtimeHours),
        nightDiffHours: round2(nightDiffHours),
        bonuses: (allowances.bonuses || 0) / 100,
        otherAllowances: (allowances.otherAllowances || allowances.allowances || 0) / 100,
        otherDeductions: (deductions.others || 0) / 100,
        basicSalary: basicVal,
        overtimePay: otVal,
        nightDiffPay: ndVal,
        grossPay: payslip.grossPay / 100,
        sss: (deductions.sss || 0) / 100,
        philHealth: (deductions.philHealth || 0) / 100,
        pagIbig: (deductions.pagIbig || 0) / 100,
        tax: (deductions.tax || 0) / 100,
        netPay: payslip.netPay / 100
    });
    setIsEditOpen(true);
  };

  const handleView = (payslip: any) => {
    setSelectedPayslip(payslip);
    setIsViewOpen(true);
  };

  const handleSaveEdit = () => {
    if(!selectedPayslip) return;
    
    // Pack data back into cents (Integers) for the API
    const payload = {
        basicSalary: Math.round(editForm.basicSalary * 100),
        allowances: {
            ...(selectedPayslip.allowances as object),
            overtime: Math.round(editForm.overtimePay * 100),
            nightDiff: Math.round(editForm.nightDiffPay * 100),
            bonuses: Math.round(editForm.bonuses * 100),
            otherAllowances: Math.round(editForm.otherAllowances * 100),
        },
        deductions: {
            ...(selectedPayslip.deductions as object),
            sss: Math.round(editForm.sss * 100),
            philHealth: Math.round(editForm.philHealth * 100),
            pagIbig: Math.round(editForm.pagIbig * 100),
            tax: Math.round(editForm.tax * 100),
            others: Math.round(editForm.otherDeductions * 100),
        },
        grossPay: Math.round(editForm.grossPay * 100),
        netPay: Math.round(editForm.netPay * 100)
    };
    
    updatePayslipMutation.mutate({ id: selectedPayslip.id, data: payload });
  };

  const handleDelete = (payslip: Payslip) => {
    setSelectedPayslip(payslip);
    setIsDeleteOpen(true);
  };

  // --- Grouping Logic ---
  const groupedPayslips = useMemo(() => {
    if (!payslips) return [];

    // 1. Filter
    const filtered = payslips.filter((slip: Payslip) => {
        const matchMonth = filterMonth === "all" || slip.month.toString() === filterMonth;
        const matchYear = filterYear === "all" || slip.year.toString() === filterYear;
        const name = getEmployeeName(String(slip.userId)).toLowerCase();
        const matchSearch = name.includes(searchTerm.toLowerCase());
        return matchMonth && matchYear && matchSearch;
    });

    // 2. Group by User+Month+Year
    const groups: Record<string, any> = {};

    filtered.forEach((slip: Payslip) => {
        const key = `${slip.userId}-${slip.month}-${slip.year}`;
        if (!groups[key]) {
            groups[key] = {
                id: key,
                userId: slip.userId,
                month: slip.month,
                year: slip.year,
                slips: [],
                totalGross: 0,
                totalNet: 0,
                totalDeductions: 0,
                totalRegHours: 0,
                totalOTHours: 0,
                totalNDHours: 0,
                deductions: { sss: 0, philHealth: 0, pagIbig: 0, tax: 0, others: 0 }
            };
        }
        
        const basic = slip.basicSalary / 100;
        const allowances = slip.allowances as any || {};
        const deductions = slip.deductions as any || {};
        
        const ot = (allowances.overtime || 0) / 100;
        const nd = (allowances.nightDiff || 0) / 100;

        groups[key].totalRegHours += basic / HOURLY_RATE;
        groups[key].totalOTHours += ot / (HOURLY_RATE * OT_MULTIPLIER);
        groups[key].totalNDHours += nd / (HOURLY_RATE * ND_MULTIPLIER);

        groups[key].deductions.sss += (deductions.sss || 0);
        groups[key].deductions.philHealth += (deductions.philHealth || 0);
        groups[key].deductions.pagIbig += (deductions.pagIbig || 0);
        groups[key].deductions.tax += (deductions.tax || 0);
        groups[key].deductions.others += (deductions.others || 0);

        groups[key].slips.push(slip);
        groups[key].totalGross += slip.grossPay;
        groups[key].totalNet += slip.netPay;
        groups[key].totalDeductions += (slip.grossPay - slip.netPay);
    });

    return Object.values(groups).sort((a: any, b: any) => {
        if (a.year !== b.year) return b.year - a.year;
        return b.month - a.month;
    });
  }, [payslips, filterMonth, filterYear, searchTerm, teamMembers]);

  const toggleGroup = (key: string) => {
    setExpandedGroups(prev => ({ ...prev, [key]: !prev[key] }));
  };

  if(isLoading) return <div className="p-8 flex justify-center"><Loader2 className="animate-spin" /></div>;

  return (
    <div className="p-6 md:p-8 max-w-7xl mx-auto space-y-8">
      <div className="mb-6 flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h1 className="text-3xl font-bold tracking-tight text-slate-900">Payslip History</h1>
          <p className="text-slate-500 mt-1 text-sm">View and manage generated payslips.</p>
        </div>
        
        {/* Filters */}
        <div className="flex items-center gap-4 bg-white/80 backdrop-blur-md p-2 rounded-2xl border border-slate-200/60 shadow-sm">
            <div className="relative w-full max-w-[200px]">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400" />
                <Input 
                    placeholder="Search..." 
                    className="pl-9 h-8 border-none bg-transparent focus:ring-0"
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                />
            </div>
            <div className="w-px h-4 bg-slate-200" />
            <div className="flex items-center gap-2 px-2">
                <Filter className="w-4 h-4 text-slate-400" />
                <Select value={filterMonth} onValueChange={setFilterMonth}>
                    <SelectTrigger className="w-[110px] h-8 border-none bg-transparent shadow-none text-xs font-medium"><SelectValue placeholder="Month" /></SelectTrigger>
                    <SelectContent>
                        <SelectItem value="all">All Months</SelectItem>
                        {Array.from({ length: 12 }, (_, i) => (
                            <SelectItem key={i + 1} value={(i + 1).toString()}>{new Date(0, i).toLocaleString('default', { month: 'long' })}</SelectItem>
                        ))}
                    </SelectContent>
                </Select>
                <Select value={filterYear} onValueChange={setFilterYear}>
                    <SelectTrigger className="w-[80px] h-8 border-none bg-transparent shadow-none text-xs font-medium"><SelectValue placeholder="Year" /></SelectTrigger>
                    <SelectContent>
                        <SelectItem value="all">All Years</SelectItem>
                        {[currentYear - 1, currentYear, currentYear + 1].map((yr) => (<SelectItem key={yr} value={yr.toString()}>{yr}</SelectItem>))}
                    </SelectContent>
                </Select>
            </div>
        </div>
      </div>

      <Card className="glass-card">
        <CardContent className="p-0">
          <div className="overflow-x-auto">
            <table className="w-full text-sm text-left">
              <thead className="bg-slate-50/50 border-b border-slate-200/60">
                <tr>
                  <th className="w-[50px] px-4 py-3"></th>
                  <th className="px-4 py-3 font-semibold text-slate-500 uppercase tracking-wider text-xs">Employee</th>
                  <th className="px-4 py-3 font-semibold text-slate-500 uppercase tracking-wider text-xs">Month</th>
                  <th className="px-4 py-3 font-semibold text-slate-500 uppercase tracking-wider text-xs text-right">Total Gross</th>
                  <th className="px-4 py-3 font-semibold text-slate-500 uppercase tracking-wider text-xs text-right text-rose-600">Total Deductions</th>
                  <th className="px-4 py-3 font-semibold text-slate-500 uppercase tracking-wider text-xs text-right text-emerald-600">Total Net Pay</th>
                  <th className="px-4 py-3 font-semibold text-slate-500 uppercase tracking-wider text-xs text-center">Actions</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-100">
                {groupedPayslips.map((group: any) => (
                  <React.Fragment key={group.id}>
                    {/* Group Header Row */}
                    <TableRow className="bg-slate-50/50 hover:bg-slate-100/80 cursor-pointer transition-colors border-l-4 border-l-transparent hover:border-l-primary/40" onClick={() => toggleGroup(group.id)}>
                        <TableCell className="text-center">
                            {expandedGroups[group.id] ? <ChevronDown className="w-4 h-4" /> : <ChevronRight className="w-4 h-4" />}
                        </TableCell>
                        <TableCell className="font-semibold text-slate-800">{getEmployeeName(group.userId)}</TableCell>
                        <TableCell className="font-medium text-slate-600">{group.month}/{group.year}</TableCell>
                        <TableCell className="text-right font-medium text-slate-700">â±{(group.totalGross / 100).toLocaleString(undefined, { minimumFractionDigits: 2 })}</TableCell>
                        <TableCell className="text-right font-medium text-rose-600">-â±{(group.totalDeductions / 100).toLocaleString(undefined, { minimumFractionDigits: 2 })}</TableCell>
                        <TableCell className="text-right font-bold text-emerald-700">â±{(group.totalNet / 100).toLocaleString(undefined, { minimumFractionDigits: 2 })}</TableCell>
                        <TableCell></TableCell>
                    </TableRow>
                    
                    {/* Expanded Content */}
                    {expandedGroups[group.id] && (
                        <>
                            {/* Summary Statistics Row */}
                            <TableRow className="bg-slate-50/30">
                                <TableCell></TableCell>
                                <TableCell colSpan={6} className="p-4">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm border border-slate-200/60 p-5 rounded-2xl bg-white/60 shadow-sm">
                                        <div>
                                            <h4 className="font-semibold text-slate-800 mb-3 pb-2 border-b border-slate-100 flex items-center gap-2">
                                                <Pencil className="w-4 h-4 text-blue-500" /> Monthly Hours
                                            </h4>
                                            <div className="grid grid-cols-2 gap-y-2">
                                                <span className="text-slate-500">Regular:</span>
                                                <span className="font-medium text-slate-700 text-right">{round2(group.totalRegHours)} hrs</span>
                                                <span className="text-slate-500">Overtime:</span>
                                                <span className="font-medium text-slate-700 text-right">{round2(group.totalOTHours)} hrs</span>
                                                <span className="text-slate-500">Night Diff:</span>
                                                <span className="font-medium text-slate-700 text-right">{round2(group.totalNDHours)} hrs</span>
                                            </div>
                                        </div>
                                        <div>
                                            <h4 className="font-semibold text-slate-800 mb-3 pb-2 border-b border-slate-100 flex items-center gap-2">
                                                <Trash2 className="w-4 h-4 text-rose-500" /> Monthly Deductions
                                            </h4>
                                            <div className="grid grid-cols-2 gap-y-2">
                                                <span className="text-slate-500">SSS:</span>
                                                <span className="font-medium text-slate-700 text-right">â±{(group.deductions.sss / 100).toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>
                                                <span className="text-slate-500">PhilHealth:</span>
                                                <span className="font-medium text-slate-700 text-right">â±{(group.deductions.philHealth / 100).toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>
                                                <span className="text-slate-500">Pag-IBIG:</span>
                                                <span className="font-medium text-slate-700 text-right">â±{(group.deductions.pagIbig / 100).toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>
                                                {group.deductions.others > 0 && (
                                                    <>
                                                        <span className="text-slate-500">Others:</span>
                                                        <span className="font-medium text-slate-700 text-right">â±{(group.deductions.others / 100).toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>
                                                    </>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </TableCell>
                            </TableRow>

                            {/* Detailed Slip Rows */}
                            {group.slips.map((slip: Payslip) => (
                                <TableRow key={slip.id} className="bg-white hover:bg-gray-50 transition-colors border-b border-gray-100">
                                    <TableCell></TableCell>
                                    <TableCell className="pl-10 text-slate-500 text-sm border-l-4 border-l-transparent hover:border-l-primary/20">
                                        {slip.period === 1 ? '1st Half (1-15)' : '2nd Half (16-End)'}
                                    </TableCell>
                                    <TableCell className="text-slate-400 text-xs"></TableCell>
                                    <TableCell className="text-right text-slate-600 text-sm font-mono">â±{(slip.grossPay / 100).toLocaleString(undefined, { minimumFractionDigits: 2 })}</TableCell>
                                    <TableCell className="text-right text-rose-500 text-sm font-mono">-â±{((slip.grossPay - slip.netPay) / 100).toLocaleString(undefined, { minimumFractionDigits: 2 })}</TableCell>
                                    <TableCell className="text-right text-emerald-600 font-bold text-sm font-mono">â±{(slip.netPay / 100).toLocaleString(undefined, { minimumFractionDigits: 2 })}</TableCell>
                                    <TableCell className="text-center">
                                        <div className="flex justify-center gap-2">
                                            <Button variant="ghost" size="icon" className="h-8 w-8 hover:text-emerald-600 hover:bg-emerald-50 rounded-full" onClick={(e) => { e.stopPropagation(); handleView(slip); }} title="View Details">
                                                <Eye className="w-4 h-4" />
                                            </Button>
                                            <Button variant="ghost" size="icon" className="h-8 w-8 hover:text-blue-600 hover:bg-blue-50 rounded-full" onClick={(e) => { e.stopPropagation(); handleEdit(slip); }} title="Edit">
                                                <Pencil className="w-4 h-4" />
                                            </Button>
                                            <Button variant="ghost" size="icon" className="h-8 w-8 hover:text-red-600 hover:bg-red-50 rounded-full" onClick={(e) => { e.stopPropagation(); handleDelete(slip); }} title="Delete">
                                                <Trash2 className="w-4 h-4" />
                                            </Button>
                                        </div>
                                    </TableCell>
                                </TableRow>
                            ))}
                        </>
                    )}
                  </React.Fragment>
              ))}
              {(!groupedPayslips || groupedPayslips.length === 0) && (
                <TableRow>
                    <TableCell colSpan={7} className="text-center py-16 text-slate-400">
                        No payslips found matching your filters.
                    </TableCell>
                </TableRow>
              )}
            </tbody >
            </table>
          </div>
        </CardContent>
      </Card>

      {/* View Dialog (Read-Only) */}
      <Dialog open={isViewOpen} onOpenChange={setIsViewOpen}>
        <DialogContent className="max-w-2xl rounded-2xl">
            <DialogHeader>
                <DialogTitle>Payslip Details</DialogTitle>
                <DialogDescription>
                   Detailed breakdown for {selectedPayslip && getEmployeeName(String(selectedPayslip.userId))}
                </DialogDescription>
            </DialogHeader>
            {selectedPayslip && (
             <div className="grid gap-6 py-4">
                <div className="grid grid-cols-2 gap-8 p-4 bg-slate-50 rounded-xl border border-slate-100">
                   <div>
                     <h3 className="font-medium text-sm text-slate-500 uppercase tracking-wider border-b pb-2 mb-3">Earnings</h3>
                     <div className="space-y-2 text-sm">
                         <div className="flex justify-between"><span className="text-slate-600">Basic Salary</span><span className="font-medium">â±{(selectedPayslip.basicSalary / 100).toLocaleString()}</span></div>
                         <div className="flex justify-between"><span className="text-slate-600">Overtime</span><span className="font-medium">â±{((selectedPayslip.allowances?.overtime || 0) / 100).toLocaleString()}</span></div>
                         <div className="flex justify-between"><span className="text-slate-600">Night Diff</span><span className="font-medium">â±{((selectedPayslip.allowances?.nightDiff || 0) / 100).toLocaleString()}</span></div>
                         {selectedPayslip.allowances?.bonuses > 0 && <div className="flex justify-between"><span className="text-slate-600">Bonuses</span><span className="font-medium">â±{(selectedPayslip.allowances.bonuses / 100).toLocaleString()}</span></div>}
                         {selectedPayslip.allowances?.otherAllowances > 0 && <div className="flex justify-between"><span className="text-slate-600">Allowances</span><span className="font-medium">â±{(selectedPayslip.allowances.otherAllowances / 100).toLocaleString()}</span></div>}
                         <div className="pt-2 border-t flex justify-between font-bold text-slate-800"><span>Total Gross</span><span>â±{(selectedPayslip.grossPay / 100).toLocaleString()}</span></div>
                     </div>
                   </div>
                   <div>
                      <h3 className="font-medium text-sm text-slate-500 uppercase tracking-wider border-b pb-2 mb-3">Deductions</h3>
                      <div className="space-y-2 text-sm">
                          <div className="flex justify-between"><span className="text-slate-600">SSS</span><span className="font-medium">â±{((selectedPayslip.deductions?.sss || 0) / 100).toLocaleString()}</span></div>
                          <div className="flex justify-between"><span className="text-slate-600">PhilHealth</span><span className="font-medium">â±{((selectedPayslip.deductions?.philHealth || 0) / 100).toLocaleString()}</span></div>
                          <div className="flex justify-between"><span className="text-slate-600">Pag-IBIG</span><span className="font-medium">â±{((selectedPayslip.deductions?.pagIbig || 0) / 100).toLocaleString()}</span></div>
                          {selectedPayslip.deductions?.others > 0 && <div className="flex justify-between"><span className="text-slate-600">Others</span><span className="font-medium">â±{((selectedPayslip.deductions?.others || 0) / 100).toLocaleString()}</span></div>}
                          <div className="pt-2 border-t flex justify-between font-bold text-rose-600"><span>Total Deductions</span><span>-â±{((selectedPayslip.grossPay - selectedPayslip.netPay) / 100).toLocaleString()}</span></div>
                       </div>
                   </div>
                </div>
                <div className="flex justify-between items-center p-4 bg-green-50 border border-green-100 rounded-xl">
                   <span className="text-sm font-bold text-green-800 uppercase tracking-wide">Net Pay</span>
                   <span className="text-2xl font-bold text-green-700">â±{(selectedPayslip.netPay / 100).toLocaleString()}</span>
                </div>
             </div>
            )}
            <DialogFooter>
                <Button onClick={() => setIsViewOpen(false)} className="rounded-full">Close</Button>
            </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Edit Dialog */}
      <Dialog open={isEditOpen} onOpenChange={setIsEditOpen}>
        <DialogContent className="max-w-3xl rounded-2xl">
            <DialogHeader>
                <DialogTitle>Edit Payslip Details</DialogTitle>
                <DialogDescription>
                    Adjust hours and other amounts. Tax and Government contributions are auto-calculated.
                </DialogDescription>
            </DialogHeader>
            <div className="grid gap-6 py-4">
                <div className="grid grid-cols-2 gap-6">
                    {/* Left Column: Inputs */}
                    <div className="space-y-4">
                        <h3 className="font-medium text-sm text-slate-500 uppercase tracking-wider border-b border-slate-100 pb-2">Hours & Adjustments</h3>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <Label className="text-xs text-slate-500">Reg Hours</Label>
                                <Input type="number" className="rounded-xl border-slate-200" value={editForm.regularHours} onChange={e => setEditForm({...editForm, regularHours: Math.max(0, parseFloat(e.target.value) || 0)})} />
                            </div>
                            <div>
                                <Label className="text-xs text-slate-500">OT Hours</Label>
                                <Input type="number" className="rounded-xl border-slate-200" value={editForm.overtimeHours} onChange={e => setEditForm({...editForm, overtimeHours: Math.max(0, parseFloat(e.target.value) || 0)})} />
                            </div>
                            <div>
                                <Label className="text-xs text-slate-500">ND Hours</Label>
                                <Input type="number" className="rounded-xl border-slate-200" value={editForm.nightDiffHours} onChange={e => setEditForm({...editForm, nightDiffHours: Math.max(0, parseFloat(e.target.value) || 0)})} />
                            </div>
                            <div>
                                <Label className="text-xs text-slate-500">Bonuses</Label>
                                <Input type="number" className="rounded-xl border-slate-200" value={editForm.bonuses} onChange={e => setEditForm({...editForm, bonuses: Math.max(0, parseFloat(e.target.value) || 0)})} />
                            </div>
                            <div className="col-span-2">
                                <Label className="text-xs text-slate-500">Other Allowances</Label>
                                <Input type="number" className="rounded-xl border-slate-200" value={editForm.otherAllowances} onChange={e => setEditForm({...editForm, otherAllowances: Math.max(0, parseFloat(e.target.value) || 0)})} />
                            </div>
                            <div className="col-span-2">
                                <Label className="text-xs text-slate-500">Other Deductions</Label>
                                <Input type="number" className="rounded-xl border-slate-200" value={editForm.otherDeductions} onChange={e => setEditForm({...editForm, otherDeductions: Math.max(0, parseFloat(e.target.value) || 0)})} />
                            </div>
                             <div className="col-span-2">
                                <Label className="text-xs text-slate-500">Tax</Label>
                                <Input type="number" className="rounded-xl border-slate-200" value={editForm.tax} onChange={e => setEditForm({...editForm, tax: Math.max(0, parseFloat(e.target.value) || 0)})} />
                            </div>
                        </div>
                    </div>

                    {/* Right Column: Computed Values */}
                    <div className="space-y-4 bg-slate-50/80 p-5 rounded-2xl border border-slate-100">
                         <h3 className="font-medium text-sm text-slate-500 uppercase tracking-wider border-b border-slate-200 pb-2">Calculated Summary</h3>
                         <div className="space-y-2 text-sm">
                            <div className="flex justify-between"><span className="text-slate-500">Basic Salary:</span><span className="font-medium text-slate-700">â±{editForm.basicSalary.toLocaleString()}</span></div>
                            <div className="flex justify-between"><span className="text-slate-500">Overtime Pay:</span><span className="font-medium text-slate-700">â±{editForm.overtimePay.toLocaleString()}</span></div>
                            <div className="flex justify-between"><span className="text-slate-500">Night Diff:</span><span className="font-medium text-slate-700">â±{editForm.nightDiffPay.toLocaleString()}</span></div>
                            <div className="flex justify-between pt-2 border-t border-slate-200 font-bold"><span>Gross Pay:</span><span>â±{editForm.grossPay.toLocaleString()}</span></div>

                            <div className="pt-2 space-y-1">
                                <div className="flex justify-between text-xs text-rose-600"><span>SSS:</span><span>-{editForm.sss.toLocaleString()}</span></div>
                                <div className="flex justify-between text-xs text-rose-600"><span>PhilHealth:</span><span>-{editForm.philHealth.toLocaleString()}</span></div>
                                <div className="flex justify-between text-xs text-rose-600"><span>Pag-IBIG:</span><span>-{editForm.pagIbig.toLocaleString()}</span></div>
                                <div className="flex justify-between text-xs text-rose-600"><span>Tax:</span><span>-{editForm.tax.toLocaleString()}</span></div>
                                <div className="flex justify-between text-xs text-rose-600"><span>Other Ded:</span><span>-{editForm.otherDeductions.toLocaleString()}</span></div>
                            </div>

                            <div className="flex justify-between pt-4 border-t border-slate-200 text-lg font-bold text-emerald-600">
                                <span>Net Pay:</span><span>â±{editForm.netPay.toLocaleString()}</span>
                            </div>
                         </div>
                    </div>
                </div>
            </div>
            <DialogFooter>
                <Button variant="outline" onClick={() => setIsEditOpen(false)} className="rounded-full">Cancel</Button>
                <Button onClick={handleSaveEdit} className="rounded-full bg-slate-900 hover:bg-slate-800">Save Changes</Button>
            </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Delete Alert */}
      <AlertDialog open={isDeleteOpen} onOpenChange={setIsDeleteOpen}>
        <AlertDialogContent className="rounded-2xl">
            <AlertDialogHeader>
                <AlertDialogTitle>Delete Payslip?</AlertDialogTitle>
                <AlertDialogDescription>
                    This action cannot be undone. The record for <strong>{selectedPayslip && getEmployeeName(String(selectedPayslip.userId))}</strong> will be permanently removed.
                </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter>
                <AlertDialogCancel className="rounded-full">Cancel</AlertDialogCancel>
                <AlertDialogAction className="bg-rose-600 hover:bg-rose-700 rounded-full" onClick={() => selectedPayslip && deletePayslipMutation.mutate(selectedPayslip.id)}>
                    Delete
                </AlertDialogAction>
            </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
}


===== payslip-management.tsx =====
import React, { useState, useEffect, useMemo } from 'react';
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { useAuth } from "@/hooks/use-auth";
import { toast } from "sonner";
import { format } from "date-fns";
import { Search, Edit2, Loader2, CalendarDays, Users, FileCheck, Clock, Filter, Calculator, Moon, Flame, Calendar, Briefcase } from 'lucide-react';
import { HOURLY_RATE, OT_MULTIPLIER, ND_MULTIPLIER, computeSSS, computePhilHealth, computePagIbig } from "../utils/salary_computation"; 
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Card, CardContent, CardHeader } from "@/components/ui/card";
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { BentoCard } from "@/components/custom/bento-card"; 

// Helper for consistent rounding
const round2 = (num: number) => Math.round(num * 100) / 100;

export default function PayrollManagement() {
  const { user } = useAuth();
  const queryClient = useQueryClient();

  // --- State ---
  const currentYear = new Date().getFullYear();
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedPeriod, setSelectedPeriod] = useState({ 
    month: new Date().getMonth() + 1, 
    year: currentYear,
    half: 1 
  });
  
  const [editingId, setEditingId] = useState<string | null>(null);
  const [isEditOpen, setIsEditOpen] = useState(false);
  const [isConfirmOpen, setIsConfirmOpen] = useState(false);
  
  const [attendanceViewerId, setAttendanceViewerId] = useState<string | null>(null);

  const [editForm, setEditForm] = useState({
    regularHours: 0,
    overtimeHours: 0,
    nightDiffHours: 0,
    bonuses: 0,
    otherAllowances: 0,
    otherDeductions: 0,
    basicSalary: 0,
    grossPay: 0,
    sss: 0,
    philHealth: 0,
    pagIbig: 0,
    tax: 0,
    netPay: 0,
    overtimePay: 0,
    nightDiffPay: 0
  });

  // --- Data Fetching ---
  const { data: teamMembers, isLoading: isLoadingTeam } = useQuery({
    queryKey: ["/api/team"],
  });

  const { data: existingPayslips, isLoading: isLoadingPayslips } = useQuery({
    queryKey: ["/api/payslips", "all", selectedPeriod.month, selectedPeriod.year, selectedPeriod.half],
    queryFn: async () => {
       // FIX: Changed from /api/payslips/all to /api/payslips?all=true
       const res = await fetch(`/api/payslips?all=true`);
       if (!res.ok) throw new Error("Failed");
       const allPayslips = await res.json();
       return allPayslips.filter((p: any) => 
         Number(p.month) === Number(selectedPeriod.month) && 
         Number(p.year) === Number(selectedPeriod.year)
       );
    }
  });

  const { startDate, endDate } = useMemo(() => {
    const year = Number(selectedPeriod.year);
    const monthIndex = Number(selectedPeriod.month) - 1; 
    let start, end;
    if (Number(selectedPeriod.half) === 1) {
        start = new Date(year, monthIndex, 1);
        end = new Date(year, monthIndex, 15, 23, 59, 59);
    } else {
        start = new Date(year, monthIndex, 16);
        end = new Date(year, monthIndex + 1, 0, 23, 59, 59);
    }
    return { startDate: start.toISOString(), endDate: end.toISOString() };
  }, [selectedPeriod]);

  const { data: attendanceData, isLoading: isLoadingAttendance } = useQuery({
    queryKey: ["/api/attendance/all", startDate, endDate],
    queryFn: async () => { 
        const res = await fetch(`/api/attendance/all?startDate=${startDate}&endDate=${endDate}`);
        if (!res.ok) throw new Error("Failed");
        return res.json();
    } 
  });

  // --- Logic Helpers ---
  const getNightDiffHours = (timeIn: string | number, timeOut: string | number) => {
    let start = new Date(timeIn);
    let end = new Date(timeOut);
    let ndHours = 0;
    let current = new Date(start);
    current.setMinutes(0, 0, 0); 
    if (current.getTime() < start.getTime()) current.setHours(current.getHours() + 1);

    while (current.getTime() < end.getTime()) {
        const h = current.getHours();
        if (h >= 22 || h < 6) ndHours += 1;
        current.setHours(current.getHours() + 1);
    }
    return ndHours;
  };

  const processAttendanceForUser = (userId: string, records: any[]) => {
    if (!records) return { regularHours: 0, overtimeHours: 0, nightDiffHours: 0 };
    const userRecords = records.filter((r: any) => r.userId === userId);
    let totalRegMinutes = 0, totalOTMinutes = 0, totalNDHours = 0;

    userRecords.forEach((record: any) => {
        if (record.timeOut && record.totalWorkMinutes) {
            const workMinutes = record.totalWorkMinutes || 0;

            if (workMinutes > 480) {
                totalRegMinutes += 480;
                totalOTMinutes += (workMinutes - 480);
            } else {
                totalRegMinutes += workMinutes;
            }
            totalNDHours += getNightDiffHours(record.timeIn, record.timeOut);
        }
    });

    return { 
        regularHours: parseFloat((totalRegMinutes / 60).toFixed(2)), 
        overtimeHours: parseFloat((totalOTMinutes / 60).toFixed(2)), 
        nightDiffHours: totalNDHours 
    };
  };

  // --- Mutations ---
  const savePayslipMutation = useMutation({
    mutationFn: async ({ url, method, data }: { url: string, method: string, data: any }) => {
      const res = await fetch(url, {
        method: method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      if(!res.ok) throw new Error("Failed to save");
      return res.json();
    },
    onSuccess: () => {
      toast.success("Success", { description: "Payslip processed successfully." });
      queryClient.invalidateQueries({ queryKey: ["/api/payslips"] });
      setEditingId(null);
      setIsConfirmOpen(false);
      setIsEditOpen(false);
    }
  });

  const getExistingPayslip = (userId: string) => {
      if (!existingPayslips) return undefined;
      return existingPayslips.find((p: any) => 
        p.userId === userId && 
        (Number(p.period) === Number(selectedPeriod.half) || (!p.period && Number(selectedPeriod.half) === 1))
      );
  };

  const handleEdit = (employee: any) => {
    setEditingId(employee.id);
    setIsEditOpen(true);

    const existingSlip = getExistingPayslip(employee.id);

    if (existingSlip) {
        const basic = existingSlip.basicSalary / 100;
        const allowances = existingSlip.allowances || {};
        const deductions = existingSlip.deductions || {};
        const regHours = basic / HOURLY_RATE;
        const otHours = (allowances.overtime || 0) / 100 / (HOURLY_RATE * OT_MULTIPLIER);
        const ndHours = (allowances.nightDiff || 0) / 100 / (HOURLY_RATE * ND_MULTIPLIER);

        setEditForm({
            regularHours: round2(regHours),
            overtimeHours: round2(otHours),
            nightDiffHours: round2(ndHours),
            bonuses: (allowances.bonuses || 0) / 100,
            otherAllowances: (allowances.otherAllowances || allowances.allowances || 0) / 100,
            otherDeductions: (deductions.others || 0) / 100,
            basicSalary: basic,
            overtimePay: (allowances.overtime || 0) / 100,
            nightDiffPay: (allowances.nightDiff || 0) / 100,
            grossPay: existingSlip.grossPay / 100,
            sss: (deductions.sss || 0) / 100,
            philHealth: (deductions.philHealth || 0) / 100,
            pagIbig: (deductions.pagIbig || 0) / 100,
            tax: (deductions.tax || 0) / 100,
            netPay: existingSlip.netPay / 100
        });
    } else {
        // FIX: Replaced fetchStatsMutation with local processing
        // Since we already have attendanceData loaded in useQuery, we process it locally
        const stats = processAttendanceForUser(employee.id, attendanceData || []);
        
        setEditForm({
            regularHours: stats.regularHours,
            overtimeHours: stats.overtimeHours,
            nightDiffHours: stats.nightDiffHours,
            bonuses: 0,
            otherAllowances: 0,
            otherDeductions: 0,
            basicSalary: 0,
            grossPay: 0,
            sss: 0,
            philHealth: 0,
            pagIbig: 0,
            tax: 0,
            netPay: 0,
            overtimePay: 0,
            nightDiffPay: 0
        });
    }
  };

  // --- Auto-Calculation Effect (Replaces API Calc) ---
  useEffect(() => {
    if (!isEditOpen) return;

    // 1. Calculate Earnings
    const basicSalary = round2(editForm.regularHours * HOURLY_RATE);
    const overtimePay = round2(editForm.overtimeHours * (HOURLY_RATE * OT_MULTIPLIER));
    const nightDiffPay = round2(editForm.nightDiffHours * (HOURLY_RATE * ND_MULTIPLIER));
    const grossPay = round2(basicSalary + overtimePay + nightDiffPay + editForm.bonuses + editForm.otherAllowances);

    // 2. Calculate Deductions (Locally using imported helpers)
    let previousDeductions = { sss: 0, philHealth: 0, pagIbig: 0 };
    
    // Logic: If 2nd half, check if deductions were already paid in 1st half
    if (Number(selectedPeriod.half) === 2 && existingPayslips && editingId) {
        const slip1 = existingPayslips.find((p: any) => 
            p.userId === editingId && (Number(p.period) === 1 || !p.period)
        );
        if (slip1 && slip1.deductions) {
            const d = slip1.deductions as any;
            previousDeductions = {
                sss: (d.sss || 0) / 100,
                philHealth: (d.philHealth || 0) / 100,
                pagIbig: (d.pagIbig || 0) / 100
            };
        }
    }

    // Calculate statutory (Simple Logic: Computed - Previous Paid)
    // Note: computeSSS/PH/PagIbig usually takes total monthly compensation. 
    // If calculating per cutoff, you might need to adjust inputs, but here we assume helpers handle logic based on input.
    const sss = Math.max(0, round2(computeSSS(grossPay) - previousDeductions.sss));
    const philHealth = Math.max(0, round2(computePhilHealth(basicSalary) - previousDeductions.philHealth));
    const pagIbig = Math.max(0, round2(computePagIbig(basicSalary) - previousDeductions.pagIbig));
    
    // Tax placeholder (Assuming 0 for now as no helper was imported, or user manually edits)
    const tax = editForm.tax; 
    
    const totalDeductions = round2(sss + philHealth + pagIbig + tax + editForm.otherDeductions);
    const netPay = round2(grossPay - totalDeductions);

    // Update State (Debounced slightly to prevent jitter if needed, but safe here)
    setEditForm(prev => ({
        ...prev,
        basicSalary,
        overtimePay,
        nightDiffPay,
        grossPay,
        sss,
        philHealth,
        pagIbig,
        netPay
    }));

  }, [
    editForm.regularHours, editForm.overtimeHours, editForm.nightDiffHours, 
    editForm.bonuses, editForm.otherAllowances, editForm.otherDeductions, editForm.tax,
    selectedPeriod.half, editingId
  ]);

  const handleConfirmSave = async () => {
    if (!editingId) return;
    const payload = {
      userId: editingId,
      month: selectedPeriod.month,
      year: selectedPeriod.year,
      period: selectedPeriod.half, 
      basicSalary: Math.round(editForm.basicSalary * 100),
      allowances: {
        overtime: Math.round(editForm.overtimePay * 100),
        nightDiff: Math.round(editForm.nightDiffPay * 100),
        allowances: Math.round(editForm.otherAllowances * 100),
        bonuses: Math.round(editForm.bonuses * 100),
      },
      deductions: {
        tax: Math.round(editForm.tax * 100),
        sss: Math.round(editForm.sss * 100),
        philHealth: Math.round(editForm.philHealth * 100),
        pagIbig: Math.round(editForm.pagIbig * 100),
        others: Math.round(editForm.otherDeductions * 100),
      },
      grossPay: Math.round(editForm.grossPay * 100),
      netPay: Math.round(editForm.netPay * 100)
    };

    const existingSlip = getExistingPayslip(editingId);
    if (existingSlip) {
        savePayslipMutation.mutate({ url: `/api/payslips/${existingSlip.id}`, method: "PATCH", data: payload });
    } else {
        savePayslipMutation.mutate({ url: "/api/payslips", method: "POST", data: payload });
    }
  };

  const processedEmployees = useMemo(() => {
    if (!teamMembers) return [];
    const onlyEmployees = teamMembers.filter((m: any) => m.role === 'employee' ); 
    return onlyEmployees.map((emp: any) => {
      const slip = getExistingPayslip(emp.id);
      return { ...emp, payslipStatus: slip ? 'generated' : 'pending', lastPay: slip };
    });
  }, [teamMembers, existingPayslips, selectedPeriod]);

  const filteredEmployees = processedEmployees.filter((emp: any) =>
    `${emp.firstName} ${emp.lastName}`.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const stats = {
    totalEmployees: filteredEmployees.length,
    generated: filteredEmployees.filter(e => e.payslipStatus === 'generated').length,
    pending: filteredEmployees.filter(e => e.payslipStatus === 'pending').length
  };

  const editingEmployeeName = useMemo(() => {
    if (!editingId || !teamMembers) return "";
    const emp = teamMembers.find((m: any) => m.id === editingId);
    return emp ? `${emp.firstName} ${emp.lastName}` : "Employee";
  }, [editingId, teamMembers]);

  // Viewer Logic
  const viewingEmployeeData = useMemo(() => {
    if (!attendanceViewerId || !teamMembers) return null;
    return teamMembers.find((m:any) => m.id === attendanceViewerId);
  }, [attendanceViewerId, teamMembers]);

  const viewingEmployeeRecords = useMemo(() => {
    if (!attendanceViewerId || !attendanceData) return [];
    return attendanceData.filter((r: any) => r.userId === attendanceViewerId)
        .sort((a: any, b: any) => new Date(a.date).getTime() - new Date(b.date).getTime());
  }, [attendanceViewerId, attendanceData]);

  // FIX: Don't subtract break again, totalWorkMinutes is already net
  const viewerTotals = useMemo(() => {
      return viewingEmployeeRecords.reduce((acc: any, record: any) => {
          const workMinutes = record.totalWorkMinutes || 0;
          const breakMinutes = record.totalBreakMinutes || 0;
          
          const otMins = Math.max(0, workMinutes - 480);
          const regMins = workMinutes - otMins;
          const ndHrs = getNightDiffHours(record.timeIn, record.timeOut);
          
          return {
              regMinutes: acc.regMinutes + regMins,
              otMinutes: acc.otMinutes + otMins,
              ndHours: acc.ndHours + ndHrs,
              breakMinutes: acc.breakMinutes + breakMinutes,
              totalMinutes: acc.totalMinutes + workMinutes
          };
      }, { regMinutes: 0, otMinutes: 0, ndHours: 0, breakMinutes: 0, totalMinutes: 0 });
  }, [viewingEmployeeRecords]);

  const currentNetPay = useMemo(() => {
    return editForm.netPay;
  }, [editForm]);

  const formatTime = (ts: number) => format(new Date(ts), "h:mm a");
  const formatDate = (ts: number) => format(new Date(ts), "MMM d");
  const formatDuration = (minutes: number | null) => {
    if (minutes === null || minutes === undefined) return "-";
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;
    return h > 0 ? `${h}h ${m}m` : `${m}m`;
  };

  if (isLoadingTeam || isLoadingAttendance || isLoadingPayslips) return <div className="min-h-screen flex items-center justify-center"><Loader2 className="animate-spin" /></div>;

  return (
    <div className="p-6 md:p-8 max-w-7xl mx-auto space-y-8">
      {/* Header, Stats, Filter */}
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h1 className="text-3xl font-bold tracking-tight text-slate-900" data-testid="page-title">Payroll Generator</h1>
          <p className="text-slate-500 mt-1 text-sm">Process employee salaries and deductions</p>
        </div>
        <div className="flex items-center gap-4 bg-white/80 backdrop-blur-md p-2 rounded-2xl border border-slate-200/60 shadow-sm">
            <div className="flex items-center gap-2 px-2">
                <Filter className="w-4 h-4 text-slate-400" />
                <Select value={selectedPeriod.month.toString()} onValueChange={(val) => setSelectedPeriod(prev => ({ ...prev, month: parseInt(val) }))}>
                    <SelectTrigger className="w-[110px] h-8 border-none bg-transparent shadow-none text-xs font-medium"><SelectValue /></SelectTrigger>
                    <SelectContent>
                        {Array.from({ length: 12 }, (_, i) => (
                            <SelectItem key={i + 1} value={(i + 1).toString()}>{new Date(0, i).toLocaleString('default', { month: 'long' })}</SelectItem>
                        ))}
                    </SelectContent>
                </Select>
            </div>
            <div className="w-px h-4 bg-slate-200" />
            <Select value={selectedPeriod.year.toString()} onValueChange={(val) => setSelectedPeriod(prev => ({ ...prev, year: parseInt(val) }))}>
                <SelectTrigger className="w-[80px] h-8 border-none bg-transparent shadow-none text-xs font-medium"><SelectValue /></SelectTrigger>
                <SelectContent>
                    {[currentYear - 1, currentYear, currentYear + 1].map((yr) => (<SelectItem key={yr} value={yr.toString()}>{yr}</SelectItem>))}
                </SelectContent>
            </Select>
            <div className="w-px h-4 bg-slate-200" />
            <Select value={selectedPeriod.half.toString()} onValueChange={(val) => setSelectedPeriod(prev => ({ ...prev, half: parseInt(val) }))}>
                <SelectTrigger className="w-[100px] h-8 border-none bg-transparent shadow-none text-xs font-medium"><SelectValue /></SelectTrigger>
                <SelectContent>
                    <SelectItem value="1">1st Half</SelectItem>
                    <SelectItem value="2">2nd Half</SelectItem>
                </SelectContent>
            </Select>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <BentoCard title="Total Employees" value={stats.totalEmployees} icon={Users} variant="default" testIdPrefix="stat-total" />
        <BentoCard title="Generated" value={stats.generated} icon={FileCheck} variant="emerald" testIdPrefix="stat-generated" />
        <BentoCard title="Pending" value={stats.pending} icon={Clock} variant="amber" testIdPrefix="stat-pending" />
      </div>

      <Card className="glass-card">
        <CardHeader className="px-6 py-4 border-b border-slate-100 bg-white/50">
             <div className="relative w-full max-w-sm">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400" />
                <Input 
                    placeholder="Search employees..." 
                    className="pl-9 bg-white/60 border-slate-200/60 focus:bg-white rounded-xl transition-all"
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                />
             </div>
        </CardHeader>
        <CardContent className="p-0">
          <div className="overflow-x-auto">
            <table className="w-full text-sm text-left">
              <thead className="bg-slate-50/50 border-b border-slate-200/60">
                <tr>
                  <th className="px-6 py-4 font-semibold text-slate-500 uppercase tracking-wider text-xs">Employee</th>
                  <th className="px-6 py-4 font-semibold text-slate-500 uppercase tracking-wider text-xs text-center">Hours Detail</th>
                  <th className="px-6 py-4 font-semibold text-slate-500 uppercase tracking-wider text-xs text-right">Gross</th>
                  <th className="px-6 py-4 font-semibold text-slate-500 uppercase tracking-wider text-xs text-right">Deductions</th>
                  <th className="px-6 py-4 font-semibold text-slate-500 uppercase tracking-wider text-xs text-right">Net Pay</th>
                  <th className="px-6 py-4 font-semibold text-slate-500 uppercase tracking-wider text-xs text-center">Actions</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-100">
                {filteredEmployees.map((employee: any) => {
                  let computed = processAttendanceForUser(employee.id, attendanceData || []);
                  let viewBasic = 0, viewOT = 0, viewND = 0, viewGross = 0, viewNet = 0, viewTotalDeductions = 0;

                  if (employee.lastPay) {
                      const lp = employee.lastPay;
                      const allowances = lp.allowances || {};
                      viewBasic = lp.basicSalary / 100 / HOURLY_RATE;
                      viewOT = (allowances.overtime || 0) / 100 / (HOURLY_RATE * OT_MULTIPLIER);
                      viewND = (allowances.nightDiff || 0) / 100 / (HOURLY_RATE * ND_MULTIPLIER);
                      viewGross = lp.grossPay / 100;
                      viewNet = lp.netPay / 100;
                      viewTotalDeductions = (lp.grossPay - lp.netPay) / 100;
                  } else {
                      viewBasic = computed.regularHours;
                      viewOT = computed.overtimeHours;
                      viewND = computed.nightDiffHours;
                      let viewCalcBase = round2((viewBasic * HOURLY_RATE) + (viewOT * HOURLY_RATE * OT_MULTIPLIER) + (viewND * HOURLY_RATE * ND_MULTIPLIER));
                      viewGross = viewCalcBase;
                      
                      let prevDeduc = { sss: 0, philHealth: 0, pagIbig: 0 };
                      if (selectedPeriod.half === 2 && existingPayslips) {
                          const slip1 = existingPayslips.find((p: any) => p.userId === employee.id && (Number(p.period) === 1 || !p.period));
                          if (slip1) {
                              viewCalcBase += (slip1.grossPay / 100);
                              if (slip1.deductions) {
                                  const d = slip1.deductions as any;
                                  prevDeduc = { sss: (d.sss || 0) / 100, philHealth: (d.philHealth || 0) / 100, pagIbig: (d.pagIbig || 0) / 100 };
                              }
                          }
                      }
                      const vSSS = Math.max(0, round2(computeSSS(viewCalcBase) - prevDeduc.sss));
                      const vPH = Math.max(0, round2(computePhilHealth(viewCalcBase) - prevDeduc.philHealth));
                      const vHDMF = Math.max(0, round2(computePagIbig(viewCalcBase) - prevDeduc.pagIbig));
                      viewTotalDeductions = vSSS + vPH + vHDMF;
                      viewNet = Math.max(0, viewGross - viewTotalDeductions);
                  }
                  
                  return (
                    <tr key={employee.id} className="hover:bg-white/60 transition-colors group">
                      <td className="px-6 py-4 align-top">
                        <div className="font-medium text-slate-900">{employee.firstName} {employee.lastName}</div>
                        <div className="text-xs text-slate-500">{employee.position}</div>
                      </td>
                      <td className="px-6 py-4 align-top">
                          <div className="bg-slate-50 rounded-lg p-2 border border-slate-100 space-y-1.5 min-w-[140px] group-hover:border-slate-200 transition-colors relative">
                             <div className="flex justify-between items-center text-xs">
                                <span className="text-slate-500">Regular</span>
                                <span className="font-mono font-medium text-slate-700">{viewBasic.toFixed(2)}h</span>
                             </div>
                             {(viewOT > 0) && (
                                <div className="flex justify-between items-center text-xs">
                                    <span className="text-amber-600/90 font-medium">Overtime</span>
                                    <span className="font-mono font-bold text-amber-600">{viewOT.toFixed(2)}h</span>
                                </div>
                             )}
                             {(viewND > 0) && (
                                <div className="flex justify-between items-center text-xs">
                                    <span className="text-indigo-600/90 font-medium">Night Diff</span>
                                    <span className="font-mono font-bold text-indigo-600">{viewND.toFixed(2)}h</span>
                                </div>
                             )}
                             <div className="pt-2 mt-1 border-t border-slate-100 flex justify-center">
                                <button onClick={() => setAttendanceViewerId(employee.id)} className="text-[10px] font-medium text-slate-500 hover:text-slate-800 flex items-center gap-1 transition-colors px-2 py-0.5 rounded hover:bg-slate-100 w-full justify-center">
                                    <Clock className="w-3 h-3" /> View Logs
                                </button>
                             </div>
                          </div>
                      </td>
                      <td className="px-6 py-4 text-right align-top pt-6"><div className="text-sm font-bold text-slate-800">â±{viewGross.toLocaleString(undefined, { minimumFractionDigits: 2 })}</div></td>
                      <td className="px-6 py-4 text-right align-top pt-6"><div className="text-sm font-bold text-rose-600">-â±{viewTotalDeductions.toLocaleString(undefined, { minimumFractionDigits: 2 })}</div></td>
                      <td className="px-6 py-4 text-right font-bold text-emerald-600 text-lg align-top pt-5">{viewNet.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
                      <td className="px-6 py-4 text-center align-top pt-5">
                            <button onClick={() => handleEdit(employee)} className={`px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-2 mx-auto transition-all ${employee.payslipStatus === 'generated' ? "text-blue-600 bg-blue-50 hover:bg-blue-100 border border-blue-200" : "text-slate-600 bg-white border border-slate-200 hover:bg-slate-50 shadow-sm" }`}>
                                {employee.payslipStatus === 'generated' ? <Edit2 className="w-3 h-3" /> : <Calculator className="w-3 h-3" />}
                                {employee.payslipStatus === 'generated' ? 'Update' : 'Generate'}
                            </button>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </CardContent>
      </Card>

      {/* Attendance Detail Dialog */}
      <Dialog open={!!attendanceViewerId} onOpenChange={(open) => !open && setAttendanceViewerId(null)}>
        <DialogContent className="max-w-5xl rounded-3xl p-0 overflow-hidden">
            <div className="bg-slate-50/50 p-6 border-b border-slate-100 flex flex-col gap-4">
                <div className="flex items-center justify-between">
                    <div>
                        <DialogTitle className="text-xl font-bold text-slate-900">
                            {viewingEmployeeData ? `${viewingEmployeeData.firstName} ${viewingEmployeeData.lastName}` : "Attendance Logs"}
                        </DialogTitle>
                        <DialogDescription className="mt-1 flex items-center gap-2">
                            <Calendar className="w-3.5 h-3.5" /> 
                            {new Date(0, selectedPeriod.month - 1).toLocaleString('default', { month: 'long' })} {selectedPeriod.year} 
                            <span className="text-slate-300 mx-1">|</span>
                            <Briefcase className="w-3.5 h-3.5" />
                            {selectedPeriod.half === 1 ? "1st Half (1-15)" : "2nd Half (16-End)"}
                        </DialogDescription>
                    </div>
                    <div className="flex gap-2">
                        <div className="px-3 py-2 bg-white border border-slate-200 rounded-xl shadow-sm flex flex-col items-center min-w-[70px]">
                            <span className="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Regular</span>
                            <span className="text-lg font-bold text-slate-700">{(viewerTotals.regMinutes / 60).toFixed(1)}h</span>
                        </div>
                        <div className="px-3 py-2 bg-amber-50 border border-amber-100 rounded-xl shadow-sm flex flex-col items-center min-w-[70px]">
                            <span className="text-[10px] uppercase font-bold text-amber-500 tracking-wider">OT</span>
                            <span className="text-lg font-bold text-amber-700">{(viewerTotals.otMinutes / 60).toFixed(1)}h</span>
                        </div>
                        <div className="px-3 py-2 bg-indigo-50 border border-indigo-100 rounded-xl shadow-sm flex flex-col items-center min-w-[70px]">
                            <span className="text-[10px] uppercase font-bold text-indigo-500 tracking-wider">ND</span>
                            <span className="text-lg font-bold text-indigo-700">{viewerTotals.ndHours.toFixed(1)}h</span>
                        </div>
                         <div className="px-3 py-2 bg-slate-50 border border-slate-200 rounded-xl shadow-sm flex flex-col items-center min-w-[70px]">
                            <span className="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Break</span>
                            <span className="text-lg font-bold text-slate-600">{(viewerTotals.breakMinutes / 60).toFixed(1)}h</span>
                        </div>
                        <div className="px-3 py-2 bg-emerald-50 border border-emerald-100 rounded-xl shadow-sm flex flex-col items-center min-w-[70px]">
                            <span className="text-[10px] uppercase font-bold text-emerald-600 tracking-wider">Net</span>
                            <span className="text-lg font-bold text-emerald-700">{(viewerTotals.totalMinutes / 60).toFixed(1)}h</span>
                        </div>
                    </div>
                </div>
            </div>
            <div className="max-h-[60vh] overflow-y-auto">
                <table className="w-full text-sm text-left">
                    <thead className="bg-slate-50 border-b border-slate-200 sticky top-0 z-10">
                        <tr>
                            <th className="px-6 py-3 font-semibold text-slate-500 uppercase text-xs">Date</th>
                            <th className="px-4 py-3 font-semibold text-slate-500 uppercase text-xs">In / Out</th>
                            <th className="px-4 py-3 font-semibold text-slate-500 uppercase text-xs text-right">Break</th>
                            <th className="px-4 py-3 font-semibold text-slate-500 uppercase text-xs text-right">Reg</th>
                            <th className="px-4 py-3 font-semibold text-slate-500 uppercase text-xs text-right">OT</th>
                            <th className="px-4 py-3 font-semibold text-slate-500 uppercase text-xs text-right">ND</th>
                            <th className="px-4 py-3 font-semibold text-slate-500 uppercase text-xs text-right">Net Total</th>
                            <th className="px-4 py-3 font-semibold text-slate-500 uppercase text-xs text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100 bg-white">
                        {viewingEmployeeRecords.length === 0 ? (
                            <tr>
                                <td colSpan={8} className="px-6 py-12 text-center text-slate-500 italic">No logs found for this period.</td>
                            </tr>
                        ) : (
                            viewingEmployeeRecords.map((record: any) => {
                                // FIX: totalWorkMinutes is already net in DB
                                const workMinutes = record.totalWorkMinutes || 0;
                                const breakMinutes = record.totalBreakMinutes || 0;

                                const otMins = Math.max(0, workMinutes - 480);
                                const regMins = workMinutes - otMins;
                                const otHours = otMins / 60;
                                const ndHours = getNightDiffHours(record.timeIn, record.timeOut);
                                
                                return (
                                    <tr key={record.id} className="hover:bg-slate-50 transition-colors">
                                        <td className="px-6 py-4 font-medium text-slate-700 whitespace-nowrap">{formatDate(record.date)}</td>
                                        <td className="px-4 py-4 whitespace-nowrap">
                                            <div className="flex flex-col text-xs">
                                                <span className="font-mono text-slate-600">{formatTime(record.timeIn)}</span>
                                                <span className="font-mono text-slate-400">
                                                    {record.timeOut ? formatTime(record.timeOut) : '--:--'}
                                                </span>
                                            </div>
                                        </td>
                                        <td className="px-4 py-4 text-right text-slate-500 text-xs">
                                            {formatDuration(breakMinutes)}
                                        </td>
                                        <td className="px-4 py-4 text-right font-medium text-slate-700 text-xs">
                                            {formatDuration(regMins)}
                                        </td>
                                        <td className="px-4 py-4 text-right">
                                            {otHours > 0 ? (
                                                <span className="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-amber-50 text-amber-700 border border-amber-100">
                                                    <Flame className="w-3 h-3 mr-1" /> {otHours.toFixed(1)}h
                                                </span>
                                            ) : <span className="text-slate-300 text-xs">-</span>}
                                        </td>
                                        <td className="px-4 py-4 text-right">
                                            {ndHours > 0 ? (
                                                <span className="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-indigo-50 text-indigo-700 border border-indigo-100">
                                                    <Moon className="w-3 h-3 mr-1" /> {ndHours.toFixed(1)}h
                                                </span>
                                            ) : <span className="text-slate-300 text-xs">-</span>}
                                        </td>
                                        <td className="px-4 py-4 text-right font-bold text-slate-900 text-xs">
                                            {formatDuration(workMinutes)}
                                        </td>
                                        <td className="px-4 py-4 text-center">
                                            <span className={`inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium uppercase tracking-wide 
                                                ${record.status === 'clocked_out' ? 'bg-emerald-50 text-emerald-700 border border-emerald-100' : 'bg-slate-50 text-slate-500 border border-slate-100'}`}>
                                                {record.status === 'clocked_out' ? 'Complete' : 'Incomplete'}
                                            </span>
                                        </td>
                                    </tr>
                                );
                            })
                        )}
                    </tbody>
                </table>
            </div>
            <div className="p-4 bg-slate-50 border-t border-slate-100 flex justify-end">
                <Button onClick={() => setAttendanceViewerId(null)} className="rounded-full bg-slate-900 text-white hover:bg-slate-800">Close</Button>
            </div>
        </DialogContent>
      </Dialog>

      {/* Edit Dialog */}
      <Dialog open={isEditOpen} onOpenChange={setIsEditOpen}>
        <DialogContent className="max-w-3xl rounded-2xl">
            <DialogHeader>
                <DialogTitle>Edit Payslip Details</DialogTitle>
                <DialogDescription>
                    Adjust hours and other amounts. Tax and Government contributions are auto-calculated.
                </DialogDescription>
            </DialogHeader>
            <div className="grid gap-6 py-4">
                <div className="grid grid-cols-2 gap-6">
                    {/* Left Column: Inputs */}
                    <div className="space-y-4">
                        <h3 className="font-medium text-sm text-slate-500 uppercase tracking-wider border-b border-slate-100 pb-2">Hours & Adjustments</h3>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <Label className="text-xs text-slate-500">Reg Hours</Label>
                                <Input type="number" className="rounded-xl border-slate-200" value={editForm.regularHours} onChange={e => setEditForm({...editForm, regularHours: Math.max(0, parseFloat(e.target.value) || 0)})} />
                            </div>
                            <div>
                                <Label className="text-xs text-slate-500">OT Hours</Label>
                                <Input type="number" className="rounded-xl border-slate-200" value={editForm.overtimeHours} onChange={e => setEditForm({...editForm, overtimeHours: Math.max(0, parseFloat(e.target.value) || 0)})} />
                            </div>
                            <div>
                                <Label className="text-xs text-slate-500">ND Hours</Label>
                                <Input type="number" className="rounded-xl border-slate-200" value={editForm.nightDiffHours} onChange={e => setEditForm({...editForm, nightDiffHours: Math.max(0, parseFloat(e.target.value) || 0)})} />
                            </div>
                            <div>
                                <Label className="text-xs text-slate-500">Bonuses</Label>
                                <Input type="number" className="rounded-xl border-slate-200" value={editForm.bonuses} onChange={e => setEditForm({...editForm, bonuses: Math.max(0, parseFloat(e.target.value) || 0)})} />
                            </div>
                            <div className="col-span-2">
                                <Label className="text-xs text-slate-500">Other Allowances</Label>
                                <Input type="number" className="rounded-xl border-slate-200" value={editForm.otherAllowances} onChange={e => setEditForm({...editForm, otherAllowances: Math.max(0, parseFloat(e.target.value) || 0)})} />
                            </div>
                            <div className="col-span-2">
                                <Label className="text-xs text-slate-500">Other Deductions</Label>
                                <Input type="number" className="rounded-xl border-slate-200" value={editForm.otherDeductions} onChange={e => setEditForm({...editForm, otherDeductions: Math.max(0, parseFloat(e.target.value) || 0)})} />
                            </div>
                             {/* <div className="col-span-2">
                                <Label className="text-xs text-slate-500">Tax</Label>
                                <Input type="number" className="rounded-xl border-slate-200" value={editForm.tax} onChange={e => setEditForm({...editForm, tax: Math.max(0, parseFloat(e.target.value) || 0)})} />
                            </div> */}
                        </div>
                    </div>

                    {/* Right Column: Computed Values */}
                    <div className="space-y-4 bg-slate-50/80 p-5 rounded-2xl border border-slate-100">
                         <h3 className="font-medium text-sm text-slate-500 uppercase tracking-wider border-b border-slate-200 pb-2">Calculated Summary</h3>
                         <div className="space-y-2 text-sm">
                            <div className="flex justify-between"><span className="text-slate-500">Basic Salary:</span><span className="font-medium text-slate-700">â±{editForm.basicSalary.toLocaleString()}</span></div>
                            <div className="flex justify-between"><span className="text-slate-500">Overtime Pay:</span><span className="font-medium text-slate-700">â±{editForm.overtimePay.toLocaleString()}</span></div>
                            <div className="flex justify-between"><span className="text-slate-500">Night Diff:</span><span className="font-medium text-slate-700">â±{editForm.nightDiffPay.toLocaleString()}</span></div>
                            <div className="flex justify-between pt-2 border-t border-slate-200 font-bold"><span>Gross Pay:</span><span>â±{editForm.grossPay.toLocaleString()}</span></div>

                            <div className="pt-2 space-y-1">
                                <div className="flex justify-between text-xs text-rose-600"><span>SSS:</span><span>-{editForm.sss.toLocaleString()}</span></div>
                                <div className="flex justify-between text-xs text-rose-600"><span>PhilHealth:</span><span>-{editForm.philHealth.toLocaleString()}</span></div>
                                <div className="flex justify-between text-xs text-rose-600"><span>Pag-IBIG:</span><span>-{editForm.pagIbig.toLocaleString()}</span></div>
                                {/* <div className="flex justify-between text-xs text-rose-600"><span>Tax:</span><span>-{editForm.tax.toLocaleString()}</span></div> */}
                                <div className="flex justify-between text-xs text-rose-600"><span>Other Ded:</span><span>-{editForm.otherDeductions.toLocaleString()}</span></div>
                            </div>

                            <div className="flex justify-between pt-4 border-t border-slate-200 text-lg font-bold text-emerald-600">
                                <span>Net Pay:</span><span>â±{editForm.netPay.toLocaleString()}</span>
                            </div>
                         </div>
                    </div>
                </div>
            </div>
            <DialogFooter>
                <Button variant="outline" onClick={() => setIsEditOpen(false)} className="rounded-full">Cancel</Button>
                <Button onClick={handleConfirmSave} className="rounded-full bg-slate-900 hover:bg-slate-800">Save & Confirm</Button>
            </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Confirmation Dialog */}
      <AlertDialog open={isConfirmOpen} onOpenChange={setIsConfirmOpen}>
        <AlertDialogContent className="rounded-2xl">
          <AlertDialogHeader>
            <AlertDialogTitle>Confirm Payslip {existingPayslips?.some((p:any) => p.userId === editingId) ? 'Update' : 'Generation'}</AlertDialogTitle>
            <AlertDialogDescription>
              Are you sure you want to {existingPayslips?.some((p:any) => p.userId === editingId) ? 'update' : 'generate'} the payslip for <strong>{editingEmployeeName}</strong>?
              <br/><br/>
              Period: {selectedPeriod.month}/{selectedPeriod.year} (Cutoff: {selectedPeriod.half === 1 ? '1st Half' : '2nd Half'})
              <br/>
              Net Pay: <strong>â±{currentNetPay.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</strong>
              <br/>
              <span className="text-xs text-slate-500">This action cannot be undone easily.</span>
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel className="rounded-full">Cancel</AlertDialogCancel>
            <AlertDialogAction onClick={handleConfirmSave} className="bg-emerald-600 hover:bg-emerald-700 rounded-full">
              Confirm
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>

    </div>
  );
}


===== payslips-enhanced.tsx =====
import { useState, useMemo } from "react";
import { useQuery } from "@tanstack/react-query";
import { useAuth } from "@/hooks/use-auth";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import { FileText, Eye, TrendingUp, DollarSign, Calendar, Wallet, TrendingDown, Clock, ChevronDown } from "lucide-react";
import type { Payslip } from "@shared/schema";
import { BentoCard } from "@/components/custom/bento-card";
import { Loader2 } from "lucide-react";
import { HOURLY_RATE, OT_MULTIPLIER, ND_MULTIPLIER } from "@/utils/salary_computation";

export default function PayslipsEnhanced() {
  const { user } = useAuth();
  const [selectedPayslip, setSelectedPayslip] = useState<Payslip | null>(null);

  const { data: payslips, isLoading } = useQuery<Payslip[]>({
    queryKey: ["/api/payslips"],
  });

  // --- Stats Calculation ---
  const stats = useMemo(() => {
    if (!payslips || payslips.length === 0) return { totalNet: 0, totalGross: 0, latestPay: 0, totalDeductions: 0 };
    
    const totalNet = payslips.reduce((acc, curr) => acc + curr.netPay, 0);
    const totalGross = payslips.reduce((acc, curr) => acc + curr.grossPay, 0);
    const totalDeductions = totalGross - totalNet;
    
    // Sort by date desc to get latest
    const sorted = [...payslips].sort((a, b) => new Date(b.generatedAt!).getTime() - new Date(a.generatedAt!).getTime());
    const latestPay = sorted.length > 0 ? sorted[0].netPay : 0;

    return { totalNet, totalGross, latestPay, totalDeductions };
  }, [payslips]);

  const formatCurrency = (amount: number) => {
    return new Intl.NumberFormat('en-PH', {
      style: 'currency',
      currency: 'PHP',
    }).format(amount / 100);
  };

  const formatDate = (date: string | Date) => {
    return new Date(date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  };

  const getMonthName = (month: number) => {
    const months = [
      'January', 'February', 'March', 'April', 'May', 'June',
      'July', 'August', 'September', 'October', 'November', 'December'
    ];
    return months[month - 1];
  };

  const getPeriodLabel = (payslip: Payslip) => {
    if (payslip.period) {
        return payslip.period === 1 ? "1st Half (1-15)" : "2nd Half (16-End)";
    }
    if (!payslip.generatedAt) return "Regular";
    const date = new Date(payslip.generatedAt);
    const day = date.getDate();
    return day <= 15 ? "1st Half (1-15)" : "2nd Half (16-End)";
  };

  const getDeductionBreakdown = (payslip: Payslip) => {
    const deductions = payslip.deductions as Record<string, number> || {};
    const data = Object.entries(deductions).map(([key, value]) => ({
      name: key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1').trim(),
      value: value,
    }));
    return data.filter(item => item.value > 0);
  };

  const getEarningsData = (payslip: Payslip) => {
    const allowances = payslip.allowances as Record<string, number> || {};
    
    const basic = payslip.basicSalary || 0;
    const overtime = allowances.overtime || 0;
    const nightDiff = allowances.nightDiff || 0;
    const bonuses = allowances.bonuses || 0;
    const otherAllowances = allowances.allowances || allowances.otherAllowances || 0;

    const basicHours = (basic / 100) / HOURLY_RATE;
    const overtimeHours = (overtime / 100) / OT_MULTIPLIER;
    const nightDiffHours = (nightDiff / 100) / ND_MULTIPLIER;

    return [
        { label: "Basic Salary", amount: basic, hours: basicHours, hasHours: true },
        { label: "Overtime", amount: overtime, hours: overtimeHours, hasHours: true, highlight: true },
        { label: "Night Differential", amount: nightDiff, hours: nightDiffHours, hasHours: true, highlight: true },
        { label: "Bonuses", amount: bonuses, hasHours: false },
        { label: "Other Allowances", amount: otherAllowances, hasHours: false },
    ].filter(item => item.amount > 0);
  };

  if (isLoading) return <div className="min-h-screen flex items-center justify-center"><Loader2 className="animate-spin text-slate-400" /></div>;

  return (
    <div className="p-6 md:p-8 max-w-7xl mx-auto space-y-8">
      
      {/* Glass Header */}
      <div className="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
        <div>
          <h1 className="text-3xl font-bold tracking-tight text-slate-900">My Payslips</h1>
          <p className="text-slate-500 mt-1">View your salary history and income breakdown</p>
        </div>
      </div>

      {/* Bento Stats */}
      {/* <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <BentoCard 
            title="Total Earnings (YTD)" 
            value={formatCurrency(stats.totalNet)} 
            icon={Wallet} 
            variant="emerald" 
            testIdPrefix="stat-total-earnings" 
        />
        <BentoCard 
            title="Latest Payout" 
            value={formatCurrency(stats.latestPay)} 
            icon={Clock} 
            variant="default" 
            testIdPrefix="stat-latest-pay" 
        />
        <BentoCard 
            title="Total Deductions" 
            value={formatCurrency(stats.totalDeductions)} 
            icon={TrendingDown} 
            variant="rose" 
            testIdPrefix="stat-deductions" 
        />
      </div> */}

      {/* Payslip List */}
      <div className="space-y-6">
        <h2 className="text-lg font-semibold text-slate-800 flex items-center gap-2">
            <FileText className="w-5 h-5 text-slate-500" /> Recent Payslips
        </h2>
        
        {payslips && payslips.length > 0 ? (
          <div className="grid grid-cols-1 gap-6">
            {[...payslips].sort((a, b) => new Date(b.generatedAt!).getTime() - new Date(a.generatedAt!).getTime()).map((payslip: Payslip) => {
                const periodLabel = getPeriodLabel(payslip);
                const earnings = getEarningsData(payslip);
                const deductions = getDeductionBreakdown(payslip);
                const isExpanded = selectedPayslip?.id === payslip.id;

                return (
                  <Card key={payslip.id} className={`bg-white/60 backdrop-blur-xl border-slate-200/60 shadow-sm transition-all duration-300 ${isExpanded ? 'ring-2 ring-slate-200 shadow-md bg-white/80' : 'hover:bg-white/80 hover:shadow-md'}`}>
                    <CardContent className="p-0">
                        {/* Summary Row */}
                        <div className="p-6 flex flex-col md:flex-row items-start md:items-center justify-between gap-6 cursor-pointer" onClick={() => setSelectedPayslip(isExpanded ? null : payslip)}>
                            <div className="flex items-center gap-4">
                                <div className="h-14 w-14 rounded-2xl bg-blue-50 text-blue-600 flex items-center justify-center border border-blue-100 shadow-sm">
                                    <span className="text-xs font-bold uppercase">{getMonthName(payslip.month).substring(0, 3)}</span>
                                </div>
                                <div>
                                    <h3 className="text-lg font-bold text-slate-800">{getMonthName(payslip.month)} {payslip.year}</h3>
                                    <div className="flex items-center gap-2 mt-1">
                                        <Badge variant="secondary" className="bg-slate-100 text-slate-600 hover:bg-slate-200 font-normal border border-slate-200">{periodLabel}</Badge>
                                        <span className="text-xs text-slate-400 hidden sm:inline-block">â¢ Generated {formatDate(payslip.generatedAt!)}</span>
                                    </div>
                                </div>
                            </div>

                            <div className="flex items-center gap-6 w-full md:w-auto justify-between md:justify-end">
                                <div className="text-right">
                                    <p className="text-xs font-medium text-slate-500 uppercase tracking-wider">Net Pay</p>
                                    <p className="text-xl font-bold text-emerald-600">{formatCurrency(payslip.netPay)}</p>
                                </div>
                                <Button 
                                    variant="ghost" 
                                    size="icon" 
                                    className={`rounded-full transition-transform duration-300 ${isExpanded ? 'rotate-180 bg-slate-100' : ''}`}
                                >
                                    <ChevronDown className="w-5 h-5 text-slate-500" />
                                </Button>
                            </div>
                        </div>

                        {/* Expanded Details */}
                        {isExpanded && (
                            <div className="px-6 pb-6 animate-in slide-in-from-top-2 duration-200">
                                <Separator className="mb-6 bg-slate-200/60" />
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    {/* Earnings */}
                                    <div className="space-y-4">
                                        <h4 className="text-sm font-semibold text-slate-900 flex items-center gap-2">
                                            <TrendingUp className="w-4 h-4 text-blue-600" /> Earnings
                                        </h4>
                                        <div className="bg-slate-50/50 rounded-xl border border-slate-100 p-4 space-y-3">
                                            {earnings.map((item, idx) => (
                                                <div key={idx} className="flex justify-between items-center text-sm">
                                                    <div>
                                                        <p className="text-slate-700 font-medium">{item.label}</p>
                                                        {item.hasHours && <p className="text-xs text-slate-400">{item.hours.toFixed(1)} hrs</p>}
                                                    </div>
                                                    <p className="text-slate-900 font-mono">{formatCurrency(item.amount)}</p>
                                                </div>
                                            ))}
                                            <Separator className="bg-slate-200" />
                                            <div className="flex justify-between items-center font-bold text-slate-800">
                                                <span>Total Gross</span>
                                                <span>{formatCurrency(payslip.grossPay)}</span>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Deductions */}
                                    <div className="space-y-4">
                                        <h4 className="text-sm font-semibold text-slate-900 flex items-center gap-2">
                                            <DollarSign className="w-4 h-4 text-rose-600" /> Deductions
                                        </h4>
                                        <div className="bg-slate-50/50 rounded-xl border border-slate-100 p-4 space-y-3">
                                            {deductions.length > 0 ? deductions.map((item, idx) => (
                                                <div key={idx} className="flex justify-between items-center text-sm">
                                                    <p className="text-slate-600">{item.name}</p>
                                                    <p className="text-rose-600 font-mono">-{formatCurrency(item.value)}</p>
                                                </div>
                                            )) : <p className="text-sm text-slate-400 italic">No deductions</p>}
                                            <Separator className="bg-slate-200" />
                                            <div className="flex justify-between items-center font-bold text-rose-700">
                                                <span>Total Deductions</span>
                                                <span>-{formatCurrency(payslip.grossPay - payslip.netPay)}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Net Pay Highlight */}
                                <div className="mt-6 p-4 bg-emerald-50 border border-emerald-100 rounded-xl flex justify-between items-center">
                                    <div className="flex items-center gap-2">
                                        <div className="p-2 bg-emerald-100 rounded-full text-emerald-600">
                                            <Wallet className="w-5 h-5" />
                                        </div>
                                        <div>
                                            <p className="text-xs font-bold text-emerald-800 uppercase tracking-wider">Total Net Pay</p>
                                            <p className="text-xs text-emerald-600">Take home pay</p>
                                        </div>
                                    </div>
                                    <span className="text-2xl font-bold text-emerald-700 tracking-tight">{formatCurrency(payslip.netPay)}</span>
                                </div>
                            </div>
                        )}
                    </CardContent>
                  </Card>
                );
            })}
          </div>
        ) : (
          <Card className="bg-white/40 border-dashed border-slate-200">
            <CardContent className="py-12 text-center">
               <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  <FileText className="w-8 h-8 text-slate-300" />
               </div>
               <h3 className="text-lg font-medium text-slate-900">No Payslips Found</h3>
               <p className="text-slate-500">Your payslip history will appear here once generated.</p>
            </CardContent>
          </Card>
        )}
      </div>
    </div>
  );
}


===== profile.tsx =====
import { useState } from "react";
import { useAuth } from "@/hooks/use-auth";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { apiRequest } from "@/lib/queryClient";
import { toast } from "sonner";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { User, Mail, Phone, MapPin, Briefcase, Calendar, Edit, Shield, HeartPulse, Home } from "lucide-react";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Badge } from "@/components/ui/badge";

const profileUpdateSchema = z.object({
  firstName: z.string().min(1, "First name is required"),
  lastName: z.string().min(1, "Last name is required"),
  email: z.string().email("Invalid email address"),
  phoneNumber: z.string().optional().refine((val) => {
    if (!val || val.trim() === "") return true;
    const phoneRegex = /^[\d\s\-\(\)\+]+$/;
    return phoneRegex.test(val);
  }, "Phone number can only contain numbers and basic formatting characters"),
});

const emergencyContactSchema = z.object({
  name: z.string().min(1, "Emergency contact name is required"),
  relationship: z.string().min(1, "Relationship is required"),
  phone: z.string().min(1, "Emergency contact phone is required").refine((val) => {
    const phoneRegex = /^[\d\s\-\(\)\+]+$/;
    return phoneRegex.test(val);
  }, "Phone number can only contain numbers and basic formatting characters"),
});

const addressSchema = z.object({
  street: z.string().optional(),
  city: z.string().optional(),
  state: z.string().optional(),
  zipCode: z.string().optional(),
  country: z.string().optional(),
});

type ProfileUpdateForm = z.infer<typeof profileUpdateSchema>;
type EmergencyContactForm = z.infer<typeof emergencyContactSchema>;
type AddressForm = z.infer<typeof addressSchema>;

export default function Profile() {
  const { user } = useAuth();
  const queryClient = useQueryClient();
  const [isEditing, setIsEditing] = useState(false);

  const profileForm = useForm<ProfileUpdateForm>({
    resolver: zodResolver(profileUpdateSchema),
    defaultValues: {
      firstName: user?.firstName || "",
      lastName: user?.lastName || "",
      email: user?.email || "",
      phoneNumber: user?.phoneNumber || "",
    },
  });

  const emergencyForm = useForm<EmergencyContactForm>({
    resolver: zodResolver(emergencyContactSchema),
    defaultValues: {
      name: (user?.emergencyContact as any)?.name || "",
      relationship: (user?.emergencyContact as any)?.relationship || "",
      phone: (user?.emergencyContact as any)?.phone || "",
    },
  });

  const addressForm = useForm<AddressForm>({
    resolver: zodResolver(addressSchema),
    defaultValues: {
      street: (user?.address as any)?.street || "",
      city: (user?.address as any)?.city || "",
      state: (user?.address as any)?.state || "",
      zipCode: (user?.address as any)?.zipCode || "",
      country: (user?.address as any)?.country || "",
    },
  });

  const updateProfileMutation = useMutation({
    mutationFn: async (data: ProfileUpdateForm) => {
      const res = await apiRequest("PATCH", "/api/profile", data);
      return await res.json();
    },
    onSuccess: () => {
      toast.success("Profile updated", { description: "Your profile has been updated successfully." });
      queryClient.invalidateQueries({ queryKey: ["/api/user"] });
      setIsEditing(false);
    },
    onError: (error: Error) => {
      toast.error("Update failed", { description: error.message });
    },
  });

  const updateEmergencyContactMutation = useMutation({
    mutationFn: async (data: EmergencyContactForm) => {
      const res = await apiRequest("PATCH", "/api/profile", { emergencyContact: data });
      return await res.json();
    },
    onSuccess: () => {
      toast.success("Emergency contact updated", { description: "Your emergency contact has been updated successfully." });
      queryClient.invalidateQueries({ queryKey: ["/api/user"] });
    },
    onError: (error: Error) => {
      toast.error("Update failed", { description: error.message });
    },
  });

  const updateAddressMutation = useMutation({
    mutationFn: async (data: AddressForm) => {
      const res = await apiRequest("PATCH", "/api/profile", { address: data });
      return await res.json();
    },
    onSuccess: () => {
      toast.success("Address updated", { description: "Your address has been updated successfully." });
      queryClient.invalidateQueries({ queryKey: ["/api/user"] });
    },
    onError: (error: Error) => {
      toast.error("Update failed", { description: error.message });
    },
  });

  const onProfileUpdate = (data: ProfileUpdateForm) => updateProfileMutation.mutate(data);
  const onEmergencyContactUpdate = (data: EmergencyContactForm) => updateEmergencyContactMutation.mutate(data);
  const onAddressUpdate = (data: AddressForm) => updateAddressMutation.mutate(data);

  if (!user) return null;

  return (
    <div className="p-6 md:p-8 max-w-7xl mx-auto space-y-8">
      {/* Hero Header */}
      <div className="relative bg-slate-900 rounded-3xl p-8 overflow-hidden shadow-2xl">
        <div className="absolute top-0 right-0 w-96 h-96 bg-blue-500/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/3 pointer-events-none" />
        <div className="absolute bottom-0 left-0 w-64 h-64 bg-purple-500/10 rounded-full blur-3xl translate-y-1/2 -translate-x-1/3 pointer-events-none" />
        
        <div className="relative z-10 flex flex-col md:flex-row items-center md:items-end gap-6">
          <Avatar className="w-24 h-24 md:w-32 md:h-32 border-4 border-white/10 shadow-xl">
            <AvatarImage src={user.profilePicture || ""} />
            <AvatarFallback className="bg-slate-800 text-white text-3xl md:text-4xl">
              {user.firstName.charAt(0)}{user.lastName.charAt(0)}
            </AvatarFallback>
          </Avatar>
          
          <div className="flex-1 text-center md:text-left space-y-2 pb-2">
             <h1 className="text-3xl md:text-4xl font-bold text-white tracking-tight">{user.firstName} {user.lastName}</h1>
             <div className="flex flex-wrap items-center justify-center md:justify-start gap-3 text-slate-400">
                <Badge variant="outline" className="border-slate-700 text-slate-300 px-3 py-1 capitalize">
                   <Briefcase className="w-3 h-3 mr-1.5" /> {user.position || "Employee"}
                </Badge>
                <Badge variant="outline" className="border-slate-700 text-slate-300 px-3 py-1 capitalize">
                   <Shield className="w-3 h-3 mr-1.5" /> {user.department || "General"}
                </Badge>
                <span className="text-sm flex items-center gap-1.5">
                   <Mail className="w-3.5 h-3.5" /> {user.email}
                </span>
             </div>
          </div>

          <Button 
            onClick={() => setIsEditing(!isEditing)} 
            variant={isEditing ? "secondary" : "default"}
            className={`rounded-full px-6 shadow-lg ${isEditing ? 'bg-white text-slate-900 hover:bg-slate-200' : 'bg-blue-600 hover:bg-blue-700 text-white'}`}
            data-testid="button-edit-profile"
          >
            <Edit className="w-4 h-4 mr-2" />
            {isEditing ? "Cancel Editing" : "Edit Profile"}
          </Button>
        </div>
      </div>

      <Tabs defaultValue="personal" className="space-y-8">
        <div className="flex justify-center">
           <TabsList className="bg-white/80 backdrop-blur-md border border-slate-200/60 p-1 rounded-full h-auto shadow-sm" data-testid="profile-tabs">
             <TabsTrigger value="personal" className="rounded-full px-6 py-2.5 data-[state=active]:bg-slate-900 data-[state=active]:text-white transition-all" data-testid="tab-personal">Personal Info</TabsTrigger>
             <TabsTrigger value="contact" className="rounded-full px-6 py-2.5 data-[state=active]:bg-slate-900 data-[state=active]:text-white transition-all" data-testid="tab-contact">Contact Details</TabsTrigger>
             <TabsTrigger value="employment" className="rounded-full px-6 py-2.5 data-[state=active]:bg-slate-900 data-[state=active]:text-white transition-all" data-testid="tab-employment">Employment</TabsTrigger>
           </TabsList>
        </div>

        <TabsContent value="personal" className="mt-0 focus-visible:outline-none">
           <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Left Column: Main Info */}
              <Card className="lg:col-span-2 bg-white/60 backdrop-blur-xl border-slate-200/60 shadow-sm rounded-3xl overflow-hidden">
                 <CardHeader className="border-b border-slate-100 bg-white/50">
                    <CardTitle className="flex items-center text-slate-800">
                       <User className="w-5 h-5 mr-2 text-blue-600" /> Basic Information
                    </CardTitle>
                    <CardDescription>Manage your primary identification details</CardDescription>
                 </CardHeader>
                 <CardContent className="p-6 md:p-8">
                    {isEditing ? (
                       <form onSubmit={profileForm.handleSubmit(onProfileUpdate)} className="space-y-6">
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                             <div className="space-y-2">
                                <Label htmlFor="firstName" className="text-slate-600">First Name</Label>
                                <Input id="firstName" {...profileForm.register("firstName")} className="rounded-xl bg-white border-slate-200 focus:ring-blue-500/20" />
                                {profileForm.formState.errors.firstName && <p className="text-xs text-red-500">{profileForm.formState.errors.firstName.message}</p>}
                             </div>
                             <div className="space-y-2">
                                <Label htmlFor="lastName" className="text-slate-600">Last Name</Label>
                                <Input id="lastName" {...profileForm.register("lastName")} className="rounded-xl bg-white border-slate-200 focus:ring-blue-500/20" />
                                {profileForm.formState.errors.lastName && <p className="text-xs text-red-500">{profileForm.formState.errors.lastName.message}</p>}
                             </div>
                             <div className="space-y-2">
                                <Label htmlFor="email" className="text-slate-600">Email Address</Label>
                                <Input id="email" type="email" {...profileForm.register("email")} className="rounded-xl bg-white border-slate-200 focus:ring-blue-500/20" />
                                {profileForm.formState.errors.email && <p className="text-xs text-red-500">{profileForm.formState.errors.email.message}</p>}
                             </div>
                             <div className="space-y-2">
                                <Label htmlFor="phoneNumber" className="text-slate-600">Phone Number</Label>
                                <Input id="phoneNumber" {...profileForm.register("phoneNumber")} className="rounded-xl bg-white border-slate-200 focus:ring-blue-500/20" />
                             </div>
                          </div>
                          <div className="flex justify-end pt-4">
                             <Button type="submit" disabled={updateProfileMutation.isPending} className="rounded-full bg-slate-900 hover:bg-slate-800 px-8">
                                {updateProfileMutation.isPending ? "Saving..." : "Save Changes"}
                             </Button>
                          </div>
                       </form>
                    ) : (
                       <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                          <div className="space-y-1">
                             <p className="text-sm font-medium text-slate-500 uppercase tracking-wider">Full Name</p>
                             <p className="text-lg font-semibold text-slate-900">{user.firstName} {user.lastName}</p>
                          </div>
                          <div className="space-y-1">
                             <p className="text-sm font-medium text-slate-500 uppercase tracking-wider">Email</p>
                             <p className="text-lg font-semibold text-slate-900">{user.email}</p>
                          </div>
                          <div className="space-y-1">
                             <p className="text-sm font-medium text-slate-500 uppercase tracking-wider">Phone</p>
                             <p className="text-lg font-semibold text-slate-900">{user.phoneNumber || "Not provided"}</p>
                          </div>
                          <div className="space-y-1">
                             <p className="text-sm font-medium text-slate-500 uppercase tracking-wider">Employee ID</p>
                             <p className="text-lg font-semibold text-slate-900 font-mono">{user.employeeId || "N/A"}</p>
                          </div>
                       </div>
                    )}
                 </CardContent>
              </Card>
              
              {/* Right Column: Quick Stats */}
              <div className="space-y-6">
                 <Card className="bg-blue-50/50 backdrop-blur-xl border-blue-100/60 shadow-sm rounded-3xl">
                    <CardContent className="p-6 flex items-center gap-4">
                       <div className="h-12 w-12 rounded-2xl bg-blue-100 flex items-center justify-center text-blue-600">
                          <Calendar className="w-6 h-6" />
                       </div>
                       <div>
                          <p className="text-sm font-medium text-blue-600/80 uppercase tracking-wider">Joined On</p>
                          <p className="text-xl font-bold text-blue-900">
                             {user.hireDate ? new Date(user.hireDate).toLocaleDateString() : "N/A"}
                          </p>
                       </div>
                    </CardContent>
                 </Card>
                 <Card className="bg-emerald-50/50 backdrop-blur-xl border-emerald-100/60 shadow-sm rounded-3xl">
                    <CardContent className="p-6 flex items-center gap-4">
                       <div className="h-12 w-12 rounded-2xl bg-emerald-100 flex items-center justify-center text-emerald-600">
                          <Shield className="w-6 h-6" />
                       </div>
                       <div>
                          <p className="text-sm font-medium text-emerald-600/80 uppercase tracking-wider">System Role</p>
                          <p className="text-xl font-bold text-emerald-900 capitalize">{user.role.replace('_', ' ')}</p>
                       </div>
                    </CardContent>
                 </Card>
              </div>
           </div>
        </TabsContent>

        <TabsContent value="contact" className="mt-0 focus-visible:outline-none">
           <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Emergency Contact */}
              <Card className="bg-white/60 backdrop-blur-xl border-slate-200/60 shadow-sm rounded-3xl overflow-hidden h-full">
                 <CardHeader className="border-b border-slate-100 bg-white/50">
                    <CardTitle className="flex items-center text-slate-800">
                       <HeartPulse className="w-5 h-5 mr-2 text-rose-500" /> Emergency Contact
                    </CardTitle>
                    <CardDescription>Person to contact in case of emergency</CardDescription>
                 </CardHeader>
                 <CardContent className="p-6 md:p-8">
                    <form onSubmit={emergencyForm.handleSubmit(onEmergencyContactUpdate)} className="space-y-5">
                       <div className="space-y-2">
                          <Label htmlFor="emergencyName" className="text-slate-600">Contact Name</Label>
                          <Input id="emergencyName" {...emergencyForm.register("name")} className="rounded-xl bg-white border-slate-200" placeholder="Full Name" />
                          {emergencyForm.formState.errors.name && <p className="text-xs text-red-500">{emergencyForm.formState.errors.name.message}</p>}
                       </div>
                       <div className="grid grid-cols-2 gap-4">
                          <div className="space-y-2">
                             <Label htmlFor="relationship" className="text-slate-600">Relationship</Label>
                             <Input id="relationship" {...emergencyForm.register("relationship")} className="rounded-xl bg-white border-slate-200" placeholder="e.g. Spouse" />
                             {emergencyForm.formState.errors.relationship && <p className="text-xs text-red-500">{emergencyForm.formState.errors.relationship.message}</p>}
                          </div>
                          <div className="space-y-2">
                             <Label htmlFor="emergencyPhone" className="text-slate-600">Phone</Label>
                             <Input id="emergencyPhone" {...emergencyForm.register("phone")} className="rounded-xl bg-white border-slate-200" placeholder="+63..." />
                             {emergencyForm.formState.errors.phone && <p className="text-xs text-red-500">{emergencyForm.formState.errors.phone.message}</p>}
                          </div>
                       </div>
                       <div className="flex justify-end pt-2">
                          <Button type="submit" disabled={updateEmergencyContactMutation.isPending} className="rounded-full bg-slate-900 hover:bg-slate-800">
                             {updateEmergencyContactMutation.isPending ? "Saving..." : "Update Contact"}
                          </Button>
                       </div>
                    </form>
                 </CardContent>
              </Card>

              {/* Address */}
              <Card className="bg-white/60 backdrop-blur-xl border-slate-200/60 shadow-sm rounded-3xl overflow-hidden h-full">
                 <CardHeader className="border-b border-slate-100 bg-white/50">
                    <CardTitle className="flex items-center text-slate-800">
                       <Home className="w-5 h-5 mr-2 text-amber-500" /> Residential Address
                    </CardTitle>
                    <CardDescription>Where you currently live</CardDescription>
                 </CardHeader>
                 <CardContent className="p-6 md:p-8">
                    <form onSubmit={addressForm.handleSubmit(onAddressUpdate)} className="space-y-5">
                       <div className="space-y-2">
                          <Label htmlFor="street" className="text-slate-600">Street Address</Label>
                          <Textarea id="street" {...addressForm.register("street")} className="rounded-xl bg-white border-slate-200 resize-none" rows={2} placeholder="House No., Street Name, Brgy." />
                       </div>
                       <div className="grid grid-cols-2 gap-4">
                          <div className="space-y-2">
                             <Label htmlFor="city" className="text-slate-600">City</Label>
                             <Input id="city" {...addressForm.register("city")} className="rounded-xl bg-white border-slate-200" />
                          </div>
                          <div className="space-y-2">
                             <Label htmlFor="state" className="text-slate-600">Province/State</Label>
                             <Input id="state" {...addressForm.register("state")} className="rounded-xl bg-white border-slate-200" />
                          </div>
                       </div>
                       <div className="grid grid-cols-2 gap-4">
                          <div className="space-y-2">
                             <Label htmlFor="zipCode" className="text-slate-600">ZIP Code</Label>
                             <Input id="zipCode" {...addressForm.register("zipCode")} className="rounded-xl bg-white border-slate-200" />
                          </div>
                          <div className="space-y-2">
                             <Label htmlFor="country" className="text-slate-600">Country</Label>
                             <Input id="country" {...addressForm.register("country")} className="rounded-xl bg-white border-slate-200" />
                          </div>
                       </div>
                       <div className="flex justify-end pt-2">
                          <Button type="submit" disabled={updateAddressMutation.isPending} className="rounded-full bg-slate-900 hover:bg-slate-800">
                             {updateAddressMutation.isPending ? "Saving..." : "Update Address"}
                          </Button>
                       </div>
                    </form>
                 </CardContent>
              </Card>
           </div>
        </TabsContent>

        <TabsContent value="employment" className="mt-0 focus-visible:outline-none">
           <Card className="bg-white/60 backdrop-blur-xl border-slate-200/60 shadow-sm rounded-3xl overflow-hidden">
              <CardHeader className="border-b border-slate-100 bg-white/50">
                 <CardTitle className="flex items-center text-slate-800">
                    <Briefcase className="w-5 h-5 mr-2 text-indigo-600" /> Employment Details
                 </CardTitle>
                 <CardDescription>Read-only view of your employment status</CardDescription>
              </CardHeader>
              <CardContent className="p-8">
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-12">
                    <div className="space-y-6">
                       <div className="flex items-start space-x-4">
                          <div className="p-3 bg-indigo-50 rounded-2xl text-indigo-600"><Briefcase className="w-6 h-6" /></div>
                          <div>
                             <p className="text-sm font-medium text-slate-500 uppercase tracking-wider">Position</p>
                             <p className="text-xl font-bold text-slate-900 mt-1">{user.position || "Not assigned"}</p>
                          </div>
                       </div>
                       <div className="flex items-start space-x-4">
                          <div className="p-3 bg-violet-50 rounded-2xl text-violet-600"><Shield className="w-6 h-6" /></div>
                          <div>
                             <p className="text-sm font-medium text-slate-500 uppercase tracking-wider">Department</p>
                             <p className="text-xl font-bold text-slate-900 mt-1">{user.department || "Not assigned"}</p>
                          </div>
                       </div>
                    </div>
                    <div className="space-y-6">
                       <div className="flex items-start space-x-4">
                          <div className="p-3 bg-amber-50 rounded-2xl text-amber-600"><Calendar className="w-6 h-6" /></div>
                          <div>
                             <p className="text-sm font-medium text-slate-500 uppercase tracking-wider">Date Hired</p>
                             <p className="text-xl font-bold text-slate-900 mt-1">
                                {user.hireDate ? new Date(user.hireDate).toLocaleDateString(undefined, { dateStyle: 'long' }) : "Not recorded"}
                             </p>
                          </div>
                       </div>
                       <div className="flex items-start space-x-4">
                          <div className="p-3 bg-emerald-50 rounded-2xl text-emerald-600"><User className="w-6 h-6" /></div>
                          <div>
                             <p className="text-sm font-medium text-slate-500 uppercase tracking-wider">Role Access</p>
                             <Badge className="mt-1 bg-slate-900 hover:bg-slate-800 text-white uppercase text-xs tracking-widest">{user.role.replace('_', ' ')}</Badge>
                          </div>
                       </div>
                    </div>
                 </div>
              </CardContent>
           </Card>
        </TabsContent>
      </Tabs>
    </div>
  );
}


===== reports.tsx =====
import { useState, useMemo, useEffect } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { useAuth } from "@/hooks/use-auth";
import { apiRequest } from "@/lib/queryClient";
import { toast } from "sonner";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import { Calendar } from "@/components/ui/calendar";
import { useForm, type FieldErrors } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { insertReportSchema, type User as UserType } from "@shared/schema";
import { z } from "zod";
import { 
  AlertTriangle, ShieldAlert, UserX, Stethoscope, 
  Hammer, FileWarning, Plus, Calendar as CalendarIcon, Clock, 
  Eye, FileText, MapPin, CheckCircle2, AlertCircle, Filter, ArrowUpDown, X, Users, Minus,
  ChevronLeft, ChevronRight, ChevronsLeft, ChevronsRight, BarChart3, PieChart as PieChartIcon,
  List as ListIcon
} from "lucide-react";
import { format, isWithinInterval, startOfDay, endOfDay, subMonths } from "date-fns";
import { cn } from "@/lib/utils";
import { 
  BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip as RechartsTooltip, ResponsiveContainer, 
  PieChart, Pie, Cell, Legend 
} from 'recharts';

/**
 * REPORT FORM SCHEMA CONFIGURATION
 * * We extend the base database schema to handle frontend-specific logic:
 * 1. involvedPeople: Handled as an array of strings in the UI, converted to comma-separated string for DB.
 * 2. dateOccurred: Coerced to Date object for easier handling with Date Pickers.
 * 3. details: Structured object for JSON storage in SQLite.
 */
const reportFormSchema = insertReportSchema.omit({ userId: true, partiesInvolved: true }).extend({
    involvedPeople: z.array(z.string()).min(1, "At least one person must be involved"), 
    
    // Override date to ensure it's a Date object in the form state
    dateOccurred: z.coerce.date(),

    details: z.object({
        items: z.array(z.object({
            name: z.string().min(1, "Item name required"),
            quantity: z.number().min(1),
            cost: z.number().min(0)
        })).optional(),
        
        policeReportNumber: z.string().optional(),
        injuryType: z.string().optional(),
        medicalAction: z.string().optional()
    }).optional()
});

type ReportForm = z.infer<typeof reportFormSchema>;

export default function Reports() {
  const { user } = useAuth();
  const queryClient = useQueryClient();
  
  // --- UI STATE MANAGEMENT ---
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const [view, setView] = useState<"list" | "analytics">("list");
  
  // --- FILTER STATE ---
  const [dateRange, setDateRange] = useState<{ from: Date | undefined; to: Date | undefined }>({ from: undefined, to: undefined });
  const [statusFilter, setStatusFilter] = useState<string>("all");
  const [categoryFilter, setCategoryFilter] = useState<string>("all");
  const [sortOrder, setSortOrder] = useState<"newest" | "oldest">("newest");

  // --- PAGINATION STATE ---
  const [currentPage, setCurrentPage] = useState(1);
  const itemsPerPage = 5;

  // --- DYNAMIC FORM STATE ---
  // These states handle the inputs for adding items/people before they are committed to the form
  const [newItem, setNewItem] = useState({ name: "", quantity: 1, cost: 0 });
  const [newPerson, setNewPerson] = useState("");

  // --- CONFIGURATION CONSTANTS ---
  const categories = [
    { id: "customer", label: "Customer Incident", icon: UserX, color: "bg-orange-100 text-orange-600", fill: "#f97316" },
    { id: "employee", label: "Employee Incident", icon: FileWarning, color: "bg-blue-100 text-blue-600", fill: "#3b82f6" },
    { id: "accident", label: "Accident Report", icon: AlertTriangle, color: "bg-yellow-100 text-yellow-600", fill: "#eab308" },
    { id: "security", label: "Security Incident", icon: ShieldAlert, color: "bg-red-100 text-red-600", fill: "#ef4444" },
    { id: "medical", label: "Medical Incident", icon: Stethoscope, color: "bg-rose-100 text-rose-600", fill: "#f43f5e" },
    { id: "property", label: "Property Damage", icon: Hammer, color: "bg-slate-100 text-slate-600", fill: "#64748b" },
  ];

  // --- DATA FETCHING ---
  const { data: reports, isLoading } = useQuery({ queryKey: ["/api/reports"] });
  const { data: teamMembers } = useQuery<UserType[]>({ queryKey: ["/api/team"] });

  // Reset pagination when filters change to avoid empty pages
  useEffect(() => {
    setCurrentPage(1);
  }, [statusFilter, categoryFilter, dateRange, sortOrder]);

  // --- FILTERING LOGIC ---
  const filteredReports = useMemo(() => {
    if (!reports) return [];
    return reports.filter((r: any) => {
        // Filter by Status
        if (statusFilter !== "all" && r.status !== statusFilter) return false;
        // Filter by Category
        if (categoryFilter !== "all" && r.category !== categoryFilter) return false;
        // Filter by Date Range
        if (dateRange.from && dateRange.to && r.dateOccurred) {
            const reportDate = new Date(r.dateOccurred);
            if (!isWithinInterval(reportDate, { start: startOfDay(dateRange.from), end: endOfDay(dateRange.to) })) return false;
        }
        return true;
    }).sort((a: any, b: any) => {
        // Sort Logic
        const timeA = new Date(a.dateOccurred).getTime();
        const timeB = new Date(b.dateOccurred).getTime();
        return sortOrder === "newest" ? timeB - timeA : timeA - timeB;
    });
  }, [reports, statusFilter, categoryFilter, dateRange, sortOrder]);

  // --- PAGINATION LOGIC ---
  const paginatedReports = useMemo(() => {
    const startIndex = (currentPage - 1) * itemsPerPage;
    return filteredReports.slice(startIndex, startIndex + itemsPerPage);
  }, [filteredReports, currentPage]);

  const totalPages = Math.ceil(filteredReports.length / itemsPerPage);

  // --- ANALYTICS DATA PREPARATION ---
  const stats = useMemo(() => {
    if (!reports) return { monthly: [], byCategory: [], mostInvolved: [] };

    // 1. Monthly Trend
    const months: Record<string, number> = {};
    for (let i = 5; i >= 0; i--) {
        const d = subMonths(new Date(), i);
        months[format(d, "MMM yyyy")] = 0;
    }
    
    reports.forEach((r: any) => {
        const key = format(new Date(r.dateOccurred), "MMM yyyy");
        if (months.hasOwnProperty(key)) {
            months[key]++;
        }
    });
    const monthlyData = Object.entries(months).map(([name, count]) => ({ name, count }));

    // 2. By Category
    const catCounts: Record<string, number> = {};
    reports.forEach((r: any) => {
        catCounts[r.category] = (catCounts[r.category] || 0) + 1;
    });
    const categoryData = Object.entries(catCounts).map(([id, value]) => {
        const cat = categories.find(c => c.id === id);
        return { name: cat?.label || id, value, fill: cat?.fill || "#cbd5e1" };
    });

    // 3. Most Involved (Parsing CSV string back to counts)
    const peopleCounts: Record<string, number> = {};
    reports.forEach((r: any) => {
        if (r.partiesInvolved) {
            r.partiesInvolved.split(',').forEach((name: string) => {
                const n = name.trim();
                if (n && n !== 'N/A') peopleCounts[n] = (peopleCounts[n] || 0) + 1;
            });
        }
    });
    const mostInvolved = Object.entries(peopleCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

    return { monthly: monthlyData, byCategory: categoryData, mostInvolved };
  }, [reports]);

  // --- FORM HANDLING ---
  const form = useForm<ReportForm>({
    resolver: zodResolver(reportFormSchema),
    defaultValues: {
      category: "customer",
      severity: "low",
      dateOccurred: new Date(),
      timeOccurred: format(new Date(), "HH:mm"),
      involvedPeople: [], 
      details: { items: [] }
    },
  });

  // Watch form values for dynamic UI updates
  const selectedCategory = form.watch("category");
  const currentPeople = form.watch("involvedPeople");
  const currentItems = form.watch("details.items") || [];

  // API Mutation
  const createReportMutation = useMutation({
    mutationFn: async (data: ReportForm) => {
      // Prepare payload for backend
      const { involvedPeople, ...cleanData } = data;
      const payload = {
          ...cleanData,
          partiesInvolved: involvedPeople.join(", "), // Array -> String
          userId: user?.id,
          // Convert JS Date to timestamp (number) for SQLite integer storage
          dateOccurred: new Date(data.dateOccurred).getTime(),
          // Default fallbacks
          witnesses: cleanData.witnesses || "", 
          images: [],
      };

      const res = await apiRequest("POST", "/api/reports", payload);
      return await res.json();
    },
    onSuccess: () => {
      toast.success("Report Filed Successfully");
      queryClient.invalidateQueries({ queryKey: ["/api/reports"] });
      setIsDialogOpen(false);
      // Reset form to defaults
      form.reset({
        category: "customer",
        severity: "low",
        dateOccurred: new Date(),
        timeOccurred: format(new Date(), "HH:mm"),
        involvedPeople: [],
        details: { items: [] }
      });
    },
    onError: (err) => {
        console.error("Submission Error:", err);
        toast.error("Failed to file report", { description: err.message });
    }
  });

  // Form Validation Error Callback
  const onInvalid = (errors: FieldErrors<ReportForm>) => {
    const firstErrorKey = Object.keys(errors)[0];
    const errorMessage = errors[firstErrorKey as keyof ReportForm]?.message;
    toast.error("Validation Error", { description: errorMessage ? String(errorMessage) : "Please check the form fields." });
  };

  // --- HELPER FUNCTIONS FOR DYNAMIC LISTS ---

  const addPerson = () => {
      if (!newPerson.trim()) return;
      const current = form.getValues("involvedPeople");
      if (!current.includes(newPerson)) {
          form.setValue("involvedPeople", [...current, newPerson]);
          form.trigger("involvedPeople"); // Re-validate
      }
      setNewPerson("");
  };

  const addStaffFromSelect = (name: string) => {
      const current = form.getValues("involvedPeople");
      if (!current.includes(name)) {
          form.setValue("involvedPeople", [...current, name]);
          form.trigger("involvedPeople");
      }
  };

  const removePerson = (index: number) => {
      const current = form.getValues("involvedPeople");
      form.setValue("involvedPeople", current.filter((_, i) => i !== index));
      form.trigger("involvedPeople");
  };

  const addItem = () => {
      if (!newItem.name.trim()) return;
      const current = form.getValues("details.items") || [];
      form.setValue("details.items", [...current, newItem]);
      setNewItem({ name: "", quantity: 1, cost: 0 });
  };

  const removeItem = (index: number) => {
      const current = form.getValues("details.items") || [];
      form.setValue("details.items", current.filter((_, i) => i !== index));
  };

  // State for "View Details" Modal
  const [selectedReport, setSelectedReport] = useState<any>(null);
  const [isViewOpen, setIsViewOpen] = useState(false);

  return (
    <div className="p-6 md:p-8 max-w-7xl mx-auto space-y-8">
      {/* --- PAGE HEADER --- */}
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h1 className="text-3xl font-bold text-slate-900">Incident Reporting</h1>
          <p className="text-slate-500 mt-1">Official documentation for workplace incidents</p>
        </div>
        <div className="flex items-center gap-2">
            {/* View Switcher */}
            <div className="flex items-center bg-slate-100 p-1 rounded-lg">
                <Button 
                    variant="ghost" 
                    size="sm" 
                    onClick={() => setView("list")}
                    className={cn("text-xs", view === "list" && "bg-white shadow-sm text-slate-900")}
                >
                    <ListIcon className="w-4 h-4 mr-2" /> Reports
                </Button>
                <Button 
                    variant="ghost" 
                    size="sm" 
                    onClick={() => setView("analytics")}
                    className={cn("text-xs", view === "analytics" && "bg-white shadow-sm text-slate-900")}
                >
                    <BarChart3 className="w-4 h-4 mr-2" /> Analytics
                </Button>
            </div>
            
            {/* Create Report Dialog */}
            <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
              <DialogTrigger asChild>
                <Button className="bg-slate-900 text-white rounded-full px-6 shadow-lg hover:bg-slate-800 ml-2">
                  <Plus className="w-4 h-4 mr-2" /> File Report
                </Button>
              </DialogTrigger>
              <DialogContent className="max-w-3xl max-h-[90vh] overflow-y-auto rounded-xl">
                <DialogHeader className="border-b border-slate-100 pb-4">
                  <DialogTitle>File Incident Report</DialogTitle>
                  <DialogDescription>Please provide factual, objective details.</DialogDescription>
                </DialogHeader>

                <form onSubmit={form.handleSubmit((d) => createReportMutation.mutate(d), onInvalid)} className="space-y-6 pt-4">
                  {/* Classification */}
                  <div className="grid grid-cols-2 gap-4">
                      <div className="space-y-2">
                          <Label>Category</Label>
                          <Select value={selectedCategory} onValueChange={(val: any) => form.setValue("category", val)}>
                              <SelectTrigger><SelectValue /></SelectTrigger>
                              <SelectContent>
                                  {categories.map((cat) => (
                                      <SelectItem key={cat.id} value={cat.id}>{cat.label}</SelectItem>
                                  ))}
                              </SelectContent>
                          </Select>
                      </div>
                      <div className="space-y-2">
                          <Label>Severity</Label>
                          <Select onValueChange={(val) => form.setValue("severity", val)} defaultValue="low">
                              <SelectTrigger><SelectValue /></SelectTrigger>
                              <SelectContent>
                                  <SelectItem value="low">Low</SelectItem>
                                  <SelectItem value="medium">Medium</SelectItem>
                                  <SelectItem value="high">High</SelectItem>
                                  <SelectItem value="critical">Critical</SelectItem>
                              </SelectContent>
                          </Select>
                      </div>
                  </div>

                  {/* Time & Location */}
                  <div className="grid grid-cols-3 gap-4">
                      <div className="space-y-2">
                          <Label>Date</Label>
                          <Input 
                            type="date" 
                            // Manually bind date input to handle Date object from form state
                            value={format(new Date(form.watch("dateOccurred")), "yyyy-MM-dd")} 
                            onChange={(e) => {
                                const value = e.target.value;
                                if (value) form.setValue("dateOccurred", new Date(value), { shouldValidate: true });
                            }} 
                          />
                          {form.formState.errors.dateOccurred && <p className="text-xs text-red-500">{form.formState.errors.dateOccurred.message}</p>}
                      </div>
                      <div className="space-y-2">
                          <Label>Time</Label>
                          <Input type="time" {...form.register("timeOccurred")} />
                          {form.formState.errors.timeOccurred && <p className="text-xs text-red-500">{form.formState.errors.timeOccurred.message}</p>}
                      </div>
                      <div className="space-y-2">
                          <Label>Location</Label>
                          <Input placeholder="e.g. Kitchen" {...form.register("location")} />
                          {form.formState.errors.location && <p className="text-xs text-red-500">{form.formState.errors.location.message}</p>}
                      </div>
                  </div>

                  {/* Narrative */}
                  <div className="space-y-2">
                      <Label>Title</Label>
                      <Input placeholder="Brief summary" {...form.register("title")} />
                      {form.formState.errors.title && <p className="text-xs text-red-500">{form.formState.errors.title.message}</p>}
                  </div>
                  <div className="space-y-2">
                      <Label>Description</Label>
                      <Textarea placeholder="Detailed description..." {...form.register("description")} />
                      {form.formState.errors.description && <p className="text-xs text-red-500">{form.formState.errors.description.message}</p>}
                  </div>
                  
                  {/* Actions & Witnesses */}
                  <div className="grid grid-cols-2 gap-4">
                    <div className="space-y-2">
                        <Label>Action Taken</Label>
                        <Textarea placeholder="Immediate actions..." {...form.register("actionTaken")} />
                        {form.formState.errors.actionTaken && <p className="text-xs text-red-500">{form.formState.errors.actionTaken.message}</p>}
                    </div>
                    <div className="space-y-2">
                        <Label>Witnesses</Label>
                        <Textarea placeholder="Names/Contacts..." {...form.register("witnesses")} />
                        {form.formState.errors.witnesses && <p className="text-xs text-red-500">{form.formState.errors.witnesses.message}</p>}
                    </div>
                  </div>

                  {/* People Involved (Dynamic List) */}
                  <div className="space-y-3 p-4 bg-slate-50/50 rounded-lg border border-slate-100">
                      <Label>People Involved <span className="text-red-500">*</span></Label>
                      <div className="flex flex-col gap-3">
                          {/* Staff Dropdown */}
                          <div className="flex flex-col gap-1.5">
                              <span className="text-xs text-slate-500 font-medium">Add Staff Member</span>
                              <Select onValueChange={addStaffFromSelect}>
                                  <SelectTrigger className="bg-white border-slate-200">
                                      <SelectValue placeholder="Select from team..." />
                                  </SelectTrigger>
                                  <SelectContent>
                                      {/* Filter out admins from selection */}
                                      {teamMembers?.filter(m => m.role !== 'admin').map((member) => (
                                          <SelectItem key={member.id} value={`${member.firstName} ${member.lastName}`}>
                                              {member.firstName} {member.lastName} <span className="text-xs text-slate-400 ml-1">({member.position})</span>
                                          </SelectItem>
                                      ))}
                                  </SelectContent>
                              </Select>
                          </div>

                          {/* Manual Input */}
                          <div className="flex flex-col gap-1.5">
                              <span className="text-xs text-slate-500 font-medium">Add Guest / Other</span>
                              <div className="flex gap-2">
                                  <Input 
                                      value={newPerson} 
                                      onChange={(e) => setNewPerson(e.target.value)} 
                                      placeholder="Type name manually..." 
                                      className="bg-white"
                                      onKeyDown={(e) => { if(e.key === 'Enter') { e.preventDefault(); addPerson(); } }}
                                  />
                                  <Button type="button" onClick={addPerson} variant="outline" className="bg-white">Add</Button>
                              </div>
                          </div>
                      </div>

                      {/* Chips for Selected People */}
                      {currentPeople.length > 0 && (
                          <div className="flex flex-wrap gap-2 mt-2 pt-2 border-t border-slate-200/60">
                              {currentPeople.map((p, i) => (
                                  <Badge key={i} variant="secondary" className="pl-2 pr-1 py-1 flex items-center gap-1 bg-white border border-slate-200">
                                      {p} <button type="button" onClick={() => removePerson(i)} className="hover:bg-slate-100 rounded-full p-0.5"><X className="w-3 h-3 text-slate-400 hover:text-red-500" /></button>
                                  </Badge>
                              ))}
                          </div>
                      )}
                      {form.formState.errors.involvedPeople && <p className="text-xs text-red-500 flex items-center gap-1"><AlertCircle className="w-3 h-3" /> {form.formState.errors.involvedPeople.message}</p>}
                  </div>

                  {/* Property Details (Only for Property Reports) */}
                  {selectedCategory === 'property' && (
                      <div className="bg-slate-50 p-4 rounded-lg space-y-4 border border-slate-200">
                          <h4 className="font-medium text-sm text-slate-900">Damaged Items</h4>
                          <div className="grid grid-cols-12 gap-2 items-end">
                              <div className="col-span-6"><Label className="text-xs">Item Name</Label><Input value={newItem.name} onChange={e => setNewItem({...newItem, name: e.target.value})} placeholder="e.g. Plate" /></div>
                              <div className="col-span-2"><Label className="text-xs">Qty</Label><Input type="number" value={newItem.quantity} onChange={e => setNewItem({...newItem, quantity: +e.target.value})} /></div>
                              <div className="col-span-3"><Label className="text-xs">Cost ($)</Label><Input type="number" value={newItem.cost} onChange={e => setNewItem({...newItem, cost: +e.target.value})} /></div>
                              <div className="col-span-1"><Button type="button" size="icon" onClick={addItem}><Plus className="w-4 h-4" /></Button></div>
                          </div>
                          <div className="space-y-2">{currentItems.map((item, i) => <div key={i} className="flex justify-between items-center text-sm bg-white p-2 rounded border"><span>{item.quantity}x {item.name} (${item.cost})</span><button type="button" onClick={() => removeItem(i)}><X className="w-4 h-4 hover:text-red-500" /></button></div>)}</div>
                      </div>
                  )}

                  <DialogFooter>
                    <Button type="button" variant="ghost" onClick={() => setIsDialogOpen(false)}>Cancel</Button>
                    <Button type="submit" disabled={createReportMutation.isPending}>
                        {createReportMutation.isPending ? "Submitting..." : "Submit Report"}
                    </Button>
                  </DialogFooter>
                </form>
              </DialogContent>
            </Dialog>
        </div>
      </div>

      {view === "list" ? (
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            {/* Main Reports List */}
            <Card className="bg-white border-slate-200 shadow-sm md:col-span-2">
                <CardContent className="p-0">
                    {/* --- FILTER BAR (Embedded) --- */}
                    <div className="flex flex-wrap gap-2 p-3 border-b border-slate-100 bg-slate-50/50 rounded-t-xl">
                        <Select value={categoryFilter} onValueChange={setCategoryFilter}>
                            <SelectTrigger className="w-[180px] h-8 text-xs"><SelectValue placeholder="Category" /></SelectTrigger>
                            <SelectContent>
                                <SelectItem value="all">All Categories</SelectItem>
                                {categories.map(c => <SelectItem key={c.id} value={c.id}>{c.label}</SelectItem>)}
                            </SelectContent>
                        </Select>
                        <Select value={statusFilter} onValueChange={setStatusFilter}>
                            <SelectTrigger className="w-[140px] h-8 text-xs"><SelectValue placeholder="Status" /></SelectTrigger>
                            <SelectContent><SelectItem value="all">All Status</SelectItem><SelectItem value="pending">Pending</SelectItem><SelectItem value="resolved">Resolved</SelectItem></SelectContent>
                        </Select>
                        {(categoryFilter !== 'all' || statusFilter !== 'all') && (
                            <Button variant="ghost" size="sm" onClick={() => {setCategoryFilter('all'); setStatusFilter('all')}} className="h-8 text-xs">Reset</Button>
                        )}
                    </div>

                    {/* --- LIST ITEMS --- */}
                    <div className="divide-y divide-slate-100 min-h-[300px]">
                        {isLoading ? <div className="p-8 text-center text-slate-400">Loading...</div> : 
                        paginatedReports.length === 0 ? <div className="p-8 text-center text-slate-400">No reports found.</div> :
                        paginatedReports.map((report: any) => (
                            <div key={report.id} onClick={() => { setSelectedReport(report); setIsViewOpen(true); }} className="flex items-center justify-between p-4 hover:bg-slate-50 cursor-pointer group transition-colors">
                                <div className="flex items-center gap-4">
                                    <div className={cn("w-10 h-10 rounded-full flex items-center justify-center", categories.find(c=>c.id===report.category)?.color)}>
                                        {(() => { const Icon = categories.find(c=>c.id===report.category)?.icon || FileText; return <Icon className="w-5 h-5" /> })()}
                                    </div>
                                    <div>
                                        <h4 className="text-sm font-bold text-slate-800">{report.title}</h4>
                                        <div className="flex items-center gap-2 text-xs text-slate-500 mt-0.5">
                                                <span>{format(new Date(report.dateOccurred), "MMM dd")}</span>
                                                <span>â¢</span>
                                                <span className="capitalize">{report.severity} Priority</span>
                                        </div>
                                    </div>
                                </div>
                                <Badge variant={report.status === 'resolved' ? 'default' : 'secondary'} className="capitalize">{report.status}</Badge>
                            </div>
                        ))}
                    </div>
                    
                    {/* --- PAGINATION FOOTER --- */}
                    {filteredReports.length > 0 && (
                        <div className="flex items-center justify-between p-3 border-t border-slate-100 bg-white rounded-b-xl">
                            <div className="text-xs text-slate-500 font-medium">
                                Showing {(currentPage - 1) * itemsPerPage + 1} - {Math.min(currentPage * itemsPerPage, filteredReports.length)} of {filteredReports.length}
                            </div>
                            <div className="flex items-center gap-1">
                                <Button 
                                    variant="outline" 
                                    size="icon" 
                                    className="h-7 w-7" 
                                    onClick={() => setCurrentPage(1)} 
                                    disabled={currentPage === 1}
                                >
                                    <ChevronsLeft className="w-3 h-3" />
                                </Button>
                                <Button 
                                    variant="outline" 
                                    size="icon" 
                                    className="h-7 w-7" 
                                    onClick={() => setCurrentPage(prev => Math.max(1, prev - 1))} 
                                    disabled={currentPage === 1}
                                >
                                    <ChevronLeft className="w-3 h-3" />
                                </Button>
                                <span className="text-xs font-medium px-2 min-w-[3rem] text-center">
                                    {currentPage} / {totalPages || 1}
                                </span>
                                <Button 
                                    variant="outline" 
                                    size="icon" 
                                    className="h-7 w-7" 
                                    onClick={() => setCurrentPage(prev => Math.min(totalPages, prev + 1))} 
                                    disabled={currentPage === totalPages}
                                >
                                    <ChevronRight className="w-3 h-3" />
                                </Button>
                                <Button 
                                    variant="outline" 
                                    size="icon" 
                                    className="h-7 w-7" 
                                    onClick={() => setCurrentPage(totalPages)} 
                                    disabled={currentPage === totalPages}
                                >
                                    <ChevronsRight className="w-3 h-3" />
                                </Button>
                            </div>
                        </div>
                    )}
                </CardContent>
            </Card>

            {/* --- MOST INVOLVED SIDEBAR --- */}
            <Card className="bg-white border-slate-200 shadow-sm h-fit">
                <CardHeader className="pb-2">
                    <CardTitle className="text-sm font-bold text-slate-700 flex items-center gap-2">
                        <Users className="w-4 h-4" /> Most Involved
                    </CardTitle>
                    <CardDescription className="text-xs">Frequent names in recent incidents</CardDescription>
                </CardHeader>
                <CardContent>
                    <div className="space-y-3">
                        {stats.mostInvolved?.map(([name, count], i) => (
                            <div key={name} className="flex items-center justify-between text-sm">
                                <div className="flex items-center gap-2">
                                    <span className={cn("w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold", i === 0 ? "bg-red-100 text-red-600" : "bg-slate-100 text-slate-600")}>
                                        {i + 1}
                                    </span>
                                    <span className="text-slate-700 font-medium truncate max-w-[120px]" title={name}>{name}</span>
                                </div>
                                <Badge variant="secondary" className="text-[10px]">{count} Reports</Badge>
                            </div>
                        ))}
                        {(!stats.mostInvolved || stats.mostInvolved.length === 0) && <div className="text-center text-slate-400 text-xs py-4">No data available</div>}
                    </div>
                </CardContent>
            </Card>
        </div>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* Chart 1: Trend Over Time */}
            <Card>
                <CardHeader>
                    <CardTitle className="text-lg">Incident Trend (Last 6 Months)</CardTitle>
                    <CardDescription>Number of reports filed per month</CardDescription>
                </CardHeader>
                <CardContent>
                    <div className="h-[300px] w-full">
                        <ResponsiveContainer width="100%" height="100%">
                            <BarChart data={stats.monthly}>
                                <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                <XAxis dataKey="name" fontSize={12} tickLine={false} axisLine={false} />
                                <YAxis fontSize={12} tickLine={false} axisLine={false} allowDecimals={false} />
                                <RechartsTooltip 
                                    cursor={{fill: 'transparent'}}
                                    contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 4px 12px rgba(0,0,0,0.1)'}}
                                />
                                <Bar dataKey="count" fill="#3b82f6" radius={[4, 4, 0, 0]} />
                            </BarChart>
                        </ResponsiveContainer>
                    </div>
                </CardContent>
            </Card>

            {/* Chart 2: Category Breakdown */}
            <Card>
                <CardHeader>
                    <CardTitle className="text-lg">Incidents by Category</CardTitle>
                    <CardDescription>Distribution of report types</CardDescription>
                </CardHeader>
                <CardContent>
                    <div className="h-[300px] w-full">
                        <ResponsiveContainer width="100%" height="100%">
                            <PieChart>
                                <Pie
                                    data={stats.byCategory}
                                    cx="50%"
                                    cy="50%"
                                    innerRadius={60}
                                    outerRadius={80}
                                    paddingAngle={5}
                                    dataKey="value"
                                >
                                    {stats.byCategory.map((entry, index) => (
                                        <Cell key={`cell-${index}`} fill={entry.fill} />
                                    ))}
                                </Pie>
                                <RechartsTooltip />
                                <Legend />
                            </PieChart>
                        </ResponsiveContainer>
                    </div>
                </CardContent>
            </Card>
        </div>
      )}

      {/* View Details Dialog */}
      <Dialog open={isViewOpen} onOpenChange={setIsViewOpen}>
        <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
            {selectedReport && (
                <>
                    <DialogHeader>
                        <div className="flex items-center gap-3 mb-2">
                            <Badge variant="outline" className="uppercase tracking-wider text-[10px]">
                                {categories.find(c => c.id === selectedReport.category)?.label || "Report"}
                            </Badge>
                            <Badge className={cn("capitalize", 
                                selectedReport.severity === 'critical' ? "bg-red-100 text-red-700 hover:bg-red-100" : "bg-slate-100 text-slate-700 hover:bg-slate-100"
                            )}>
                                {selectedReport.severity} Priority
                            </Badge>
                        </div>
                        <DialogTitle className="text-2xl font-bold text-slate-900">{selectedReport.title}</DialogTitle>
                        <DialogDescription className="flex items-center gap-2 text-slate-500">
                            <CalendarIcon className="w-4 h-4" /> {format(new Date(selectedReport.dateOccurred), "MMMM dd, yyyy")} 
                            <Clock className="w-4 h-4 ml-2" /> {selectedReport.timeOccurred}
                        </DialogDescription>
                    </DialogHeader>

                    <div className="space-y-6 py-4">
                        <div className="grid grid-cols-2 gap-4 p-4 bg-slate-50 rounded-xl border border-slate-100">
                            <div className="space-y-1">
                                <span className="text-xs font-semibold text-slate-400 uppercase">Location</span>
                                <div className="flex items-center gap-2 font-medium text-slate-900">
                                    <MapPin className="w-4 h-4 text-slate-400" />
                                    {selectedReport.location}
                                </div>
                            </div>
                            <div className="space-y-1">
                                <span className="text-xs font-semibold text-slate-400 uppercase">Status</span>
                                <div className="flex items-center gap-2 font-medium text-slate-900 capitalize">
                                    {selectedReport.status === 'resolved' ? <CheckCircle2 className="w-4 h-4 text-emerald-500" /> : <AlertCircle className="w-4 h-4 text-amber-500" />}
                                    {selectedReport.status}
                                </div>
                            </div>
                        </div>

                        <div className="space-y-4">
                            <div>
                                <h4 className="text-sm font-bold text-slate-900 mb-2">Incident Description</h4>
                                <p className="text-sm text-slate-600 leading-relaxed bg-white border border-slate-100 p-3 rounded-lg">{selectedReport.description}</p>
                            </div>
                            <div>
                                <h4 className="text-sm font-bold text-slate-900 mb-2">Immediate Action Taken</h4>
                                <p className="text-sm text-slate-600 leading-relaxed bg-white border border-slate-100 p-3 rounded-lg">{selectedReport.actionTaken || "No immediate action recorded."}</p>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="space-y-1">
                                <span className="text-xs font-semibold text-slate-400 uppercase">Witnesses</span>
                                <p className="text-sm font-medium text-slate-900">{selectedReport.witnesses || "None listed"}</p>
                            </div>
                            <div className="space-y-1">
                                <span className="text-xs font-semibold text-slate-400 uppercase">Parties Involved</span>
                                <p className="text-sm font-medium text-slate-900">{selectedReport.partiesInvolved || "None listed"}</p>
                            </div>
                        </div>

                        {selectedReport.details && Object.keys(selectedReport.details).length > 0 && (
                            <div className="bg-blue-50/50 p-4 rounded-xl border border-blue-100">
                                <h4 className="text-sm font-bold text-blue-900 mb-3">Additional Details</h4>
                                <div className="grid grid-cols-1 gap-2">
                                    {/* Render Items List if property damage */}
                                    {selectedReport.details.items && Array.isArray(selectedReport.details.items) ? (
                                        <div className="space-y-2">
                                            {selectedReport.details.items.map((item: any, idx: number) => (
                                                <div key={idx} className="flex justify-between text-sm border-b border-blue-100 pb-1 last:border-0">
                                                    <span>{item.quantity}x {item.name}</span>
                                                    <span className="font-mono text-blue-800">${item.cost}</span>
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="grid grid-cols-2 gap-4">
                                            {Object.entries(selectedReport.details).map(([key, value]) => (
                                                key !== 'items' && (
                                                    <div key={key}>
                                                        <span className="text-xs text-blue-600/70 uppercase font-semibold block mb-1">{key.replace(/([A-Z])/g, ' $1').trim()}</span>
                                                        <span className="text-sm font-medium text-blue-900">{value as string}</span>
                                                    </div>
                                                )
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>

                    <DialogFooter>
                        <Button variant="outline" onClick={() => setIsViewOpen(false)}>Close</Button>
                    </DialogFooter>
                </>
            )}
        </DialogContent>
      </Dialog>
    </div>
  );
}


===== salary-computation.tsx =====
import { useState, useEffect } from "react";
import { useAuth } from "@/hooks/use-auth";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Separator } from "@/components/ui/separator";
import { Calculator, Plus, Minus, RefreshCw } from "lucide-react";

export default function SalaryComputation() {
  const { user } = useAuth();

  // Determine Hourly Rate based on user's salary or default
  const getHourlyRate = () => {
    if (user?.salary) {
      // Assuming salary is stored in cents
      return (user.salary / 100) / 22 / 8;
    }
    return 58.75;
  };

  const HOURLY_RATE = getHourlyRate();
  const OVERTIME_RATE = 1.25;
  const OVERTIME_PER_HOUR = HOURLY_RATE * OVERTIME_RATE;

  const [hoursWorked, setHoursWorked] = useState(0);
  const [overtimeHours, setOvertimeHours] = useState(0);

  // Deductions State
  const [tax, setTax] = useState(0);
  const [sss, setSss] = useState(0);
  const [philHealth, setPhilHealth] = useState(0);
  const [pagIbig, setPagIbig] = useState(0);
  const [others, setOthers] = useState(0);

  const formatCurrency = (amount: number) =>
    new Intl.NumberFormat("en-PH", {
      style: "currency",
      currency: "PHP",
    }).format(amount);

  // --- Computations ---
  const basicPay = hoursWorked * HOURLY_RATE;
  const overtimePay = overtimeHours * OVERTIME_PER_HOUR;
  const calculateGrossPay = () => basicPay + overtimePay;
  const calculateTotalDeductions = () => tax + sss + philHealth + pagIbig + others;
  
  const calculateNetPay = () =>
    Math.max(0, calculateGrossPay() - calculateTotalDeductions());

  // --- Compute Pag-IBIG ---
  const computePagIbig = (grossSalary: number) => {
    const capped = Math.min(grossSalary, 10000);
    return capped * 0.02;
  };

  // --- Compute PhilHealth ---
  const computePhilHealth = (grossSalary: number) => {
    let income = grossSalary;
    if (income < 10000) income = 10000;
    if (income > 100000) income = 100000;
    return (income * 0.05) / 2;
  };

  // --- Compute SSS ---
  const computeSSS = (grossSalary: number) => {
    const msc = Math.min(grossSalary, 30000);
    return msc * 0.045;
  };

  // --- Updated autoCalculateDeductions ---
  const autoCalculateDeductions = (grossSalary: number) => {
    // Tax: Set to 0 to align with current system configuration
    const calculatedTax = 0; 

    const sssVal = computeSSS(grossSalary);
    const philHealthVal = computePhilHealth(grossSalary);
    const pagIbigVal = computePagIbig(grossSalary);

    setTax(calculatedTax);
    setSss(sssVal);
    setPhilHealth(philHealthVal);
    setPagIbig(pagIbigVal);
  };

  useEffect(() => {
    // Recalculate deductions based on Basic Pay
    autoCalculateDeductions(basicPay); 
  }, [hoursWorked, overtimeHours, basicPay]);

  const resetForm = () => {
    setHoursWorked(0);
    setOvertimeHours(0);
    setOthers(0);
  };

  return (
    <div className="p-6">
      <div className="max-w-5xl mx-auto space-y-6">
        <div>
          <h1 className="text-2xl font-bold flex items-center">
            <Calculator className="w-6 h-6 mr-2" />
            Salary Calculator
          </h1>
          <p className="text-muted-foreground">
            Estimate your net pay based on hours worked.
          </p>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div className="lg:col-span-2 space-y-6">
            {/* Earnings */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center text-green-700">
                  <Plus className="w-5 h-5 mr-2" />
                  Earnings
                </CardTitle>
                <CardDescription>
                    Rate: {formatCurrency(HOURLY_RATE)}/hr (Based on your profile)
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <Label>Regular Hours</Label>
                        <Input
                            type="number"
                            min="0"
                            value={hoursWorked}
                            onChange={(e) => setHoursWorked(Math.max(0, parseFloat(e.target.value) || 0))}
                            placeholder="e.g. 80"
                        />
                    </div>
                    <div>
                        <Label>Overtime Hours</Label>
                        <Input
                            type="number"
                            min="0"
                            value={overtimeHours}
                            onChange={(e) => setOvertimeHours(Math.max(0, parseFloat(e.target.value) || 0))}
                            placeholder="e.g. 5"
                        />
                        <p className="text-xs text-muted-foreground mt-1">
                            Rate: {formatCurrency(OVERTIME_PER_HOUR)}/hr
                        </p>
                    </div>
                </div>
              </CardContent>
            </Card>

            {/* Deductions */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center text-red-700">
                  <Minus className="w-5 h-5 mr-2" />
                  Deductions (Estimated)
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <Label>SSS</Label>
                        <Input value={formatCurrency(sss)} readOnly className="bg-gray-50" />
                    </div>
                    <div>
                        <Label>PhilHealth</Label>
                        <Input value={formatCurrency(philHealth)} readOnly className="bg-gray-50" />
                    </div>
                    <div>
                        <Label>Pag-IBIG</Label>
                        <Input value={formatCurrency(pagIbig)} readOnly className="bg-gray-50" />
                    </div>
                    <div>
                        <Label>Other Deductions</Label>
                        <Input
                            type="number"
                            min="0"
                            value={others}
                            onChange={(e) => setOthers(Math.max(0, parseFloat(e.target.value) || 0))}
                        />
                    </div>
                </div>
              </CardContent>
            </Card>
          </div>

          {/* Summary */}
          <div className="space-y-6">
            <Card className="sticky top-6">
              <CardHeader className="bg-primary/5">
                <CardTitle className="flex items-center justify-between">
                  Summary
                  <RefreshCw className="w-4 h-4 text-muted-foreground cursor-pointer hover:text-primary" onClick={resetForm} />
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-4 pt-6">
                <div className="space-y-2">
                    <div className="flex justify-between text-sm">
                        <span className="text-muted-foreground">Basic Pay</span>
                        <span>{formatCurrency(basicPay)}</span>
                    </div>
                    <div className="flex justify-between text-sm">
                        <span className="text-muted-foreground">Overtime</span>
                        <span>{formatCurrency(overtimePay)}</span>
                    </div>
                    <Separator />
                    <div className="flex justify-between font-medium">
                        <span>Gross Pay</span>
                        <span className="text-green-600">{formatCurrency(calculateGrossPay())}</span>
                    </div>
                </div>

                <div className="space-y-2">
                    <div className="flex justify-between text-sm">
                        <span className="text-muted-foreground">Total Deductions</span>
                        <span className="text-red-600">-{formatCurrency(calculateTotalDeductions())}</span>
                    </div>
                </div>

                <Separator className="my-4" />
                
                <div className="flex justify-between items-end">
                  <span className="font-bold text-lg">Net Pay</span>
                  <span className="text-2xl font-bold text-primary">
                    {formatCurrency(calculateNetPay())}
                  </span>
                </div>
              </CardContent>
            </Card>
          </div>
        </div>
      </div>
    </div>
  );
}


===== schedules.tsx =====
import { useState } from "react";
import { useQuery } from "@tanstack/react-query";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Skeleton } from "@/components/ui/skeleton";
import { Calendar, Clock, ChevronLeft, ChevronRight, CalendarDays, MapPin } from "lucide-react";
import type { Schedule } from "@shared/schema";
import { Loader2 } from "lucide-react";

export default function Schedules() {
  const [currentDate, setCurrentDate] = useState(new Date());

  const getWeekBounds = (date: Date) => {
    const start = new Date(date);
    start.setDate(date.getDate() - date.getDay()); // Set to Sunday
    start.setHours(0, 0, 0, 0);
    
    const end = new Date(start);
    end.setDate(start.getDate() + 6); // Set to Saturday
    end.setHours(23, 59, 59, 999);
    
    return { start, end };
  };

  const { start: weekStart, end: weekEnd } = getWeekBounds(currentDate);

  const { data: schedules, isLoading } = useQuery<Schedule[]>({
    queryKey: ["/api/schedules"],
  });

  const navigateWeek = (direction: 'prev' | 'next') => {
    const newDate = new Date(currentDate);
    newDate.setDate(currentDate.getDate() + (direction === 'next' ? 7 : -7));
    setCurrentDate(newDate);
  };

  const getDaysOfWeek = () => {
    const days = [];
    const start = new Date(weekStart);
    
    for (let i = 0; i < 7; i++) {
      const day = new Date(start);
      day.setDate(start.getDate() + i);
      days.push(day);
    }
    
    return days;
  };

  const getScheduleForDate = (viewDate: Date) => {
    if (!schedules) return null;
    const viewDateStr = viewDate.toLocaleDateString('en-CA'); 

    return schedules.find((schedule: any) => {
      const scheduleDate = new Date(schedule.date);
      const scheduleDateStr = scheduleDate.toISOString().split('T')[0];
      return scheduleDateStr === viewDateStr;
    });
  };

  const formatTime = (time: number | null) => {
    if (!time) return '';
    const date = new Date(time);
    if (isNaN(date.getTime())) return '';

    return date.toLocaleTimeString('en-US', {
      hour: 'numeric',
      minute: '2-digit',
      hour12: true,
    });
  };

  const getShiftBadge = (shiftType: string) => {
    const styles = {
        morning: "bg-emerald-100 text-emerald-700 border-emerald-200",
        afternoon: "bg-amber-100 text-amber-700 border-amber-200",
        night: "bg-indigo-100 text-indigo-700 border-indigo-200",
        off: "bg-slate-100 text-slate-500 border-slate-200"
    };
    const style = styles[shiftType as keyof typeof styles] || styles.morning;
    
    return (
      <Badge variant="outline" className={`${style} px-2 py-0.5 text-[10px] font-bold uppercase tracking-wider border`}>
        {shiftType}
      </Badge>
    );
  };

  const getRoleBadge = (role: string) => {
    return <span className="text-[10px] font-semibold text-slate-500 uppercase tracking-wider bg-slate-100 px-1.5 py-0.5 rounded-md">{role}</span>;
  };

  const formatDateHeader = (date: Date) => {
    return date.toLocaleDateString('en-US', { weekday: 'short' });
  };
  
  const formatDayNumber = (date: Date) => {
    return date.getDate();
  };

  const formatWeekRange = () => {
    return `${weekStart.toLocaleDateString('en-US', { 
      month: 'short', 
      day: 'numeric' 
    })} - ${weekEnd.toLocaleDateString('en-US', { 
      month: 'short', 
      day: 'numeric',
      year: 'numeric'
    })}`;
  };

  const isToday = (date: Date) => {
    const today = new Date();
    return date.toDateString() === today.toDateString();
  };

  return (
    <div className="p-6 md:p-8 max-w-7xl mx-auto space-y-8">
      
      {/* Header & Controls */}
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-6">
        <div>
          <h1 className="text-3xl font-bold tracking-tight text-slate-900" data-testid="page-title">My Schedule</h1>
          <p className="text-slate-500 mt-1 text-sm">View your upcoming shifts and work hours</p>
        </div>
        
        {/* Glass Toolbar */}
        <div className="flex items-center bg-white/80 backdrop-blur-md p-1.5 rounded-2xl border border-slate-200/60 shadow-sm">
            <div className="flex items-center gap-1 pr-2 border-r border-slate-200 mr-2">
                <Button variant="ghost" size="icon" onClick={() => navigateWeek('prev')} className="h-8 w-8 rounded-lg hover:bg-slate-100" data-testid="button-prev-week">
                    <ChevronLeft className="w-4 h-4 text-slate-600" />
                </Button>
                <div className="px-2 text-sm font-medium text-slate-700 min-w-[140px] text-center">
                    {formatWeekRange()}
                </div>
                <Button variant="ghost" size="icon" onClick={() => navigateWeek('next')} className="h-8 w-8 rounded-lg hover:bg-slate-100" data-testid="button-next-week">
                    <ChevronRight className="w-4 h-4 text-slate-600" />
                </Button>
            </div>
            <Button 
                variant="ghost" 
                onClick={() => setCurrentDate(new Date())} 
                className="h-8 rounded-xl text-xs font-medium bg-slate-100 hover:bg-slate-200 text-slate-700 px-3"
                data-testid="button-today"
            >
                <CalendarDays className="w-3.5 h-3.5 mr-1.5" /> Today
            </Button>
        </div>
      </div>

      {/* Schedule Grid */}
      <Card className="glass-card">
        <CardContent className="p-6">
          {isLoading ? (
             <div className="flex flex-col items-center justify-center py-20 text-slate-400">
                <Loader2 className="w-8 h-8 animate-spin mb-2" />
                <p>Loading schedule...</p>
             </div>
          ) : (
            <div className="grid grid-cols-1 sm:grid-cols-7 gap-4">
              {getDaysOfWeek().map((day, index) => {
                const schedule = getScheduleForDate(day);
                const isCurrentDay = isToday(day);
                
                return (
                  <div 
                    key={index} 
                    className={`flex flex-col gap-3 p-3 rounded-2xl border min-h-[200px] transition-all duration-200
                        ${isCurrentDay 
                            ? 'bg-blue-50/80 border-blue-200 shadow-inner' 
                            : 'bg-white/60 border-slate-100 hover:border-slate-200 hover:bg-white/80'
                        }`}
                    data-testid={`day-${day.toISOString().split('T')[0]}`}
                  >
                    {/* Day Header */}
                    <div className={`text-center pb-2 border-b ${isCurrentDay ? 'border-blue-200' : 'border-slate-100'}`}>
                      <p className={`text-xs uppercase tracking-wider font-semibold ${isCurrentDay ? 'text-blue-600' : 'text-slate-400'}`}>
                        {formatDateHeader(day)}
                      </p>
                      <div className={`text-lg font-bold leading-tight ${isCurrentDay ? 'text-blue-700' : 'text-slate-700'}`}>
                        {formatDayNumber(day)}
                      </div>
                    </div>

                    {/* Shift Content */}
                    <div className="flex-1 flex flex-col justify-center">
                      {schedule ? (
                        <div className="relative group">
                            <div className="p-3 bg-white rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-all space-y-3">
                                <div className="flex justify-center items-center">
                                    {getShiftBadge(schedule.type)}
                                </div>
                                <div className="flex justify-center items-center">
                                    {schedule.shiftRole && getRoleBadge(schedule.shiftRole)}
                                </div>

                                {schedule.type !== 'off' && schedule.startTime && schedule.endTime ? (
                                    <div className="space-y-2">
                                        <div className="flex items-center gap-2 text-xs font-medium text-slate-700 bg-slate-50 p-1.5 rounded-lg">
                                            <Clock className="w-3.5 h-3.5 text-slate-400" />
                                            <div className="flex flex-col leading-none gap-0.5">
                                                <span>{formatTime(schedule.startTime)}</span>
                                                <span className="text-slate-400 text-[10px]">to {formatTime(schedule.endTime)}</span>
                                            </div>
                                        </div>
                                        {/* {schedule.location && (
                                            <div className="flex items-center gap-1.5 text-xs text-slate-500 px-1">
                                                <MapPin className="w-3 h-3" />
                                                <span className="truncate">{schedule.location}</span>
                                            </div>
                                        )} */}
                                    </div>
                                ) : (
                                    <div className="py-2 text-center">
                                        <p className="text-xs text-slate-400 italic">No work assigned</p>
                                    </div>
                                )}
                            </div>
                        </div>
                      ) : (
                        <div className="h-full flex items-center justify-center">
                            <div className="text-center">
                                <div className="w-8 h-8 bg-slate-100 rounded-full mx-auto mb-2 flex items-center justify-center">
                                    <span className="text-xs text-slate-300 font-bold">-</span>
                                </div>
                            </div>
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}


===== setup-wizard.tsx =====
import { useState } from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { useMutation } from "@tanstack/react-query";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Shield, CheckCircle, UserCog, Lock, Server, ArrowRight } from "lucide-react";

const adminSetupSchema = z.object({
  username: z.string().min(3, "Username must be at least 3 characters"),
  password: z.string().min(6, "Password must be at least 6 characters"),
  confirmPassword: z.string().min(1, "Please confirm your password"),
  email: z.string().email("Invalid email address"),
  firstName: z.string().min(1, "First name is required"),
  lastName: z.string().min(1, "Last name is required"),
}).refine((data) => data.password === data.confirmPassword, {
  message: "Passwords don't match",
  path: ["confirmPassword"],
});

type AdminSetupForm = z.infer<typeof adminSetupSchema>;

export default function SetupWizard() {
  const [isComplete, setIsComplete] = useState(false);

  const form = useForm<AdminSetupForm>({
    resolver: zodResolver(adminSetupSchema),
    defaultValues: {
      username: "",
      password: "",
      confirmPassword: "",
      email: "",
      firstName: "",
      lastName: "",
    },
  });

  const setupMutation = useMutation({
    mutationFn: async (data: AdminSetupForm) => {
      const { confirmPassword, ...adminData } = data;
      const response = await fetch("/api/setup/admin", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          ...adminData,
          role: "admin",
        }),
      });

      if (!response.ok) {
        const error = await response.text();
        throw new Error(error || "Failed to create admin account");
      }

      return response.json();
    },
    onSuccess: () => {
      setIsComplete(true);
    },
  });

  const onSubmit = (data: AdminSetupForm) => {
    setupMutation.mutate(data);
  };

  if (isComplete) {
    return (
      <div className="min-h-screen flex items-center justify-center p-8 bg-slate-50 relative overflow-hidden">
        {/* Background Decoration */}
        <div className="absolute top-0 left-0 w-full h-full bg-white/50 backdrop-blur-3xl z-0" />
        <div className="absolute top-1/4 right-1/4 w-96 h-96 bg-emerald-500/10 rounded-full blur-[100px] pointer-events-none" />
        
        <Card className="w-full max-w-md relative z-10 bg-white/80 backdrop-blur-xl border-slate-200/60 shadow-2xl rounded-3xl overflow-hidden">
          <CardContent className="pt-12 pb-12 px-8 text-center">
            <div className="mb-6 relative">
               <div className="w-24 h-24 bg-emerald-100 rounded-full flex items-center justify-center mx-auto animate-in zoom-in duration-500">
                  <CheckCircle className="w-12 h-12 text-emerald-600" />
               </div>
               <div className="absolute inset-0 bg-emerald-400/20 rounded-full animate-ping opacity-20 delay-300 duration-1000" />
            </div>
            
            <h2 className="text-2xl font-bold text-slate-900 mb-2">System Setup Complete!</h2>
            <p className="text-slate-500 mb-8">
              Your administrator account has been successfully created. You are ready to configure the workforce.
            </p>

            <Button
              className="w-full h-12 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white shadow-lg shadow-emerald-600/20 transition-all hover:scale-[1.02]"
              onClick={() => window.location.href = "/auth"}
            >
              Proceed to Login <ArrowRight className="w-4 h-4 ml-2" />
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="min-h-screen flex bg-slate-50 font-sans text-slate-900 relative overflow-hidden">
       {/* Background Blobs */}
       <div className="absolute top-[-10%] left-[-10%] w-[600px] h-[600px] bg-blue-200/20 rounded-full blur-[100px] pointer-events-none" />
       <div className="absolute bottom-[-10%] right-[-10%] w-[600px] h-[600px] bg-rose-200/20 rounded-full blur-[100px] pointer-events-none" />

       <div className="container mx-auto flex items-center justify-center p-4 md:p-8 relative z-10">
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-16 w-full max-w-6xl items-center">
             
             {/* Left Side: Intro & Bento Features */}
             <div className="hidden lg:block space-y-8">
                <div>
                   <h1 className="text-4xl md:text-5xl font-bold tracking-tight text-slate-900 mb-4">
                      Welcome to <span className="text-blue-600">ESSence</span>
                   </h1>
                   <p className="text-lg text-slate-600 leading-relaxed max-w-md">
                      Let's get your organization set up. Create your root administrator account to begin managing your workforce.
                   </p>
                </div>

                <div className="grid grid-cols-2 gap-4">
                   <div className="bg-white/60 backdrop-blur-md border border-white/20 p-5 rounded-2xl shadow-sm">
                      <div className="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center text-blue-600 mb-3">
                         <Shield className="w-5 h-5" />
                      </div>
                      <h3 className="font-semibold text-slate-800">Root Access</h3>
                      <p className="text-xs text-slate-500 mt-1">Full control over system settings and user roles.</p>
                   </div>
                   <div className="bg-white/60 backdrop-blur-md border border-white/20 p-5 rounded-2xl shadow-sm">
                      <div className="w-10 h-10 bg-emerald-100 rounded-xl flex items-center justify-center text-emerald-600 mb-3">
                         <UserCog className="w-5 h-5" />
                      </div>
                      <h3 className="font-semibold text-slate-800">User Management</h3>
                      <p className="text-xs text-slate-500 mt-1">Onboard managers, HR, and employees easily.</p>
                   </div>
                   <div className="bg-white/60 backdrop-blur-md border border-white/20 p-5 rounded-2xl shadow-sm col-span-2 flex items-center gap-4">
                      <div className="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center text-amber-600 flex-shrink-0">
                         <Server className="w-5 h-5" />
                      </div>
                      <div>
                         <h3 className="font-semibold text-slate-800">Centralized Database</h3>
                         <p className="text-xs text-slate-500">Secure storage for all organizational data.</p>
                      </div>
                   </div>
                </div>
             </div>

             {/* Right Side: Setup Form */}
             <Card className="w-full bg-white/80 backdrop-blur-xl border-slate-200/60 shadow-2xl rounded-3xl">
                <CardHeader className="space-y-1 text-center pb-8 pt-10">
                   <div className="w-16 h-16 bg-slate-900 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-slate-900/20">
                      <Lock className="w-8 h-8 text-white" />
                   </div>
                   <CardTitle className="text-2xl font-bold">Create Admin Account</CardTitle>
                   <CardDescription>This account will have full system privileges</CardDescription>
                </CardHeader>
                <CardContent className="px-8 pb-10">
                   <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-5">
                      <div className="grid grid-cols-2 gap-5">
                         <div className="space-y-2">
                            <Label htmlFor="firstName">First Name</Label>
                            <Input id="firstName" {...form.register("firstName")} className="rounded-xl bg-white/50 border-slate-200 focus:ring-blue-500/20" placeholder="Jane" />
                            {form.formState.errors.firstName && <p className="text-xs text-red-500">{form.formState.errors.firstName.message}</p>}
                         </div>
                         <div className="space-y-2">
                            <Label htmlFor="lastName">Last Name</Label>
                            <Input id="lastName" {...form.register("lastName")} className="rounded-xl bg-white/50 border-slate-200 focus:ring-blue-500/20" placeholder="Doe" />
                            {form.formState.errors.lastName && <p className="text-xs text-red-500">{form.formState.errors.lastName.message}</p>}
                         </div>
                      </div>

                      <div className="space-y-2">
                         <Label htmlFor="email">Email Address</Label>
                         <Input id="email" type="email" {...form.register("email")} className="rounded-xl bg-white/50 border-slate-200 focus:ring-blue-500/20" placeholder="admin@company.com" />
                         {form.formState.errors.email && <p className="text-xs text-red-500">{form.formState.errors.email.message}</p>}
                      </div>

                      <div className="space-y-2">
                         <Label htmlFor="username">Username</Label>
                         <Input id="username" {...form.register("username")} className="rounded-xl bg-white/50 border-slate-200 focus:ring-blue-500/20" placeholder="admin" />
                         {form.formState.errors.username && <p className="text-xs text-red-500">{form.formState.errors.username.message}</p>}
                      </div>

                      <div className="grid grid-cols-2 gap-5">
                         <div className="space-y-2">
                            <Label htmlFor="password">Password</Label>
                            <Input id="password" type="password" {...form.register("password")} className="rounded-xl bg-white/50 border-slate-200 focus:ring-blue-500/20" placeholder="â¢â¢â¢â¢â¢â¢" />
                            {form.formState.errors.password && <p className="text-xs text-red-500">{form.formState.errors.password.message}</p>}
                         </div>
                         <div className="space-y-2">
                            <Label htmlFor="confirmPassword">Confirm Password</Label>
                            <Input id="confirmPassword" type="password" {...form.register("confirmPassword")} className="rounded-xl bg-white/50 border-slate-200 focus:ring-blue-500/20" placeholder="â¢â¢â¢â¢â¢â¢" />
                            {form.formState.errors.confirmPassword && <p className="text-xs text-red-500">{form.formState.errors.confirmPassword.message}</p>}
                         </div>
                      </div>

                      <Button 
                         type="submit" 
                         className="w-full h-12 rounded-xl bg-slate-900 hover:bg-slate-800 text-white font-medium shadow-lg shadow-slate-900/20 mt-4"
                         disabled={setupMutation.isPending}
                      >
                         {setupMutation.isPending ? "Creating System..." : "Complete Setup"}
                      </Button>
                   </form>
                </CardContent>
             </Card>
          </div>
       </div>
    </div>
  );
}


===== shift-management.tsx =====
import { useState, useMemo, useEffect } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { apiRequest } from "@/lib/queryClient";
import { toast } from "sonner";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger, DialogFooter } from "@/components/ui/dialog";
import { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from "@/components/ui/alert-dialog";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { 
  Clock, ChevronLeft, ChevronRight, Plus, Edit, Trash2, 
  Copy, Users, CalendarDays, MapPin, Grid, List, Calendar as CalendarIcon, 
  Sun, Moon, Sunset, Filter, LayoutPanelLeft
} from "lucide-react";
import type { Schedule, User } from "@shared/schema";
import { useAuth } from "@/hooks/use-auth";
import { cn } from "@/lib/utils";

// --- Configuration ---
const ROLES = ["cashier", "bar", "server", "kitchen"];

const SHIFT_PRESETS = {
  morning: { start: "08:00", end: "17:00", label: "Day (8am - 5pm)", color: "bg-emerald-100 border-emerald-200 text-emerald-800", indicator: "bg-emerald-500" },
  afternoon: { start: "13:00", end: "00:00", label: "Mid (1pm - 12am)", color: "bg-amber-100 border-amber-200 text-amber-800", indicator: "bg-amber-500" },
  night: { start: "21:00", end: "06:00", label: "Night (9pm - 6am)", color: "bg-indigo-100 border-indigo-200 text-indigo-800", indicator: "bg-indigo-500" },
  off: { start: "00:00", end: "23:59", label: "Day Off", color: "bg-slate-100 border-slate-200 text-slate-500", indicator: "bg-slate-400" }
};

const shiftFormSchema = z.object({
  userId: z.string().min(1, "Employee is required"),
  date: z.string().min(1, "Date is required"),
  shiftType: z.enum(["morning", "afternoon", "night", "off"]),
  shiftRole: z.enum(["cashier", "bar", "server", "kitchen"]).optional(),
  startTime: z.string().optional(),
  endTime: z.string().optional(),
  location: z.string().optional(),
});

type ShiftForm = z.infer<typeof shiftFormSchema>;

export default function ShiftManagement() {
  const { user } = useAuth();
  const queryClient = useQueryClient();
  const [currentDate, setCurrentDate] = useState(new Date());
  const [view, setView] = useState<"roster" | "kanban" | "list">("roster");
   
  // Dialogs
  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);
  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);
  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);
  const [selectedSchedule, setSelectedSchedule] = useState<Schedule | null>(null);
   
  // Filter State
  const [selectedEmployee, setSelectedEmployee] = useState<string>("all");

  // --- Permission Check ---
  if (user?.role !== 'manager' && user?.role !== 'admin') return <div className="p-8 text-center text-slate-500">Access denied.</div>;

  // --- Queries ---
  const { data: teamMembers } = useQuery<User[]>({ queryKey: ["/api/team"] });
  const { data: allSchedules, isLoading } = useQuery<Schedule[]>({ queryKey: ["/api/schedules/all"] });

  // --- Helpers ---
  const getWeekBounds = (date: Date) => {
    const start = new Date(date);
    start.setDate(date.getDate() - date.getDay());
    start.setHours(0, 0, 0, 0);
    const end = new Date(start);
    end.setDate(start.getDate() + 6);
    end.setHours(23, 59, 59, 999);
    return { start, end };
  };

  const { start: weekStart, end: weekEnd } = getWeekBounds(currentDate);

  const getDaysOfWeek = () => Array.from({ length: 7 }, (_, i) => {
    const d = new Date(weekStart);
    d.setDate(weekStart.getDate() + i);
    return d;
  });

  const isToday = (date: Date) => date.toDateString() === new Date().toDateString();

  const getEmployeeName = (userId: string) => {
    const emp = teamMembers?.find((m) => m.id === userId);
    return emp ? `${emp.firstName} ${emp.lastName}` : "Unknown";
  };
  
  // FIX: Helper for robust time formatting (HH:mm)
  const formatTimeForInput = (dateInput: string | number | Date) => {
    const date = new Date(dateInput);
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    return `${hours}:${minutes}`;
  };

  const navigate = (direction: 'prev' | 'next') => {
    const newDate = new Date(currentDate);
    const delta = view === 'kanban' ? 1 : 7; // Move by day in Kanban, by week in Roster
    newDate.setDate(currentDate.getDate() + (direction === 'next' ? delta : -delta));
    setCurrentDate(newDate);
  };

  // --- Filtering ---
  const filteredSchedules = useMemo(() => {
    if (!allSchedules) return [];
    return allSchedules.filter((s) => {
        const d = new Date(s.date);
        const inRange = view === 'roster' || view === 'list' 
            ? d >= weekStart && d <= weekEnd 
            : true; // For Kanban (Day view), we filter specifically below
        const employeeMatch = selectedEmployee === "all" || s.userId === selectedEmployee;
        return inRange && employeeMatch;
    });
  }, [allSchedules, weekStart, weekEnd, selectedEmployee, view]);

  const getSchedulesForDay = (date: Date) => {
    const dateStr = date.toLocaleDateString('en-CA');
    return filteredSchedules.filter(s => new Date(s.date).toISOString().split('T')[0] === dateStr);
  };

  const getShiftsForEmployeeAndDate = (employeeId: string, date: Date) => {
    const dateStr = date.toLocaleDateString('en-CA');
    return filteredSchedules.filter(s => 
        s.userId === employeeId && 
        new Date(s.date).toISOString().split('T')[0] === dateStr
    );
  };

  // --- Forms & Mutations (Simplified for brevity, logic same as before) ---
  const createForm = useForm<ShiftForm>({ resolver: zodResolver(shiftFormSchema), defaultValues: { shiftType: "morning", shiftRole: "server" } });
  const editForm = useForm<ShiftForm>({ resolver: zodResolver(shiftFormSchema) });

  // 1. MODIFIED: Only sets the label/color, does NOT force the time anymore
  const handleShiftTypeChange = (val: string, form: any) => {
    form.setValue("shiftType", val);
    // Removed the lines that set startTime/endTime based on the preset
  };

  // 2. NEW: Automatically sets End Time to Start Time + 9 Hours
  const onStartTimeChange = (e: React.ChangeEvent<HTMLInputElement>, form: any) => {
    const newStartTime = e.target.value;
    
    // Update the start time field immediately
    form.setValue("startTime", newStartTime);

    if (newStartTime) {
      const [hours, minutes] = newStartTime.split(':').map(Number);
      
      // Create a date object to handle the math (including crossing midnight)
      const date = new Date();
      date.setHours(hours);
      date.setMinutes(minutes);
      
      // Add 9 hours
      date.setHours(date.getHours() + 9);
      
      // Format back to HH:mm
      const newEndHour = date.getHours().toString().padStart(2, '0');
      const newEndMinute = date.getMinutes().toString().padStart(2, '0');
      
      form.setValue("endTime", `${newEndHour}:${newEndMinute}`);
    }
  };

  const createShiftMutation = useMutation({
    mutationFn: async (data: ShiftForm) => {
      let { startTime, endTime } = data;
      if ((!startTime || !endTime) && data.shiftType !== 'off') {
         const preset = SHIFT_PRESETS[data.shiftType];
         startTime = preset.start; endTime = preset.end;
      }
      const startDateTime = new Date(`${data.date}T${startTime || "00:00"}`);
      const endDateTime = new Date(`${data.date}T${endTime || "00:00"}`);
      if (endDateTime < startDateTime && data.shiftType !== 'off') endDateTime.setDate(endDateTime.getDate() + 1);

      return (await apiRequest("POST", "/api/schedules", {
        userId: data.userId, date: new Date(data.date).getTime(), startTime: startDateTime.getTime(), endTime: endDateTime.getTime(),
        type: data.shiftType, title: `${data.shiftType.charAt(0).toUpperCase() + data.shiftType.slice(1)} Shift`,
        shiftRole: data.shiftRole, location: data.location,
      })).json();
    },
    onSuccess: () => {
      toast.success("Shift created");
      queryClient.invalidateQueries({ queryKey: ["/api/schedules/all"] });
      setIsCreateDialogOpen(false); createForm.reset();
    },
  });

  const updateShiftMutation = useMutation({
    mutationFn: async ({ id, data }: { id: string; data: Partial<ShiftForm> }) => {
      const updates: any = { ...data };
      if (data.date) {
        updates.date = new Date(data.date).getTime();
        if (data.startTime && data.endTime) {
            const start = new Date(`${data.date}T${data.startTime}`);
            const end = new Date(`${data.date}T${data.endTime}`);
            if (end < start && data.shiftType !== 'off') end.setDate(end.getDate() + 1);
            updates.startTime = start.getTime(); updates.endTime = end.getTime();
        }
      }
      return (await apiRequest("PATCH", `/api/schedules/${id}`, updates)).json();
    },
    onSuccess: () => { toast.success("Shift updated"); queryClient.invalidateQueries({ queryKey: ["/api/schedules/all"] }); setIsEditDialogOpen(false); },
  });

  const deleteShiftMutation = useMutation({
    mutationFn: async (id: string) => (await apiRequest("DELETE", `/api/schedules/${id}`, {})).json(),
    onSuccess: () => { toast.success("Shift deleted"); queryClient.invalidateQueries({ queryKey: ["/api/schedules/all"] }); setIsDeleteDialogOpen(false); },
  });

  const copyWeekMutation = useMutation({
    mutationFn: async () => (await apiRequest("POST", "/api/schedules/copy-week", {
      sourceWeekStart: new Date(weekStart.getTime() - 7 * 86400000).toISOString(),
      targetWeekStart: weekStart.toISOString(),
    })).json(),
    onSuccess: () => { toast.success("Schedule copied"); queryClient.invalidateQueries({ queryKey: ["/api/schedules/all"] }); },
  });

  const handleEdit = (schedule: Schedule) => {
    setSelectedSchedule(schedule);
    const dateStr = new Date(schedule.date).toISOString().split('T')[0];
    
    // FIX: Use manual extraction for accurate HH:mm for HTML inputs
    const startStr = formatTimeForInput(schedule.startTime);
    const endStr = formatTimeForInput(schedule.endTime);

    editForm.reset({ 
        userId: schedule.userId, 
        date: dateStr, 
        shiftType: schedule.type as any, 
        shiftRole: schedule.shiftRole as any, 
        startTime: startStr, 
        endTime: endStr, 
        location: schedule.location || "" 
    });
    setIsEditDialogOpen(true);
  };

  const handleDelete = (schedule: Schedule, e?: React.MouseEvent) => {
    e?.stopPropagation(); setSelectedSchedule(schedule); setIsDeleteDialogOpen(true);
  };

  // --- UI Components ---
  const Header = () => (
    <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
      <div>
        <h1 className="text-3xl font-bold tracking-tight text-slate-900">Shift Management</h1>
        <p className="text-slate-500 mt-1 text-sm">Assign and manage employee work schedules</p>
      </div>
      <div className="flex items-center gap-3">
        <Button variant="outline" className="bg-white/60" onClick={() => copyWeekMutation.mutate()} disabled={copyWeekMutation.isPending}>
          <Copy className="w-4 h-4 mr-2" /> Copy Previous Week
        </Button>
        <Button onClick={() => setIsCreateDialogOpen(true)} className="bg-slate-900 text-white rounded-full px-6 shadow-lg">
          <Plus className="w-4 h-4 mr-2" /> Assign Shift
        </Button>
      </div>
    </div>
  );

  const Toolbar = () => (
    <div className="flex flex-col lg:flex-row items-center justify-between gap-4 bg-white p-2 rounded-2xl border border-slate-200 shadow-sm">
      <div className="flex items-center gap-3 px-3 w-full lg:w-auto">
        <Users className="w-4 h-4 text-slate-400" />
        <Select value={selectedEmployee} onValueChange={setSelectedEmployee}>
          <SelectTrigger className="w-[180px] border-none shadow-none font-medium p-0 h-auto focus:ring-0"><SelectValue /></SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All Employees</SelectItem>
            {teamMembers?.map((m) => <SelectItem key={m.id} value={m.id}>{m.firstName} {m.lastName}</SelectItem>)}
          </SelectContent>
        </Select>
      </div>

      <div className="flex items-center bg-slate-50 rounded-lg p-1">
        <Button variant="ghost" size="icon" onClick={() => navigate('prev')} className="h-8 w-8 text-slate-500 hover:bg-white hover:shadow-sm"><ChevronLeft className="w-4 h-4" /></Button>
        <div className="px-4 text-sm font-semibold text-slate-700 min-w-[160px] text-center flex items-center justify-center gap-2">
            <CalendarDays className="w-4 h-4 text-slate-400" />
            {view === 'kanban' ? currentDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric'}) : 
             `${weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`}
        </div>
        <Button variant="ghost" size="icon" onClick={() => navigate('next')} className="h-8 w-8 text-slate-500 hover:bg-white hover:shadow-sm"><ChevronRight className="w-4 h-4" /></Button>
      </div>

      <div className="flex items-center gap-2 w-full lg:w-auto justify-end">
        <Button variant="ghost" size="sm" onClick={() => setCurrentDate(new Date())}>Today</Button>
        <div className="h-4 w-px bg-slate-200 mx-2" />
        <Tabs value={view} onValueChange={(v) => setView(v as any)} className="w-auto">
          <TabsList className="bg-slate-100 h-9 p-1">
            <TabsTrigger value="roster" className="h-7 text-xs px-3 gap-2"><Grid className="w-3.5 h-3.5"/> Roster</TabsTrigger>
            <TabsTrigger value="kanban" className="h-7 text-xs px-3 gap-2"><LayoutPanelLeft className="w-3.5 h-3.5"/> Day</TabsTrigger>
            <TabsTrigger value="list" className="h-7 text-xs px-3 gap-2"><List className="w-3.5 h-3.5"/> List</TabsTrigger>
          </TabsList>
        </Tabs>
      </div>
    </div>
  );

  const StatsBar = () => {
    const shifts = getSchedulesForDay(currentDate).filter(s => s.type !== 'off');
    const counts = {
        total: shifts.length,
        morning: shifts.filter(s => s.type === 'morning').length,
        afternoon: shifts.filter(s => s.type === 'afternoon').length,
        night: shifts.filter(s => s.type === 'night').length
    };

    return (
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <Card className="bg-white border-slate-200 shadow-sm p-4 flex items-center justify-between">
                <div><p className="text-[10px] font-bold uppercase text-slate-400">Total Staff</p><p className="text-2xl font-bold text-slate-900">{counts.total}</p></div>
                <Users className="w-8 h-8 text-slate-100" />
            </Card>
            <Card className="bg-emerald-50 border-emerald-100 shadow-sm p-4 flex items-center justify-between">
                <div><p className="text-[10px] font-bold uppercase text-emerald-600">Morning</p><p className="text-2xl font-bold text-emerald-900">{counts.morning}</p></div>
                <Sun className="w-8 h-8 text-emerald-200" />
            </Card>
            <Card className="bg-amber-50 border-amber-100 shadow-sm p-4 flex items-center justify-between">
                <div><p className="text-[10px] font-bold uppercase text-amber-600">Afternoon</p><p className="text-2xl font-bold text-amber-900">{counts.afternoon}</p></div>
                <Sunset className="w-8 h-8 text-amber-200" />
            </Card>
            <Card className="bg-indigo-50 border-indigo-100 shadow-sm p-4 flex items-center justify-between">
                <div><p className="text-[10px] font-bold uppercase text-indigo-600">Night</p><p className="text-2xl font-bold text-indigo-900">{counts.night}</p></div>
                <Moon className="w-8 h-8 text-indigo-200" />
            </Card>
        </div>
    );
  };

  return (
    <div className="max-w-7xl mx-auto p-6 md:p-8 space-y-6">
      <Header />
      <Toolbar />

      {isLoading ? (
          <div className="text-center py-20 text-slate-400">Loading schedule...</div>
      ) : (
          <>
            {/* --- VIEW: ROSTER (Employees x Days) --- */}
            {view === 'roster' && (
                <Card className="border-slate-200 shadow-sm overflow-hidden bg-white">
                    <div className="overflow-x-auto">
                        <div className="min-w-[1000px]">
                            <table className="w-full border-collapse">
                                <thead>
                                    <tr>
                                        <th className="w-[200px] p-4 text-left bg-slate-50 border-b border-r border-slate-200 text-xs font-bold text-slate-500 uppercase sticky left-0 z-20">Employee</th>
                                        {getDaysOfWeek().map((day, i) => (
                                            <th key={i} className={cn("p-3 text-center border-b border-r border-slate-200 min-w-[140px]", isToday(day) && "bg-blue-50/50")}>
                                                <div className={cn("text-[10px] font-bold uppercase", isToday(day) ? "text-blue-600" : "text-slate-400")}>{day.toLocaleDateString('en-US', { weekday: 'short' })}</div>
                                                <div className={cn("text-lg font-bold", isToday(day) ? "text-blue-700" : "text-slate-700")}>{day.getDate()}</div>
                                            </th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody>
                                    {teamMembers?.map((employee) => (
                                        <tr key={employee.id} className="group hover:bg-slate-50/30 transition-colors">
                                            <td className="p-4 border-b border-r border-slate-200 bg-white sticky left-0 z-10 group-hover:bg-slate-50/30">
                                                <div className="flex flex-col">
                                                    <span className="font-bold text-sm text-slate-900">{employee.firstName} {employee.lastName}</span>
                                                    <span className="text-xs text-slate-500 capitalize">{employee.position || "Staff"}</span>
                                                </div>
                                            </td>
                                            {getDaysOfWeek().map((day, i) => {
                                                const shifts = getShiftsForEmployeeAndDate(employee.id, day);
                                                return (
                                                    <td key={i} className={cn("p-2 border-b border-r border-slate-200 align-top h-[100px]", isToday(day) && "bg-blue-50/10")}>
                                                        <div className="flex flex-col gap-2 h-full">
                                                            {shifts.map(shift => <RosterCard key={shift.id} schedule={shift} onEdit={handleEdit} onDelete={handleDelete} />)}
                                                            {shifts.length === 0 && (
                                                                <button onClick={() => { createForm.setValue("userId", employee.id); createForm.setValue("date", day.toISOString().split('T')[0]); setIsCreateDialogOpen(true); }} className="flex-1 w-full flex items-center justify-center rounded-lg border-2 border-dashed border-slate-100 hover:border-slate-300 text-slate-300 hover:text-slate-500 transition-all opacity-0 group-hover:opacity-100"><Plus className="w-5 h-5" /></button>
                                                            )}
                                                        </div>
                                                    </td>
                                                );
                                            })}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </Card>
            )}

            {/* --- VIEW: DAY KANBAN (Roles Columns) --- */}
            {view === 'kanban' && (
                <div className="space-y-6">
                    <StatsBar />
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 items-start">
                        {ROLES.map(role => {
                            const roleShifts = getSchedulesForDay(currentDate)
                                .filter(s => s.shiftRole === role && s.type !== 'off')
                                .sort((a,b) => a.startTime - b.startTime);
                            return (
                                <div key={role} className="flex flex-col bg-slate-100/50 rounded-xl border border-slate-200 p-1">
                                    <div className="p-3 border-b border-slate-100 mb-2 flex items-center justify-between">
                                        <span className="font-bold text-sm text-slate-700 uppercase tracking-wider">{role}</span>
                                        <Badge variant="secondary" className="bg-white">{roleShifts.length}</Badge>
                                    </div>
                                    <div className="flex-1 space-y-2 p-2 min-h-[150px]">
                                        {roleShifts.length === 0 ? <div className="text-center py-8 text-slate-400 text-xs italic">No Staff</div> : 
                                            roleShifts.map(s => <KanbanCard key={s.id} schedule={s} employeeName={getEmployeeName(s.userId)} onEdit={handleEdit} onDelete={handleDelete} />)
                                        }
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            )}

            {/* --- VIEW: LIST --- */}
            {view === 'list' && (
                <Card className="border-slate-200 shadow-sm"><CardContent className="p-0"><table className="w-full text-sm text-left"><thead className="bg-slate-50 border-b border-slate-200 text-xs uppercase text-slate-500"><tr><th className="px-6 py-3 font-semibold">Date</th><th className="px-6 py-3 font-semibold">Employee</th><th className="px-6 py-3 font-semibold">Shift</th><th className="px-6 py-3 font-semibold">Time</th><th className="px-6 py-3 font-semibold text-right">Actions</th></tr></thead><tbody className="divide-y divide-slate-100">{filteredSchedules.map(s => (<tr key={s.id} className="hover:bg-slate-50/50"><td className="px-6 py-3 font-medium">{new Date(s.date).toLocaleDateString()}</td><td className="px-6 py-3">{getEmployeeName(s.userId)}</td><td className="px-6 py-3"><Badge variant="outline" className={cn("capitalize", SHIFT_PRESETS[s.type as keyof typeof SHIFT_PRESETS]?.color)}>{s.type}</Badge></td><td className="px-6 py-3 text-slate-500 text-xs font-mono">{s.type !== 'off' ? `${new Date(s.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${new Date(s.endTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}` : 'OFF'}</td><td className="px-6 py-3 text-right"><Button size="icon" variant="ghost" className="h-8 w-8" onClick={() => handleEdit(s)}><Edit className="w-4 h-4" /></Button><Button size="icon" variant="ghost" className="h-8 w-8 text-red-500" onClick={() => handleDelete(s)}><Trash2 className="w-4 h-4" /></Button></td></tr>))}</tbody></table></CardContent></Card>
            )}
          </>
      )}

      {/* --- Dialogs --- */}
      <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>
        <DialogContent className="max-w-lg rounded-2xl">
          <DialogHeader><DialogTitle>Assign New Shift</DialogTitle></DialogHeader>
          <form onSubmit={createForm.handleSubmit((d) => createShiftMutation.mutate(d))} className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2"><Label>Employee</Label><Select onValueChange={(v) => createForm.setValue("userId", v)}><SelectTrigger className="rounded-xl"><SelectValue placeholder="Select..." /></SelectTrigger><SelectContent>{teamMembers?.map(m => <SelectItem key={m.id} value={m.id}>{m.firstName} {m.lastName}</SelectItem>)}</SelectContent></Select></div>
              <div className="space-y-2"><Label>Date</Label><Input type="date" className="rounded-xl" {...createForm.register("date")} /></div>
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2"><Label>Shift Type</Label><Select onValueChange={(v) => handleShiftTypeChange(v, createForm)} defaultValue="morning"><SelectTrigger className="rounded-xl"><SelectValue /></SelectTrigger><SelectContent>{Object.entries(SHIFT_PRESETS).map(([k, v]) => <SelectItem key={k} value={k}>{v.label}</SelectItem>)}</SelectContent></Select></div>
              <div className="space-y-2"><Label>Role</Label><Select onValueChange={(v) => createForm.setValue("shiftRole", v as any)} defaultValue="server"><SelectTrigger className="rounded-xl capitalize"><SelectValue /></SelectTrigger><SelectContent>{ROLES.map(r => <SelectItem key={r} value={r} className="capitalize">{r}</SelectItem>)}</SelectContent></Select></div>
            </div>
            <div className="grid grid-cols-2 gap-4 bg-slate-50 p-3 rounded-xl">
              <div className="space-y-1"><Label className="text-xs">Start Time</Label><Input type="time" className="bg-white h-8" {...createForm.register("startTime")} onChange={(e) => onStartTimeChange(e, createForm)}/></div>
              <div className="space-y-1"><Label className="text-xs">End Time</Label><Input type="time" className="bg-white h-8" {...createForm.register("endTime")} /></div>
            </div>
            <div className="space-y-2"><Label>Location</Label><Input className="rounded-xl" placeholder="e.g. Main Hall" {...createForm.register("location")} /></div>
            <DialogFooter><Button type="button" variant="outline" onClick={() => setIsCreateDialogOpen(false)}>Cancel</Button><Button type="submit" disabled={createShiftMutation.isPending}>Create Shift</Button></DialogFooter>
          </form>
        </DialogContent>
      </Dialog>
       
      <Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}>
        <DialogContent className="max-w-lg rounded-2xl">
            <DialogHeader><DialogTitle>Edit Shift</DialogTitle></DialogHeader>
            <form onSubmit={editForm.handleSubmit((d) => selectedSchedule && updateShiftMutation.mutate({ id: selectedSchedule.id, data: d }))} className="space-y-4 mt-2">
                
                {/* --- FIX: Display Employee Name --- */}
                <div className="space-y-2">
                    <Label>Employee</Label>
                    <div className="flex items-center px-3 py-2 bg-slate-100 border border-slate-200 rounded-xl text-slate-500 font-medium">
                        <Users className="w-4 h-4 mr-2 opacity-50"/>
                        {selectedSchedule ? getEmployeeName(selectedSchedule.userId) : "Loading..."}
                    </div>
                </div>

                <div className="grid grid-cols-2 gap-4">
                    <div className="space-y-2"><Label>Date</Label><Input type="date" className="rounded-xl" {...editForm.register("date")} /></div>
                    <div className="space-y-2">
                        <Label>Role</Label>
                        <Select onValueChange={(value) => editForm.setValue("shiftRole", value as any)} value={editForm.watch("shiftRole")}>
                            <SelectTrigger className="rounded-xl capitalize"><SelectValue /></SelectTrigger>
                            <SelectContent>{ROLES.map(r => <SelectItem key={r} value={r} className="capitalize">{r}</SelectItem>)}</SelectContent>
                        </Select>
                    </div>
                </div>
                <div className="space-y-2">
                    <Label>Shift Type</Label>
                    <Select onValueChange={(val) => handleShiftTypeChange(val, editForm)} value={editForm.watch("shiftType")}>
                        <SelectTrigger className="rounded-xl"><SelectValue /></SelectTrigger>
                        <SelectContent>{Object.entries(SHIFT_PRESETS).map(([k,v]) => <SelectItem key={k} value={k}>{v.label}</SelectItem>)}</SelectContent>
                    </Select>
                </div>
                <div className="grid grid-cols-2 gap-4 bg-slate-50 p-3 rounded-xl">
                    <div className="space-y-1"><Label className="text-xs">Start Time</Label><Input type="time" className="bg-white h-8" {...editForm.register("startTime")} onChange={(e) => onStartTimeChange(e, editForm)}/></div>
                    <div className="space-y-1"><Label className="text-xs">End Time</Label><Input type="time" className="bg-white h-8" {...editForm.register("endTime")} /></div>
                </div>
                <div className="space-y-2"><Label>Location</Label><Input {...editForm.register("location")} className="rounded-xl" /></div>
                <DialogFooter>
                    <Button type="button" variant="outline" onClick={() => setIsEditDialogOpen(false)}>Cancel</Button>
                    <Button type="submit" disabled={updateShiftMutation.isPending} className="bg-slate-900 text-white">Update Shift</Button>
                </DialogFooter>
            </form>
        </DialogContent>
      </Dialog>
      <AlertDialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>
        <AlertDialogContent className="rounded-2xl">
            <AlertDialogHeader><DialogTitle>Delete Shift</DialogTitle><DialogDescription>Are you sure?</DialogDescription></AlertDialogHeader>
            <AlertDialogFooter><AlertDialogCancel className="rounded-full">Cancel</AlertDialogCancel><AlertDialogAction onClick={() => selectedSchedule && deleteShiftMutation.mutate(selectedSchedule.id)} className="bg-rose-600 hover:bg-rose-700 rounded-full">Delete</AlertDialogAction></AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
}

// --- Cards ---

function RosterCard({ schedule, onEdit, onDelete }: any) {
  if (schedule.type === 'off') return <div onClick={() => onEdit(schedule)} className="rounded-md bg-slate-50 border border-slate-100 p-2 text-center cursor-pointer hover:bg-slate-100"><span className="text-[10px] font-bold text-slate-300">OFF</span></div>;
  const style = SHIFT_PRESETS[schedule.type as keyof typeof SHIFT_PRESETS];
  return (
    <div onClick={() => onEdit(schedule)} className={cn("relative rounded-lg p-2 text-xs border shadow-sm cursor-pointer hover:scale-[1.02] transition-all group", style?.color)}>
      <div className="flex justify-between items-center mb-1"><span className="font-bold capitalize">{schedule.type}</span><Badge variant="secondary" className="h-4 px-1 text-[8px] bg-white/60 border-0 uppercase">{schedule.shiftRole}</Badge></div>
      <div className="font-mono text-[10px] opacity-90">{new Date(schedule.startTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
      <button onClick={(e) => onDelete(schedule, e)} className="absolute top-1 right-1 p-1 rounded-full bg-white/40 hover:bg-red-500 hover:text-white opacity-0 group-hover:opacity-100 transition-opacity"><Trash2 className="w-3 h-3" /></button>
    </div>
  );
}

function KanbanCard({ schedule, employeeName, onEdit, onDelete }: any) {
  const style = SHIFT_PRESETS[schedule.type as keyof typeof SHIFT_PRESETS];
  return (
    <div onClick={() => onEdit(schedule)} className="group relative bg-white p-3 rounded-lg border border-slate-100 shadow-sm hover:shadow-md transition-all cursor-pointer">
      <div className="flex justify-between items-start mb-1">
        <span className="font-bold text-sm text-slate-800">{employeeName}</span>
        <div className={cn("w-2 h-2 rounded-full", style?.indicator)} />
      </div>
      <div className="flex items-center text-xs text-slate-500 gap-1.5 mb-1">
        <Clock className="w-3 h-3" />
        {new Date(schedule.startTime).toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'})} - {new Date(schedule.endTime).toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'})}
      </div>
      <div className="flex items-center text-[10px] text-slate-400 gap-1.5"><MapPin className="w-3 h-3" /> {schedule.location || "Main Hall"}</div>
      <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
        <Button size="icon" variant="ghost" className="h-6 w-6 text-red-500" onClick={(e) => onDelete(schedule, e)}><Trash2 className="w-3 h-3" /></Button>
      </div>
    </div>
  );
}


===== team-management.tsx =====
import { useState, useMemo } from "react";
import { useAuth } from "@/hooks/use-auth";
import { useQuery } from "@tanstack/react-query";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Users, Search, Mail, Phone, Calendar, Building, UserPlus, Briefcase, User, Hash, Shield, CheckCircle, XCircle } from "lucide-react";
import type { User as UserType } from "@shared/schema";
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger, DialogFooter } from "@/components/ui/dialog";
import { apiRequest } from "@/lib/queryClient";
import { BentoCard } from "@/components/custom/bento-card";

export default function TeamManagement() {
  const { user } = useAuth();
  const [searchTerm, setSearchTerm] = useState("");
  const [isViewDialogOpen, setIsViewDialogOpen] = useState(false);
  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);
  const [selectedMember, setSelectedMember] = useState<UserType | null>(null);

  const { data: teamMembers, isLoading } = useQuery<UserType[]>({
    queryKey: ["/api/team"],
    enabled: user?.role === 'manager' || user?.role === 'admin',
  });

  // Fetch ALL users for guaranteed manager lookup
  const { data: allUsers } = useQuery<UserType[]>({
    queryKey: ["/api/users/all"], 
    queryFn: async () => {
        const res = await apiRequest("GET", "/api/users"); 
        return await res.json();
    },
    enabled: user?.role === 'admin' || user?.role === 'manager',
  });

  const filteredMembers = useMemo(() => {
    if (!teamMembers) return [];

    return teamMembers
      .filter((member: UserType) => 
        member.role !== 'admin' || member.id === user?.id 
      )
      .filter((member: UserType) =>
        `${member.firstName} ${member.lastName}`.toLowerCase().includes(searchTerm.toLowerCase()) ||
        member.email.toLowerCase().includes(searchTerm.toLowerCase()) ||
        member.department?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        member.position?.toLowerCase().includes(searchTerm.toLowerCase())
      ) || [];
  }, [teamMembers, searchTerm, user?.id]);

  // move this to permissions.ts
  const canManageTeam = user?.role === 'manager' || user?.role === 'admin';

  if (!canManageTeam) {
    return (
      <div className="p-8 flex justify-center items-center h-screen">
        <Card className="w-full max-w-md bg-white/60 backdrop-blur-xl border-slate-200/60 shadow-lg rounded-3xl">
          <CardContent className="py-12 text-center space-y-4">
            <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto text-slate-400">
                <Users className="w-8 h-8" />
            </div>
            <p className="text-slate-500">You need manager or admin privileges to access team management features.</p>
          </CardContent>
        </Card>
      </div>
    );
  }
  
  const getManagerName = (managerId: string | null | undefined) => {
    if (!managerId || managerId === "") return "N/A";
    const userList = allUsers || teamMembers;
    const manager = userList?.find((m: UserType) => m.id === managerId);
    return manager ? `${manager.firstName} ${manager.lastName}` : "Unknown Manager";
  }

  const getInitials = (firstName: string, lastName: string) => {
    return `${firstName?.charAt(0) || ''}${lastName?.charAt(0) || ''}`.toUpperCase();
  };

  const getRoleBadge = (role: string) => {
    const styles = {
      employee: "bg-slate-100 text-slate-600 border-slate-200",
      manager: "bg-indigo-100 text-indigo-700 border-indigo-200",
      admin: "bg-rose-100 text-rose-700 border-rose-200",
      payroll_officer: "bg-blue-100 text-blue-700 border-blue-200"
    };
    const style = styles[role as keyof typeof styles] || styles.employee;

    return (
      <Badge variant="outline" className={`${style} border px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wider`}>
        {role.replace(/_/g, " ")}
      </Badge>
    );
  };

  const getStatusBadge = (isActive: boolean) => {
    return isActive ? (
      <Badge variant="outline" className="bg-emerald-50 text-emerald-700 border-emerald-200 flex items-center gap-1 px-2 py-0.5 text-[10px]">
        <CheckCircle className="w-3 h-3" /> Active
      </Badge>
    ) : (
      <Badge variant="outline" className="bg-slate-100 text-slate-500 border-slate-200 flex items-center gap-1 px-2 py-0.5 text-[10px]">
        <XCircle className="w-3 h-3" /> Inactive
      </Badge>
    );
  };

  const formatDate = (date: string | Date | null) => {
    if (!date) return "Not specified";
    return new Date(date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  };

  const getTeamStats = () => {
    if (!teamMembers) return { total: 0, active: 0, managers: 0 };
    const total = teamMembers.length;
    const active = teamMembers.filter((member: UserType) => member.isActive).length;
    const managers = teamMembers.filter((member: UserType) => member.role === 'manager').length;
    return { total, active, managers };
  };

  const stats = getTeamStats();
  
  const handleViewDetails = (member: UserType) => {
    setSelectedMember(member);
    setIsViewDialogOpen(true);
  };

  const handleEditMember = (member: UserType) => {
    setSelectedMember(member);
    setIsEditDialogOpen(true);
  };

  return (
    <div className="p-6 md:p-8 max-w-7xl mx-auto space-y-8">
      {/* Header */}
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h1 className="text-3xl font-bold tracking-tight text-slate-900">Team Management</h1>
          <p className="text-slate-500 mt-1 text-sm">Manage your team members and organizational structure</p>
        </div>
        <Button className="bg-slate-900 hover:bg-slate-800 text-white shadow-lg shadow-slate-900/20 rounded-full px-6" data-testid="button-add-member">
            <UserPlus className="w-4 h-4 mr-2" /> Add Team Member
        </Button>
      </div>

      {/* Bento Stats */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <BentoCard title="Total Members" value={stats.total} icon={Users} variant="default" testIdPrefix="total-members" />
        <BentoCard title="Active Members" value={stats.active} icon={CheckCircle} variant="emerald" testIdPrefix="active-members" />
        <BentoCard title="Managers" value={stats.managers} icon={Briefcase} variant="amber" testIdPrefix="manager-count" />
      </div>

      {/* Tabs & List */}
      <Tabs defaultValue="members" className="space-y-6">
        <div className="flex flex-col sm:flex-row items-center justify-between gap-4 bg-white/80 backdrop-blur-md p-2 rounded-2xl border border-slate-200/60 shadow-sm">
            <TabsList className="bg-transparent p-0 h-auto" data-testid="team-tabs">
                <TabsTrigger value="members" className="rounded-full px-4 py-2 data-[state=active]:bg-white data-[state=active]:shadow-sm" data-testid="tab-members">Team Members</TabsTrigger>
            </TabsList>

            <div className="relative w-full sm:w-auto">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400" />
                <Input 
                    placeholder="Search team members..." 
                    className="pl-9 h-9 w-full sm:w-64 border-none bg-slate-100/50 focus:bg-white focus:ring-0 rounded-xl transition-all"
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    data-testid="search-members"
                />
            </div>
        </div>

        <TabsContent value="members" className="mt-0 focus-visible:outline-none">
            {isLoading ? (
                <div className="text-center py-12 text-slate-400">Loading team members...</div>
            ) : filteredMembers.length > 0 ? (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {filteredMembers.map((member: UserType) => (
                    <Card key={member.id} className="bg-white/60 backdrop-blur-xl border-slate-200/60 shadow-sm hover:shadow-md transition-all rounded-2xl overflow-hidden group" data-testid={`member-${member.id}`}>
                        <CardContent className="p-6">
                            <div className="flex items-start justify-between mb-4">
                                <div className="flex items-center gap-4">
                                    <Avatar className="w-14 h-14 border-2 border-white shadow-sm">
                                        <AvatarImage src={member.profilePicture || ""} />
                                        <AvatarFallback className="bg-slate-100 text-slate-600 text-lg font-bold">
                                            {getInitials(member.firstName, member.lastName)}
                                        </AvatarFallback>
                                    </Avatar>
                                    <div>
                                        <h3 className="font-bold text-slate-900 text-lg leading-tight">{member.firstName} {member.lastName}</h3>
                                        <p className="text-xs text-slate-500">{member.position || "No position"}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="flex gap-2 mb-6">
                                {getRoleBadge(member.role)}
                                {getStatusBadge(member.isActive!)}
                            </div>

                            <div className="space-y-2.5 mb-6">
                                <div className="flex items-center text-sm text-slate-600">
                                    <Mail className="w-4 h-4 mr-3 text-slate-400" />
                                    <span className="truncate">{member.email}</span>
                                </div>
                                <div className="flex items-center text-sm text-slate-600">
                                    <Building className="w-4 h-4 mr-3 text-slate-400" />
                                    <span className="truncate">{member.department || "No department"}</span>
                                </div>
                                {member.phoneNumber && (
                                    <div className="flex items-center text-sm text-slate-600">
                                        <Phone className="w-4 h-4 mr-3 text-slate-400" />
                                        <span>{member.phoneNumber}</span>
                                    </div>
                                )}
                            </div>

                            <div className="grid grid-cols-2 gap-3 pt-4 border-t border-slate-100/50">
                                <Button variant="outline" className="w-full rounded-xl border-slate-200 hover:bg-slate-50" onClick={() => handleViewDetails(member)}>
                                    View Details
                                </Button>
                                <Button variant="ghost" className="w-full rounded-xl hover:bg-slate-100 text-slate-600" onClick={() => handleEditMember(member)}>
                                    Edit
                                </Button>
                            </div>
                        </CardContent>
                    </Card>
                    ))}
                </div>
            ) : (
                <div className="text-center py-20 bg-white/40 border border-dashed border-slate-200 rounded-3xl">
                    <Users className="w-12 h-12 text-slate-300 mx-auto mb-4" />
                    <p className="text-slate-500">No team members found.</p>
                    {searchTerm && <Button variant="link" onClick={() => setSearchTerm("")} className="mt-2 text-slate-900">Clear Search</Button>}
                </div>
            )}
        </TabsContent>
      </Tabs>
      
      {/* View Details Dialog */}
      <Dialog open={isViewDialogOpen} onOpenChange={setIsViewDialogOpen}>
          <DialogContent className="sm:max-w-[450px] rounded-2xl">
              <DialogHeader>
                  <DialogTitle>Employee Details</DialogTitle>
                  <DialogDescription>Full profile information for {selectedMember?.firstName} {selectedMember?.lastName}</DialogDescription>
              </DialogHeader>
              {selectedMember && (
                  <div className="space-y-6 pt-4">
                      <div className="flex flex-col items-center space-y-3 pb-6 border-b border-slate-100">
                          <Avatar className="w-24 h-24 border-4 border-white shadow-lg">
                              <AvatarImage src={selectedMember.profilePicture || ""} />
                              <AvatarFallback className="text-3xl bg-slate-100 text-slate-600">
                                  {getInitials(selectedMember.firstName, selectedMember.lastName)}
                              </AvatarFallback>
                          </Avatar>
                          <div className="text-center">
                              <h3 className="text-2xl font-bold text-slate-900">{selectedMember.firstName} {selectedMember.lastName}</h3>
                              <p className="text-slate-500">{selectedMember.position || "No position"}</p>
                          </div>
                          <div className="flex gap-2">
                              {getRoleBadge(selectedMember.role)}
                              {getStatusBadge(selectedMember.isActive!)}
                          </div>
                      </div>
                      
                      <div className="space-y-3 text-sm">
                          <DetailRow icon={Mail} label="Email" value={selectedMember.email} />
                          <DetailRow icon={User} label="Username" value={selectedMember.username} />
                          <DetailRow icon={Briefcase} label="Position" value={selectedMember.position || 'N/A'} />
                          <DetailRow icon={Building} label="Department" value={selectedMember.department || 'N/A'} />
                          {selectedMember.role === 'employee' && selectedMember.managerId && (
                              <DetailRow icon={Users} label="Manager" value={getManagerName(selectedMember.managerId)} />
                          )}
                          <DetailRow icon={Phone} label="Phone" value={selectedMember.phoneNumber || 'N/A'} />
                          <DetailRow icon={Hash} label="Employee ID" value={selectedMember.employeeId || 'N/A'} />
                          <DetailRow icon={Calendar} label="Hire Date" value={formatDate(selectedMember.hireDate)} />
                      </div>
                  </div>
              )}
          </DialogContent>
      </Dialog>

      {/* Edit Dialog (Placeholder) */}
      <Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}>
          <DialogContent className="sm:max-w-[425px] rounded-2xl">
              <DialogHeader>
                  <DialogTitle>Edit Member</DialogTitle>
                  <DialogDescription>
                      For full editing capabilities, please use the dedicated User Management page.
                  </DialogDescription>
              </DialogHeader>
              <div className="p-4 bg-slate-50 rounded-xl border border-slate-100 text-sm text-slate-600 leading-relaxed">
                  <p>Editing a user's profile requires complex form handling and permission checks, which are centralized in the <strong>User Management</strong> section.</p>
                  {selectedMember && (
                      <div className="mt-4 font-medium text-slate-900 flex items-center gap-2">
                          <User className="w-4 h-4" /> {selectedMember.firstName} {selectedMember.lastName}
                      </div>
                  )}
              </div>
              <div className="flex justify-end pt-2">
                  <Button onClick={() => setIsEditDialogOpen(false)} className="rounded-full bg-slate-900">Close</Button>
              </div>
          </DialogContent>
      </Dialog>
    </div>
  );
}

// Helper component for detail rows
const DetailRow = ({ icon: Icon, label, value }: { icon: any, label: string, value: string }) => (
    <div className="flex justify-between items-center py-2 border-b border-slate-50 last:border-0">
        <div className="flex items-center space-x-3 text-slate-500">
            <div className="p-1.5 bg-slate-50 rounded-lg"><Icon className="w-4 h-4" /></div>
            <span className="font-medium text-xs uppercase tracking-wide">{label}</span>
        </div>
        <span className="text-slate-800 font-medium text-right">{value}</span>
    </div>
);


===== time-clock.tsx =====
import { useState, useEffect } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert"; 
import { toast } from "sonner";
import { Clock, Coffee, LogIn, LogOut, Timer, AlertCircle, CalendarCheck, History } from "lucide-react";
import { format, differenceInMinutes, addMinutes, subMinutes, isWithinInterval } from "date-fns";
import { Badge } from "@/components/ui/badge";

// --- Configuration ---
const BREAK_LIMIT_MINUTES = 60;
const SHIFT_WINDOW_TOLERANCE = 30; // Minutes before/after shift user can act

interface Schedule {
  shiftStart: number; 
  shiftEnd: number;   
}

interface Attendance {
  id: string;
  userId: string;
  date: number;
  timeIn: number;
  timeOut: number | null;
  status: string;
  totalBreakMinutes: number;
  totalWorkMinutes: number | null;
  notes: string | null;
}

interface Break {
  id: string;
  attendanceId: string;
  userId: string;
  breakStart: number;
  breakEnd: number | null;
  breakMinutes: number | null;
  breakType: string;
  notes: string | null;
}

interface TodayAttendance {
  attendance: Attendance | null;
  activeBreak: Break | null;
  breaks: Break[];
  schedule: Schedule | null; 
}

export default function TimeClock() {
  const queryClient = useQueryClient();
  const [currentTime, setCurrentTime] = useState(new Date());
  const [notes, setNotes] = useState("");
  const [breakNotes, setBreakNotes] = useState("");

  useEffect(() => {
    const timer = setInterval(() => setCurrentTime(new Date()), 1000);
    return () => clearInterval(timer);
  }, []);

  const { data: todayData, isLoading } = useQuery<TodayAttendance>({
    queryKey: ["/api/attendance/today"],
    refetchInterval: 30000,
  });

  // --- Mutations ---
  const clockInMutation = useMutation({
    mutationFn: async (notes: string) => {
      const res = await fetch("/api/attendance/clock-in", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ notes }),
      });
      if (!res.ok) throw new Error((await res.json()).message);
      return res.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/attendance/today"] });
      toast.success("Clocked In", { description: "You have successfully clocked in." });
      setNotes("");
    },
    onError: (error: Error) => toast.error("Error", { description: error.message }),
  });

  const clockOutMutation = useMutation({
    mutationFn: async () => {
      const res = await fetch("/api/attendance/clock-out", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });
      if (!res.ok) throw new Error((await res.json()).message);
      return res.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/attendance/today"] });
      toast.success("Clocked Out", { description: "You have successfully clocked out." });
    },
    onError: (error: Error) => toast.error("Error", { description: error.message }),
  });

  const startBreakMutation = useMutation({
    mutationFn: async ({ breakType, notes }: { breakType: string; notes: string }) => {
      const res = await fetch("/api/attendance/break-start", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ breakType, notes }),
      });
      if (!res.ok) throw new Error((await res.json()).message);
      return res.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/attendance/today"] });
      toast.success("Break Started", { description: "Your break has started." });
      setBreakNotes("");
    },
    onError: (error: Error) => toast.error("Error", { description: error.message }),
  });

  const endBreakMutation = useMutation({
    mutationFn: async () => {
      const res = await fetch("/api/attendance/break-end", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });
      if (!res.ok) throw new Error((await res.json()).message);
      return res.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/attendance/today"] });
      toast.success("Break Ended", { description: "Your break has ended." });
    },
    onError: (error: Error) => toast.error("Error", { description: error.message }),
  });

  // --- Logic Helpers ---
  const formatTime = (date: Date) => format(date, "h:mm:ss a");
  const formatTimeOnly = (date: Date) => format(date, "h:mm a");
  
  const formatDuration = (minutes: number) => {
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    return `${hours}h ${mins}m`;
  };

  const calculateElapsedTime = (startTime: number) => {
    const start = new Date(startTime).getTime();
    const now = currentTime.getTime();
    const elapsed = Math.floor((now - start) / (1000 * 60));
    return formatDuration(elapsed);
  };

  if (isLoading) {
    return (
        <div className="flex items-center justify-center h-screen bg-slate-50">
            <div className="flex flex-col items-center gap-4">
                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                <p className="text-slate-500">Loading time clock...</p>
            </div>
        </div>
    );
  }

  const { attendance, activeBreak, breaks, schedule } = todayData || { attendance: null, activeBreak: null, breaks: [], schedule: null };
  
  // 1. Shift Status Logic
  const isClockedIn = attendance && !attendance.timeOut;
  const isShiftCompleted = attendance && attendance.timeIn && attendance.timeOut;
  const isOnBreak = activeBreak !== null;

  // 2. Break Limit Logic
  const totalUsedBreak = attendance ? attendance.totalBreakMinutes : 0;
  const currentBreakSession = activeBreak ? differenceInMinutes(currentTime, new Date(activeBreak.breakStart)) : 0;
  const realTimeTotalBreak = totalUsedBreak + currentBreakSession;
  const remainingBreakMinutes = BREAK_LIMIT_MINUTES - realTimeTotalBreak;
  const isBreakLimitReached = remainingBreakMinutes <= 0 && !isOnBreak;

  // 3. Schedule Window Logic
  let canClockIn = true;
  let canClockOut = true;
  let restrictionMessage = "";

  if (schedule) {
    const shiftStart = new Date(schedule.shiftStart);
    const shiftEnd = new Date(schedule.shiftEnd);

    const validClockInStart = subMinutes(shiftStart, SHIFT_WINDOW_TOLERANCE);
    const validClockInEnd = addMinutes(shiftStart, SHIFT_WINDOW_TOLERANCE);
    const validClockOutStart = subMinutes(shiftEnd, SHIFT_WINDOW_TOLERANCE);
    const validClockOutEnd = addMinutes(shiftEnd, SHIFT_WINDOW_TOLERANCE);

    const inClockInWindow = isWithinInterval(currentTime, { start: validClockInStart, end: validClockInEnd });
    const inClockOutWindow = isWithinInterval(currentTime, { start: validClockOutStart, end: validClockOutEnd });

    if (!isClockedIn && !isShiftCompleted) {
      if (!inClockInWindow) {
        canClockIn = false;
        if (currentTime < validClockInStart) restrictionMessage = `Clock in available at ${format(validClockInStart, 'h:mm a')}`;
        else restrictionMessage = "Clock-in window missed.";
      }
    }

    if (isClockedIn) {
      if (!inClockOutWindow) {
        if (currentTime < validClockOutStart) {
          canClockOut = false;
          restrictionMessage = `Clock out available at ${format(validClockOutStart, 'h:mm a')}`;
        }
      }
    }
  }

  // --- Render: Shift Completed State ---
  if (isShiftCompleted) {
    return (
      <div className="container mx-auto p-6 max-w-4xl flex flex-col items-center justify-center min-h-[80vh]">
        <Card className="w-full max-w-md bg-white/60 backdrop-blur-xl border-slate-200/60 shadow-lg rounded-3xl text-center overflow-hidden">
            <div className="bg-emerald-500/10 p-8 flex justify-center">
                <div className="bg-emerald-100 text-emerald-600 p-4 rounded-full">
                    <CalendarCheck className="w-12 h-12" />
                </div>
            </div>
            <CardHeader>
                <CardTitle className="text-2xl font-bold text-slate-800">You're all set!</CardTitle>
                <CardDescription className="text-slate-500">Shift completed for today.</CardDescription>
            </CardHeader>
            <CardContent className="space-y-6 pb-8">
                <div className="grid grid-cols-2 gap-4">
                    <div className="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                        <p className="text-xs text-slate-400 uppercase tracking-wider font-medium">Time In</p>
                        <p className="text-xl font-bold text-slate-700 mt-1">{formatTimeOnly(new Date(attendance!.timeIn))}</p>
                    </div>
                    <div className="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                        <p className="text-xs text-slate-400 uppercase tracking-wider font-medium">Time Out</p>
                        <p className="text-xl font-bold text-slate-700 mt-1">{formatTimeOnly(new Date(attendance!.timeOut!))}</p>
                    </div>
                </div>
                <div className="flex justify-between items-center px-4 py-3 bg-blue-50 text-blue-700 rounded-xl text-sm font-medium">
                    <span>Total Work Duration</span>
                    <span>{formatDuration(attendance!.totalWorkMinutes || 0)}</span>
                </div>
            </CardContent>
        </Card>
      </div>
    )
  }

  // --- Main Render ---
  return (
    <div className="p-2 md:p-4 max-w-7xl mx-auto space-y-8">
      
      {/* Page Header */}
      <div className="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
        <div>
            <h1 className="text-3xl font-bold tracking-tight text-slate-900">Time Clock</h1>
            <p className="text-slate-500 mt-1">Manage your daily attendance and breaks</p>
        </div>
        {schedule && (
            <div className="px-4 py-2 bg-white/50 backdrop-blur-sm border border-slate-200 rounded-full text-sm font-medium text-slate-600 shadow-sm">
                Shift: {formatTimeOnly(new Date(schedule.shiftStart))} - {formatTimeOnly(new Date(schedule.shiftEnd))}
            </div>
        )}
      </div>

      {/* Main Grid */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* Left Column: Clock & Controls */}
        <div className="lg:col-span-2 space-y-6">
            
            {/* 1. Big Clock Card */}
            <Card className="bg-white/70 backdrop-blur-2xl border-slate-200/60 shadow-sm rounded-[2rem] overflow-hidden relative">
                {/* Decorative gradients */}
                <div className="absolute top-0 right-0 w-64 h-64 bg-blue-400/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/3 pointer-events-none" />
                <div className="absolute bottom-0 left-0 w-64 h-64 bg-emerald-400/10 rounded-full blur-3xl translate-y-1/2 -translate-x-1/3 pointer-events-none" />
                
                <CardContent className="p-10 flex flex-col items-center justify-center min-h-[320px] relative z-10">
                    <div className="text-center space-y-2">
                        <h2 className="text-7xl md:text-8xl font-bold  text-slate-800 tabular-nums drop-shadow-sm">
                            {formatTime(currentTime).replace(/\s[AP]M/, '')}
                            <span className="text-3xl md:text-4xl text-slate-400 ml-2 font-medium">
                                {format(currentTime, "a")}
                            </span>
                        </h2>
                        <p className="text-xl font-medium text-slate-500 uppercase tracking-widest">
                            {format(currentTime, "EEEE, MMMM d")}
                        </p>
                    </div>

                    {/* Live Status Pill */}
                    <div className={`mt-10 px-6 py-2.5 rounded-full border text-sm font-bold shadow-sm transition-all duration-300 flex items-center gap-2 ${
                        isOnBreak ? 'bg-amber-50 text-amber-700 border-amber-200' :
                        isClockedIn ? 'bg-emerald-50 text-emerald-700 border-emerald-200' :
                        'bg-slate-100 text-slate-600 border-slate-200'
                    }`}>
                        <div className={`w-2.5 h-2.5 rounded-full ${
                            isOnBreak ? 'bg-amber-500 animate-pulse' :
                            isClockedIn ? 'bg-emerald-500 animate-pulse' :
                            'bg-slate-400'
                        }`} />
                        {isOnBreak ? 'ON BREAK' : isClockedIn ? 'CLOCKED IN' : 'READY TO START'}
                    </div>
                </CardContent>
            </Card>

            {/* 2. Action Controls */}
            <Card className="bg-white/60 backdrop-blur-xl border-slate-200/60 shadow-sm rounded-3xl overflow-hidden">
                <CardContent className="p-6">
                    {restrictionMessage && (
                        <Alert variant="destructive" className="mb-6 bg-red-50 border-red-100 text-red-800 rounded-xl">
                            <AlertCircle className="h-4 w-4" />
                            <AlertTitle>Action Restricted</AlertTitle>
                            <AlertDescription>{restrictionMessage}</AlertDescription>
                        </Alert>
                    )}

                    {!isClockedIn ? (
                        <div className="space-y-4">
                            <div className="space-y-2">
                                <Label htmlFor="notes" className="text-slate-600 ml-1">Shift Notes (Optional)</Label>
                                <Textarea
                                    id="notes"
                                    placeholder="Add any notes about your shift..."
                                    value={notes}
                                    onChange={(e) => setNotes(e.target.value)}
                                    rows={2}
                                    className="rounded-2xl bg-slate-50 border-slate-200 focus:bg-white transition-all resize-none"
                                />
                            </div>
                            <Button
                                onClick={() => clockInMutation.mutate(notes)}
                                disabled={clockInMutation.isPending || !canClockIn}
                                className="w-full h-14 text-lg rounded-2xl bg-gradient-to-r from-slate-900 to-slate-800 hover:from-slate-800 hover:to-slate-700 shadow-lg shadow-slate-900/20"
                            >
                                <LogIn className="mr-2 h-5 w-5" />
                                Clock In
                            </Button>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {/* Break Controls */}
                            <div className="space-y-4 p-4 bg-slate-50/50 rounded-2xl border border-slate-100">
                                {!isOnBreak ? (
                                    <>
                                        <div className="space-y-2">
                                            <Label htmlFor="breakNotes" className="text-slate-600 text-xs uppercase tracking-wider font-semibold">Break Reason</Label>
                                            <Textarea
                                                id="breakNotes"
                                                placeholder="Lunch, Coffee..."
                                                value={breakNotes}
                                                onChange={(e) => setBreakNotes(e.target.value)}
                                                rows={1}
                                                className="rounded-xl bg-white border-slate-200 min-h-[50px] resize-none"
                                            />
                                        </div>
                                        <Button
                                            onClick={() => startBreakMutation.mutate({ breakType: "regular", notes: breakNotes })}
                                            disabled={startBreakMutation.isPending || isBreakLimitReached}
                                            variant="outline"
                                            className="w-full h-12 rounded-xl border-amber-200 text-amber-700 hover:bg-amber-50 hover:text-amber-800"
                                        >
                                            <Coffee className="mr-2 h-4 w-4" />
                                            {isBreakLimitReached ? "Break Limit Reached" : "Start Break"}
                                        </Button>
                                    </>
                                ) : (
                                    <Button
                                        onClick={() => endBreakMutation.mutate()}
                                        disabled={endBreakMutation.isPending}
                                        className="w-full h-full min-h-[100px] rounded-xl bg-amber-500 hover:bg-amber-600 text-white shadow-md shadow-amber-500/20 flex flex-col gap-2"
                                    >
                                        <Timer className="h-8 w-8" />
                                        <span className="text-lg font-bold">End Break</span>
                                        <span className="text-xs font-normal opacity-90">Return to work</span>
                                    </Button>
                                )}
                            </div>

                            {/* Clock Out Control */}
                            <div className="flex items-end">
                                <Button
                                    onClick={() => clockOutMutation.mutate()}
                                    disabled={clockOutMutation.isPending || isOnBreak || !canClockOut}
                                    variant="destructive"
                                    className="w-full h-full min-h-[100px] rounded-2xl bg-gradient-to-br from-red-600 to-red-700 hover:from-red-500 hover:to-red-600 shadow-lg shadow-red-600/20 flex flex-col justify-center items-center gap-2"
                                >
                                    <LogOut className="h-6 w-6" />
                                    <span className="text-lg font-bold">Clock Out</span>
                                    {!canClockOut && <span className="text-xs opacity-75 font-normal">Too early to leave</span>}
                                </Button>
                            </div>
                        </div>
                    )}
                </CardContent>
            </Card>
        </div>

        {/* Right Column: Stats & Logs */}
        <div className="space-y-6">
            
            {/* Current Status Details */}
            <Card className="bg-white/60 backdrop-blur-xl border-slate-200/60 shadow-sm rounded-3xl">
                <CardHeader className="pb-2">
                    <CardTitle className="text-lg text-slate-800">Session Details</CardTitle>
                </CardHeader>
                <CardContent className="space-y-3">
                    {isClockedIn && attendance ? (
                        <>
                            <div className="flex justify-between items-center p-3 bg-white rounded-xl border border-slate-100 shadow-sm">
                                <div className="flex items-center gap-3">
                                    <div className="p-2 bg-blue-50 text-blue-600 rounded-lg">
                                        <Clock className="w-4 h-4" />
                                    </div>
                                    <div>
                                        <p className="text-xs text-slate-500 uppercase font-bold tracking-wider">Time In</p>
                                        <p className="text-sm font-semibold text-slate-900">{formatTimeOnly(new Date(attendance.timeIn))}</p>
                                    </div>
                                </div>
                            </div>

                            <div className="flex justify-between items-center p-3 bg-white rounded-xl border border-slate-100 shadow-sm">
                                <div className="flex items-center gap-3">
                                    <div className="p-2 bg-emerald-50 text-emerald-600 rounded-lg">
                                        <Timer className="w-4 h-4" />
                                    </div>
                                    <div>
                                        <p className="text-xs text-slate-500 uppercase font-bold tracking-wider">Duration</p>
                                        <p className="text-sm font-semibold text-slate-900">{calculateElapsedTime(attendance.timeIn)}</p>
                                    </div>
                                </div>
                            </div>

                            <div className={`flex justify-between items-center p-3 rounded-xl border shadow-sm ${remainingBreakMinutes < 15 ? 'bg-red-50 border-red-100' : 'bg-white border-slate-100'}`}>
                                <div className="flex items-center gap-3">
                                    <div className={`p-2 rounded-lg ${remainingBreakMinutes < 15 ? 'bg-red-100 text-red-600' : 'bg-amber-50 text-amber-600'}`}>
                                        <Coffee className="w-4 h-4" />
                                    </div>
                                    <div>
                                        <p className="text-xs text-slate-500 uppercase font-bold tracking-wider">Break Used</p>
                                        <p className="text-sm font-semibold text-slate-900">
                                            {formatDuration(realTimeTotalBreak)} <span className="text-slate-400 font-normal">/ {BREAK_LIMIT_MINUTES}m</span>
                                        </p>
                                    </div>
                                </div>
                            </div>

                            {isOnBreak && activeBreak && (
                                <div className="mt-2 p-3 bg-amber-500 text-white rounded-xl text-center animate-pulse">
                                    <p className="text-xs uppercase font-bold tracking-wider opacity-90">Current Break</p>
                                    <p className="text-2xl font-bold">{calculateElapsedTime(activeBreak.breakStart)}</p>
                                </div>
                            )}
                        </>
                    ) : (
                        <div className="py-8 text-center text-slate-400 text-sm">
                            <p>No active session.</p>
                            <p>Clock in to see details.</p>
                        </div>
                    )}
                </CardContent>
            </Card>

            {/* Break History */}
            <Card className="glass-card">
                <CardHeader className="pb-2">
                    <CardTitle className="text-lg text-slate-800 flex items-center gap-2">
                        <History className="w-5 h-5 text-slate-500" />
                        Break History
                    </CardTitle>
                </CardHeader>
                <CardContent>
                    {breaks && breaks.length > 0 ? (
                        <div className="relative border-l border-slate-200 ml-2 space-y-4">
                            {breaks.map((breakItem) => (
                                <div key={breakItem.id} className="ml-4 relative">
                                    <div className="absolute -left-[21px] top-1.5 h-2.5 w-2.5 rounded-full bg-slate-200 border-2 border-white" />
                                    <div className="p-3 bg-white rounded-xl border border-slate-100 shadow-sm">
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <p className="text-sm font-semibold text-slate-800 capitalize">{breakItem.breakType} Break</p>
                                                <p className="text-xs text-slate-500 mt-0.5">
                                                    {formatTimeOnly(new Date(breakItem.breakStart))}
                                                    {breakItem.breakEnd && ` - ${formatTimeOnly(new Date(breakItem.breakEnd))}`}
                                                </p>
                                            </div>
                                            <Badge variant="secondary" className="bg-slate-100 text-slate-600 font-mono">
                                                {breakItem.breakMinutes ? formatDuration(breakItem.breakMinutes) : "Active"}
                                            </Badge>
                                        </div>
                                        {breakItem.notes && (
                                            <p className="text-xs text-slate-400 mt-2 border-t border-slate-50 pt-2">
                                                "{breakItem.notes}"
                                            </p>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div className="text-center py-6 text-slate-400 text-sm bg-slate-50/50 rounded-xl border border-dashed border-slate-200">
                            No breaks taken today
                        </div>
                    )}
                </CardContent>
            </Card>

        </div>
      </div>
    </div>
  );
}


===== user-management.tsx =====
import { useState, useEffect } from "react";
import { useQuery, useMutation } from "@tanstack/react-query";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger, DialogFooter } from "@/components/ui/dialog";
import { Badge } from "@/components/ui/badge";
import {
  UserPlus,
  Users,
  Shield,
  Edit,
  Trash2,
  Key,
  Briefcase,
  AlertTriangle,
  UserCog,
  UserCheck
} from "lucide-react";
import { queryClient } from "@/lib/queryClient";
import { useAuth } from "@/hooks/use-auth";
import { toast } from "sonner";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import { BentoCard } from "@/components/custom/bento-card";

const createUserSchema = z.object({
  username: z.string().min(3, "Username must be at least 3 characters"),
  password: z.string().min(6, "Password must be at least 6 characters"),
  email: z.string().email("Invalid email address"),
  firstName: z.string().min(1, "First name is required"),
  lastName: z.string().min(1, "Last name is required"),
  role: z.enum(["employee", "manager","payroll_officer"]),
  department: z.string().optional(),
  position: z.string().optional(),
  employeeId: z.string().optional(),
  phoneNumber: z.string().optional(),
  managerId: z.string().optional(),
});

const editUserSchema = z.object({
  username: z.string().min(3, "Username must be at least 3 characters"),
  email: z.string().email("Invalid email address"),
  firstName: z.string().min(1, "First name is required"),
  lastName: z.string().min(1, "Last name is required"),
  role: z.enum(["employee", "manager", "admin","payroll_officer"]),
  department: z.string().optional(),
  position: z.string().optional(),
  employeeId: z.string().optional(),
  phoneNumber: z.string().optional(),
  managerId: z.string().optional(),
  
  annualLeaveBalanceLimit: z.string().optional(),
  sickLeaveBalanceLimit: z.string().optional(),
  serviceIncentiveLeaveBalanceLimit: z.string().optional(),
});

const changePasswordSchema = z.object({
  newPassword: z.string().min(6, "Password must be at least 6 characters"),
  confirmPassword: z.string().min(1, "Please confirm password"),
}).refine((data) => data.newPassword === data.confirmPassword, {
  message: "Passwords don't match",
  path: ["confirmPassword"],
});

type CreateUserForm = z.infer<typeof createUserSchema>;
type EditUserForm = z.infer<typeof editUserSchema>;
type ChangePasswordForm = z.infer<typeof changePasswordSchema>;

export default function UserManagement() {
  const { user } = useAuth();
  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);
  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);
  const [isPasswordDialogOpen, setIsPasswordDialogOpen] = useState(false);
  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);
  const [selectedUser, setSelectedUser] = useState<any>(null);
  const [isDemotionAlertOpen, setIsDemotionAlertOpen] = useState(false);

  const createForm = useForm<CreateUserForm>({
    resolver: zodResolver(createUserSchema),
    defaultValues: {
      username: "",
      password: "",
      email: "",
      firstName: "",
      lastName: "",
      role: "employee",
      department: "",
      position: "",
      employeeId: "",
      phoneNumber: "",
      managerId: "",
    },
  });

  const watchedCreateRole = createForm.watch("role");

  const editForm = useForm<EditUserForm>({
    resolver: zodResolver(editUserSchema),
    defaultValues: {
        annualLeaveBalanceLimit: "",
        sickLeaveBalanceLimit: "",
        serviceIncentiveLeaveBalanceLimit: "",
    }
  });

  const passwordForm = useForm<ChangePasswordForm>({
    resolver: zodResolver(changePasswordSchema),
    defaultValues: {
      newPassword: "",
      confirmPassword: "",
    },
  });

  const { data: users = [], isLoading: usersLoading } = useQuery({
    queryKey: ["/api/users"],
    enabled: user?.role === "admin" || user?.role === "manager",
  });

  const managers = users.filter((u: any) => u.role === "manager" );

  const generateNextEmployeeId = (role: string) => {
    let prefix = "EMP";
    if (role === "manager") prefix = "MAN";
    if (role === "admin") prefix = "ADM";
    if (role === "payroll_officer") prefix = "PAY";

    const existingIds = users
      .map((u: any) => u.employeeId)
      .filter((id: string) => id && id.startsWith(prefix));

    let maxNum = 0;
    existingIds.forEach((id: string) => {
      const parts = id.split("-");
      if (parts.length === 2) {
        const num = parseInt(parts[1], 10);
        if (!isNaN(num) && num > maxNum) {
          maxNum = num;
        }
      }
    });

    const nextNum = (maxNum + 1).toString().padStart(3, "0");
    return `${prefix}-${nextNum}`;
  };

  useEffect(() => {
    if (isCreateDialogOpen && users.length > 0) {
      const nextId = generateNextEmployeeId(watchedCreateRole);
      createForm.setValue("employeeId", nextId);
    }
  }, [watchedCreateRole, isCreateDialogOpen, users, createForm.setValue]);

  const createUserMutation = useMutation({
    mutationFn: async (data: CreateUserForm) => {
      const response = await fetch("/api/users", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({
            ...data,
            department: data.department || null,
            position: data.position || null,
            employeeId: data.employeeId || null,
            phoneNumber: data.phoneNumber || null,
            managerId: data.managerId || null,
        }),
      });

      if (!response.ok) {
        const error = await response.text();
        throw new Error(error || "Failed to create user");
      }

      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/users"] });
      setIsCreateDialogOpen(false);
      createForm.reset();
      toast.success("Success", { description: "User created successfully" });
    },
    onError: (error: Error) => {
      toast.error("Error", { description: error.message });
      
    },
  });

  const editUserMutation = useMutation({
    mutationFn: async ({ id, data }: { id: string; data: EditUserForm }) => {
        const parseOptionalInt = (value: string | undefined): number | null => {
            if (value === undefined || value.trim() === "") return null;
            const parsed = parseInt(value, 10);
            return isNaN(parsed) ? null : parsed;
        };

        const cleanedData = {
            ...data,
            department: data.department || null,
            position: data.position || null,
            employeeId: data.employeeId || null,
            phoneNumber: data.phoneNumber || null,
            managerId: (data.role !== 'employee' || !data.managerId) ? null : data.managerId,
            annualLeaveBalanceLimit: parseOptionalInt(data.annualLeaveBalanceLimit),
            sickLeaveBalanceLimit: parseOptionalInt(data.sickLeaveBalanceLimit),
            serviceIncentiveLeaveBalanceLimit: parseOptionalInt(data.serviceIncentiveLeaveBalanceLimit),
        };
        
      const response = await fetch(`/api/users/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(cleanedData),
      });

      if (!response.ok) {
        const error = await response.text();
        throw new Error(error || "Failed to update user");
      }

      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/users"] });
      setIsEditDialogOpen(false);
      toast.success("Success", { description: "User updated successfully" });
    },
    onError: (error: Error) => {
      toast.error("Error", { description: error.message });
    },
  });

  const changePasswordMutation = useMutation({
    mutationFn: async ({ id, password }: { id: string; password: string }) => {
      const response = await fetch(`/api/users/${id}/password`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ password }),
      });

      if (!response.ok) {
        const error = await response.text();
        throw new Error(error || "Failed to change password");
      }

      return response.json();
    },
    onSuccess: () => {
      setIsPasswordDialogOpen(false);
      passwordForm.reset();
      toast.success("Success", { description: "Password changed successfully" });
    },
    onError: (error: Error) => {
      toast.error("Error", { description: error.message });
    },
  });

  const deleteUserMutation = useMutation({
    mutationFn: async (id: string) => {
      const response = await fetch(`/api/users/${id}`, {
        method: "DELETE",
        credentials: "include",
      });

      if (!response.ok) {
        const error = await response.text();
        throw new Error(error || "Failed to delete user");
      }

      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/users"] });
      setIsDeleteDialogOpen(false);
      toast.success("Success", { description: "User deleted successfully" });
    },
    onError: (error: Error) => {
      toast.error("Error", { description: error.message });
    },
  });

  const onCreateSubmit = (data: CreateUserForm) => {
    createUserMutation.mutate(data);
  };

  const onEditSubmit = (data: EditUserForm) => {
    if (!selectedUser) return;
    
    const isDemotingManager = selectedUser.role === 'manager' && data.role !== 'manager';
    const hasDirectReports = users.some((u: any) => u.managerId === selectedUser.id);

    if (isDemotingManager && hasDirectReports) {
        setIsDemotionAlertOpen(true);
        return;
    }
    
    editUserMutation.mutate({ id: selectedUser.id, data });
  };
    
  const handleConfirmedDemotion = () => {
      if (selectedUser) {
        const data = editForm.getValues();
        editUserMutation.mutate({ id: selectedUser.id, data });
      }
      setIsDemotionAlertOpen(false);
  };

  const onPasswordSubmit = (data: ChangePasswordForm) => {
    if (selectedUser) {
      changePasswordMutation.mutate({
        id: selectedUser.id,
        password: data.newPassword
      });
    }
  };

  const handleEdit = (userData: any) => {
    setSelectedUser(userData);
    editForm.reset({
      username: userData.username,
      email: userData.email,
      firstName: userData.firstName,
      lastName: userData.lastName,
      role: userData.role,
      department: userData.department || "",
      position: userData.position || "",
      employeeId: userData.employeeId || "",
      phoneNumber: userData.phoneNumber || "",
      managerId: userData.managerId || "",
      annualLeaveBalanceLimit: userData.annualLeaveBalanceLimit?.toString() || "",
      sickLeaveBalanceLimit: userData.sickLeaveBalanceLimit?.toString() || "",
      serviceIncentiveLeaveBalanceLimit: userData.serviceIncentiveLeaveBalanceLimit?.toString() || "",
    });
    setIsEditDialogOpen(true);
  };

  const handleChangePassword = (userData: any) => {
    setSelectedUser(userData);
    passwordForm.reset();
    setIsPasswordDialogOpen(true);
  };

  const handleDelete = (userData: any) => {
    setSelectedUser(userData);
    setIsDeleteDialogOpen(true);
  };

  const confirmDelete = () => {
    if (selectedUser) {
      deleteUserMutation.mutate(selectedUser.id);
    }
  };

  const getAvailableRoles = () => {
    if (user?.role === "admin") {
      return [
        { value: "admin", label: "Admin" },
        { value: "manager", label: "Manager" },
        { value: "payroll_officer", label: "Payroll Officer" }, 
        { value: "employee", label: "Employee" },
      ];
    } else if (user?.role === "manager") {
      return [
        { value: "employee", label: "Employee" },
      ];
    }
    return [];
  };

  const getRoleBadge = (role: string) => {
    const colors: Record<string, string> = {
      admin: "bg-rose-100 text-rose-700 border-rose-200",
      manager: "bg-purple-100 text-purple-700 border-purple-200",
      payroll_officer: "bg-blue-100 text-blue-700 border-blue-200",
      employee: "bg-emerald-100 text-emerald-700 border-emerald-200",
    };
    return <Badge variant="outline" className={`capitalize ${colors[role] || "bg-gray-100"} border px-2.5 py-0.5`}>{role.replace(/_/g, " ")}</Badge>;
  };
  
  const canModifyUser = (targetUser: any) => {
    if (user?.role === "admin") return true;
    if (user?.role === "manager") {
      if (user.id === targetUser.id) return true;
      if (targetUser.role === 'employee' && targetUser.managerId === user.id) return true;
    }
    return false;
  };

  // Calculate stats for Bento
  const stats = {
      total: users.length,
      admins: users.filter((u: any) => u.role === 'admin').length,
      managers: users.filter((u: any) => u.role === 'manager').length,
      employees: users.filter((u: any) => u.role === 'employee').length,
  };

  if (user?.role !== "admin" && user?.role !== "manager") {
    return (
      <div className="p-8 flex justify-center items-center h-screen">
        <Card className="w-full max-w-md bg-white/60 backdrop-blur-xl border-slate-200/60 shadow-lg rounded-3xl">
          <CardContent className="py-12 text-center space-y-4">
            <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto text-slate-400">
                <Shield className="w-8 h-8" />
            </div>
            <p className="text-slate-500">You don't have permission to access user management.</p>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="p-6 md:p-8 max-w-7xl mx-auto space-y-8">
      {/* Header */}
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h1 className="text-3xl font-bold tracking-tight text-slate-900">User Management</h1>
          <p className="text-slate-500 mt-1 text-sm">Create and manage user accounts and permissions</p>
        </div>
        <Dialog open={isCreateDialogOpen} onOpenChange={(open) => {
          setIsCreateDialogOpen(open);
          if (!open) createForm.reset();
        }}>
          <DialogTrigger asChild>
            <Button className="bg-slate-900 hover:bg-slate-800 text-white shadow-lg shadow-slate-900/20 rounded-full px-6">
              <UserPlus className="w-4 h-4 mr-2" /> Create User
            </Button>
          </DialogTrigger>
          <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto rounded-2xl">
            <DialogHeader>
              <DialogTitle>Create New User</DialogTitle>
              <DialogDescription>Add a new user to the system</DialogDescription>
            </DialogHeader>
            <form onSubmit={createForm.handleSubmit(onCreateSubmit)} className="space-y-4 mt-2">
              {/* ... Create Form Content (Standardized Inputs) ... */}
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <Label>First Name *</Label>
                  <Input {...createForm.register("firstName")} className="rounded-xl" />
                  {createForm.formState.errors.firstName && <p className="text-xs text-red-500 mt-1">{createForm.formState.errors.firstName.message}</p>}
                </div>
                <div>
                  <Label>Last Name *</Label>
                  <Input {...createForm.register("lastName")} className="rounded-xl" />
                  {createForm.formState.errors.lastName && <p className="text-xs text-red-500 mt-1">{createForm.formState.errors.lastName.message}</p>}
                </div>
              </div>
              <div>
                <Label>Email *</Label>
                <Input type="email" {...createForm.register("email")} className="rounded-xl" />
                {createForm.formState.errors.email && <p className="text-xs text-red-500 mt-1">{createForm.formState.errors.email.message}</p>}
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <Label>Username *</Label>
                  <Input {...createForm.register("username")} className="rounded-xl" />
                  {createForm.formState.errors.username && <p className="text-xs text-red-500 mt-1">{createForm.formState.errors.username.message}</p>}
                </div>
                <div>
                  <Label>Password *</Label>
                  <Input type="password" {...createForm.register("password")} className="rounded-xl" />
                  {createForm.formState.errors.password && <p className="text-xs text-red-500 mt-1">{createForm.formState.errors.password.message}</p>}
                </div>
              </div>
              <div>
                <Label>Role *</Label>
                <Select onValueChange={(value) => createForm.setValue("role", value as any)} defaultValue="employee">
                  <SelectTrigger className="rounded-xl"><SelectValue /></SelectTrigger>
                  <SelectContent className="rounded-xl">
                    {getAvailableRoles().map((role) => (
                      <SelectItem key={role.value} value={role.value}>{role.label}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <Label>Department</Label>
                  <Input {...createForm.register("department")} className="rounded-xl" />
                </div>
                <div>
                  <Label>Position</Label>
                  <Input {...createForm.register("position")} className="rounded-xl" />
                </div>
              </div>
              <div className="grid grid-cols-2 gap-4">
                 <div>
                    <Label>Employee ID</Label>
                    <Input {...createForm.register("employeeId")} className="rounded-xl" />
                 </div>
                 <div>
                    <Label>Phone Number</Label>
                    <Input {...createForm.register("phoneNumber")} className="rounded-xl" />
                 </div>
              </div>
              {createForm.watch("role") === "employee" && (
                <div>
                  <Label>Manager (Optional)</Label>
                  <Select value={createForm.watch("managerId") || ""} onValueChange={(value) => createForm.setValue("managerId", value)}>
                    <SelectTrigger className="rounded-xl"><SelectValue placeholder="Select manager" /></SelectTrigger>
                    <SelectContent className="rounded-xl">
                      {managers.length > 0 ? managers.map((m: any) => <SelectItem key={m.id} value={m.id}>{m.firstName} {m.lastName}</SelectItem>) : <SelectItem value="none" disabled>No managers available</SelectItem>}
                    </SelectContent>
                  </Select>
                </div>
              )}
              <DialogFooter>
                <Button type="button" variant="outline" onClick={() => setIsCreateDialogOpen(false)} className="rounded-full">Cancel</Button>
                <Button type="submit" disabled={createUserMutation.isPending} className="rounded-full bg-slate-900">{createUserMutation.isPending ? "Creating..." : "Create User"}</Button>
              </DialogFooter>
            </form>
          </DialogContent>
        </Dialog>
      </div>

      {/* Bento Stats */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <BentoCard title="Total Users" value={stats.total} icon={Users} variant="default" testIdPrefix="stat-total" />
        <BentoCard title="Employees" value={stats.employees} icon={UserCheck} variant="emerald" testIdPrefix="stat-employees" />
        <BentoCard title="Managers" value={stats.managers} icon={Briefcase} variant="rose" testIdPrefix="stat-managers" />
        <BentoCard title="Admins" value={stats.admins} icon={Shield} variant="amber" testIdPrefix="stat-admins" />
      </div>

      {/* Glass User Grid */}
      {usersLoading ? (
        <div className="text-center py-12 text-slate-400">Loading users...</div>
      ) : users.length === 0 ? (
        <div className="text-center py-20 bg-white/40 border border-dashed border-slate-200 rounded-3xl">
           <Users className="w-10 h-10 text-slate-300 mx-auto mb-3" />
           <p className="text-slate-500">No users found.</p>
        </div>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {users.map((u: any) => (
            <Card key={u.id} className="bg-white/60 backdrop-blur-xl border-slate-200/60 shadow-sm hover:shadow-md transition-all rounded-2xl overflow-hidden group">
              <CardContent className="p-6">
                <div className="flex items-start justify-between mb-4">
                  <div className="flex items-center gap-4">
                     <div className="h-12 w-12 bg-slate-100 rounded-full flex items-center justify-center text-lg font-bold text-slate-600 border border-slate-200">
                        {u.firstName.charAt(0)}{u.lastName.charAt(0)}
                     </div>
                     <div>
                        <h3 className="font-bold text-slate-900">{u.firstName} {u.lastName}</h3>
                        <p className="text-xs text-slate-500">{u.email}</p>
                     </div>
                  </div>
                  {getRoleBadge(u.role)}
                </div>
                
                <div className="space-y-2 mb-6">
                   <div className="flex justify-between text-sm">
                      <span className="text-slate-500">Position:</span>
                      <span className="font-medium text-slate-700">{u.position || "â"}</span>
                   </div>
                   <div className="flex justify-between text-sm">
                      <span className="text-slate-500">ID:</span>
                      <span className="font-mono text-xs text-slate-600 bg-slate-100 px-2 py-0.5 rounded">{u.employeeId || "â"}</span>
                   </div>
                   <div className="flex justify-between text-sm">
                      <span className="text-slate-500">Department:</span>
                      <span className="font-medium text-slate-700">{u.department || "â"}</span>
                   </div>
                </div>

                {(user?.role === "admin" || canModifyUser(u)) && (
                  <div className="flex items-center gap-2 pt-4 border-t border-slate-100/50 opacity-60 group-hover:opacity-100 transition-opacity">
                     <Button size="sm" variant="ghost" className="flex-1 h-8 bg-white border border-slate-200 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-100 rounded-lg text-xs" onClick={() => handleEdit(u)}>
                        <Edit className="w-3.5 h-3.5 mr-1.5" /> Edit
                     </Button>
                     <Button size="sm" variant="ghost" className="h-8 w-8 p-0 bg-white border border-slate-200 hover:bg-amber-50 hover:text-amber-600 hover:border-amber-100 rounded-lg" onClick={() => handleChangePassword(u)} title="Change Password">
                        <Key className="w-3.5 h-3.5" />
                     </Button>
                     <Button size="sm" variant="ghost" className="h-8 w-8 p-0 bg-white border border-slate-200 hover:bg-rose-50 hover:text-rose-600 hover:border-rose-100 rounded-lg" onClick={() => handleDelete(u)} disabled={u.id === user.id} title="Delete">
                        <Trash2 className="w-3.5 h-3.5" />
                     </Button>
                  </div>
                )}
              </CardContent>
            </Card>
          ))}
        </div>
      )}

      {/* Edit User Dialog */}
      <Dialog open={isEditDialogOpen} onOpenChange={(open) => { setIsEditDialogOpen(open); if (!open) { editForm.reset(); setSelectedUser(null); } }}>
        <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto rounded-2xl">
          <DialogHeader>
            <DialogTitle>Edit User</DialogTitle>
          </DialogHeader>
          <form onSubmit={editForm.handleSubmit(onEditSubmit)} className="space-y-4 mt-2">
             {/* Same structure as create form but populated */}
             <div className="grid grid-cols-2 gap-4">
                <div><Label>First Name</Label><Input {...editForm.register("firstName")} className="rounded-xl" /></div>
                <div><Label>Last Name</Label><Input {...editForm.register("lastName")} className="rounded-xl" /></div>
             </div>
             <div><Label>Email</Label><Input {...editForm.register("email")} className="rounded-xl" /></div>
             <div><Label>Username</Label><Input {...editForm.register("username")} className="rounded-xl" /></div>
             <div>
                <Label>Role</Label>
                <Select value={editForm.watch("role")} onValueChange={(val) => editForm.setValue("role", val as any)}>
                   <SelectTrigger className="rounded-xl"><SelectValue /></SelectTrigger>
                   <SelectContent className="rounded-xl">
                      {getAvailableRoles().map((role) => <SelectItem key={role.value} value={role.value}>{role.label}</SelectItem>)}
                   </SelectContent>
                </Select>
             </div>
             <div className="grid grid-cols-2 gap-4">
                <div><Label>Department</Label><Input {...editForm.register("department")} className="rounded-xl" /></div>
                <div><Label>Position</Label><Input {...editForm.register("position")} className="rounded-xl" /></div>
             </div>
             <div className="grid grid-cols-2 gap-4">
                <div><Label>Employee ID</Label><Input {...editForm.register("employeeId")} className="rounded-xl" /></div>
                <div><Label>Phone</Label><Input {...editForm.register("phoneNumber")} className="rounded-xl" /></div>
             </div>

             <div className="space-y-3 pt-2 border-t border-slate-100">
                <h4 className="text-sm font-semibold text-slate-900">Leave Limits (Annual)</h4>
                <div className="grid grid-cols-2 gap-4">
                   <div><Label className="text-xs text-slate-500">Service Incentive Limit</Label><Input type="number" {...editForm.register("annualLeaveBalanceLimit")} className="rounded-xl" /></div>
                   <div><Label className="text-xs text-slate-500">Additional Benefit Limit</Label><Input type="number" {...editForm.register("sickLeaveBalanceLimit")} className="rounded-xl" /></div>
                </div>
             </div>

             {editForm.watch("role") === "employee" && (
                <div>
                   <Label>Manager</Label>
                   <Select value={editForm.watch("managerId") || ""} onValueChange={(val) => editForm.setValue("managerId", val)}>
                      <SelectTrigger className="rounded-xl"><SelectValue placeholder="Select Manager" /></SelectTrigger>
                      <SelectContent className="rounded-xl">
                         {managers.map((m: any) => <SelectItem key={m.id} value={m.id}>{m.firstName} {m.lastName}</SelectItem>)}
                      </SelectContent>
                   </Select>
                </div>
             )}

             <DialogFooter>
                <Button type="button" variant="outline" onClick={() => setIsEditDialogOpen(false)} className="rounded-full">Cancel</Button>
                <Button type="submit" disabled={editUserMutation.isPending} className="rounded-full bg-slate-900">Save Changes</Button>
             </DialogFooter>
          </form>
        </DialogContent>
      </Dialog>

      {/* Change Password Dialog */}
      <Dialog open={isPasswordDialogOpen} onOpenChange={(open) => { setIsPasswordDialogOpen(open); if (!open) passwordForm.reset(); }}>
        <DialogContent className="rounded-2xl">
          <DialogHeader><DialogTitle>Change Password</DialogTitle></DialogHeader>
          <form onSubmit={passwordForm.handleSubmit(onPasswordSubmit)} className="space-y-4">
             <div><Label>New Password</Label><Input type="password" {...passwordForm.register("newPassword")} className="rounded-xl" /></div>
             <div><Label>Confirm Password</Label><Input type="password" {...passwordForm.register("confirmPassword")} className="rounded-xl" /></div>
             <DialogFooter>
                <Button type="button" variant="outline" onClick={() => setIsPasswordDialogOpen(false)} className="rounded-full">Cancel</Button>
                <Button type="submit" disabled={changePasswordMutation.isPending} className="rounded-full bg-slate-900">Update Password</Button>
             </DialogFooter>
          </form>
        </DialogContent>
      </Dialog>

      {/* Delete Confirmation Dialog */}
      <AlertDialog open={isDeleteDialogOpen} onOpenChange={(open) => { setIsDeleteDialogOpen(open); if (!open) setSelectedUser(null); }}>
        <AlertDialogContent className="rounded-2xl">
          <AlertDialogHeader>
            <AlertDialogTitle className="flex items-center gap-2 text-rose-600"><AlertTriangle className="w-5 h-5" /> Delete User</AlertDialogTitle>
            <AlertDialogDescription>Are you sure you want to delete <strong>{selectedUser?.firstName} {selectedUser?.lastName}</strong>? This action cannot be undone.</AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel className="rounded-full">Cancel</AlertDialogCancel>
            <AlertDialogAction onClick={confirmDelete} className="rounded-full bg-rose-600 hover:bg-rose-700">Delete</AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
      
      {/* Manager Demotion Alert Dialog */}
      <AlertDialog open={isDemotionAlertOpen} onOpenChange={setIsDemotionAlertOpen}>
        <AlertDialogContent className="rounded-2xl">
          <AlertDialogHeader>
            <AlertDialogTitle className="flex items-center gap-2 text-amber-600"><AlertTriangle className="w-5 h-5" /> Demotion Conflict</AlertDialogTitle>
            <AlertDialogDescription>This user is a manager for other employees. Please reassign their direct reports before demoting them.</AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel className="rounded-full">Close</AlertDialogCancel>
            <AlertDialogAction onClick={handleConfirmedDemotion} className="rounded-full bg-amber-600 hover:bg-amber-700">Proceed Anyway</AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
}


